# 六杠三、使用 PID 控制器的赛车控制系统



作者：Nic Melder 和 Simon Tomlinson

## 40.1 引言



控制系统被定义为机械、物理或数字机械的整体，包括其运行的环境（被控对象）和用于管理它的设备（控制器）。在现实世界的控制系统中，每当我们试图达到一个期望值（例如通过墙上的恒温器设置温度或使用车辆的巡航控制设置速度）时，就会使用控制器来修改外部定义的目标输入以获得期望的输出。被控对象的特性可以被考虑并设计到控制器中，这样达到期望目标所需的时间也可以被优化。还可以分析和控制被控对象在期望目标值的不同变化率下的响应。



为了设计控制器，控制工程师通常会分析被控对象，并将其表示为一系列线性微分方程，使用复杂的数学技术来获得在所有可想象的稳态和瞬态条件下所需的响应。幸运的是，在计算机模拟或游戏中，设计不佳的控制器的影响不像在化工厂等场景中那样具有灾难性，因此可以使用更简单且易于操作的比例 - 积分 - 微分（PID）控制器，而不是完全指定的控制器。这个 PID 控制器在大多数我们试图控制单个输入目标和输出值系统且不需要绝对精度的情况下 “足够好”。对于感兴趣的读者，有更完整的控制理论和被控对象分析介绍 [Ogata 09]，以及关于定制控制器设计的高级指导 [Warwick 96]。

## 40.2 基本控制理论



我们试图控制的任何系统都包含两个部分，被控对象和控制器。被控对象是被控制的东西，但不一定是物理机器。在家庭供暖系统中，被控对象是锅炉、散热器和室内环境，控制器是恒温器。在赛车游戏中，被控对象通常是数字模拟的车辆和赛道。



有两种控制策略：开环控制和闭环控制，如图 40.1 所示。它们之间的关键区别在于闭环控制将被控对象的输出测量值反馈到控制器的输入。这种类型的系统也被称为反馈系统。开环控制器不将实际输出作为参考进行测量，因此无法针对环境的影响进行调整。例如，考虑一辆以 20% 的油门在平坦路面上行驶的汽车。车辆会缓慢加速，直到达到最大速度。现在，如果汽车在恒定的上坡或下坡行驶，速度会降低或增加到一个新的速度。同样，如果不同的汽车进行相同的测试，它将达到不同的最大速度。也就是说，开环系统无法补偿系统的任何外部变化或干扰。



相比之下，闭环回路将输出值（Y）反馈到输入，在那里它从所需的目标值（R）中减去。这个误差值（e）然后由控制器作用。在上述恒定速度的场景中，闭环控制器将允许车辆即使在环境或被控对象（斜坡或不同的汽车）发生变化时也能保持恒定的所需速度，因为测量的速度误差会改变，控制器可以通过调整油门做出反应。此外，使用闭环控制器，汽车将更快地加速到所需速度，方法是以 100% 的油门启动，然后在接近所需速度时减少油门输入，即误差减小。



从这个例子来看，开环控制系统似乎没有实际用途。然而，如果输入和输出值之间存在直接关系，那么开环控制就足够了。车辆的转向（转动车轮）可以使用开环控制，因为车辆转向系统的机制是明确的，方向盘上的应用角度会导致车轮上的特定角度。



虽然闭环控制比开环控制有许多优点，但由于设计不佳的控制器，它可能会产生不良影响。这些包括超调，即实际值超过目标值；振荡或振铃，即实际值在目标值周围振荡；以及正反馈，即误差的增加实际上会增加被控对象的输入，导致反馈回路周围的持续失控积累。图 40.2 显示了被控对象对输入目标的阶跃响应以及可能出现的不同类型的响应。



闭环控制器对所需目标值 R 的阶跃变化有四个主要特性：



1. 上升时间：被控对象输出上升到 R 的 90% 所需的时间。
2. 超调量：如果有的话，被控对象输出超过 R 的峰值。
3. 稳定时间：系统稳定到稳态所需的时间。
4. 稳态误差：系统稳定到恒定状态后 R 和输出 Y 之间的差异。



即使对于简单的 PID 控制器，在设计解决方案时也必须考虑这些影响。

## 40.3 PID 控制器介绍



闭环 PID 控制器由三部分组成。第一项（）与所需目标值（）和被控对象输出（）之间的误差（）成比例。第二项（）与误差的积分成比例，最后一项（）与误差的导数成比例。输出是这三个分量的总和：



计算误差、积分误差和误差的微分很简单；是对 、 和 的增益选择赋予了控制器其特性。需要注意的是，误差可以是正的或负的，即测量的速度可能高于或低于所需速度。同样，、 和 也可以是负的。增加不同参数对四个主要系统特性的影响总结在表 40.1 中。

### 40.3.1 比例控制



比例控制只是将误差乘以一个恒定增益（）。如果 太大，这可能会导致系统由于对被控对象施加过多输入而开始振荡。这会导致输出超调，然后可能需要在相反方向进行大的校正。也可能发生正反馈，其中平均误差不断增加，导致系统不稳定且无法控制。



对于一辆在圆形赛道上行驶的车辆（误差是车辆中心到道路中心的距离），如果 太大，一个小的误差会导致车辆转向过度，然后过度校正，最终以越来越大的幅度在赛道线上失控摆动。当 较小时，车辆会缓慢地朝正确方向转向以减少误差。然而，误差越小，车辆的处理输入就越小。在这个例子中，Y 永远不会达到 R，所以误差永远不会最小化为 0。可以看出，由于转向校正变得微不足道，我们的车辆永远不会到达赛车线。由于转向校正不足，汽车会在离赛车线固定距离处稳定下来。这就是所谓的稳态误差。

### 40.3.2 积分控制



为了抵消比例项引起的稳态误差，可以在控制器中添加一个积分组件。这会对误差进行时间积分，然后将其加回到输入中。因此，当稳态误差持续存在时，积分项会累积，进一步推动输入朝那个方向，从而减少稳态误差。



使用积分组件的一个影响是输出可能会引入振荡。一旦稳态误差减小到零，积分误差仍然是非零的，并对控制器输出有贡献。正是这个残余误差（或 “记忆”）导致了超调。此外，当积分项和比例项试图校正超调时，可能会在目标值周围产生振荡。然而，与正反馈不稳定不同，这种振荡会随着时间逐渐减弱。

### 40.3.3 导数控制



导数控制根据误差的变化率生成被控对象的输入。因此，它可以用于减弱或放大比例项的效果。如果误差变化缓慢，导数组件的影响很小，但如果误差突然增加，正的导数输出也会增加，给系统一个 “启动”。这种效果可以用来减少控制器响应的上升时间。相反，如果 是负的，导数组件可以用来抑制输入的突然变化，即它减弱突然变化，使系统能够专注于 R 的长期变化。

## 40.4 PID 控制器的实现



在实现 PID 控制器时，必须考虑许多其他因素。本节讨论一些更精细的设计要点。



限制和重置积分误差。由于积分误差会随时间累积，如果系统有一个恒定的误差（例如等待起跑灯改变），积分误差会不断增加。为了解决这个问题，希望能够根据外部事件（如灯光改变）重置积分误差。同样，限制积分误差可能也是可取的，以限制误差记忆的影响。



误差的最大历史（时间常数）。在现实世界的系统中，积分和微分项不仅由一个恒定的乘数（增益）控制，还由所谓的时间常数控制。对于积分项，这影响积分所基于的过去时间长度。这实际上限制了积分中存储的 “历史” 量，否则它将包含从控制器初始化以来的信息。最好通过计算滚动平均的积分误差来实现这一点，即每帧当前积分减少（1 - T%），并将当前误差的 T% 加回来。这也有归一化积分误差的效果。



时间常数的选择影响历史的长度。较小的值会回顾大量的帧，而较大的值只会回顾几帧。较长的历史使被控对象的输出更平滑，而较短的历史使被控对象的输出对 R 的变化更敏感。然而，使用较长的时间常数是有代价的；在阶跃变化后，积分误差需要更长的时间来累积，导致控制器响应之前有更大的延迟。



同样，导数误差可以在不同的时间常数下采样；当前帧和上一帧、当前帧和倒数第二帧等等。使用较长的时间常数会使导数项不那么尖锐。如果想在导数中使用连续可变的时间常数，只需使用插值估计帧间误差值。优化时间常数是塑造控制器特性的有用辅助工具。



过滤输入数据。如果输入数据（）有噪声，微分项可能会以不理想的方式波动。用低通滤波器（即过去几帧的滚动平均）平滑误差数据可以帮助消除这种情况。然而，这实际上是添加了另一个积分器。如果在输入阶段或反馈回路中放置一个低通滤波器，这可能会导致对 R 变化的响应进一步延迟。或者，可以在每个单独的 PID 项的输入处添加一个单独的低通滤波器，以便可以调整滤波以适应每个组件。



改变 K 系数。在不同的情况下，不同的 K 值可能效果更好。例如，在低速时，车辆可能需要更大的 K 值才能开始移动，而在高速行驶时则不需要。在这种情况下，将 K 值作为速度的函数进行线性变化是有用的。不过要小心，因为如果耦合太大，可能会建立一个隐藏的正反馈回路，导致不稳定。同样，车辆在柏油路面上行驶时使用的值在泥土路面上行驶时可能不合适。对于这种情况，我们希望使用基于状态的系统，其中 K 值由车辆所在的表面决定。



记录用于调整和调试的指标。在调整 K 值时，希望使用一个固定的、易于重复的场景，并每帧记录指标，以查看参数变化产生的效果。对于转向控制器，这将涉及记录车辆相对于赛车线的垂直位置。此外，可能会出现控制器行为不符合预期的情况，能够记录和可视化控制器内部状态可以极大地帮助调试不稳定情况。



确定成功。在调整控制器时，能够定义一个好的控制器是什么很重要。这个 “成功” 值可以是达到目标速度的时间、绕赛道一圈所需的时间、在赛道上行驶的最小距离或控制的平滑度，这取决于游戏要求。正确识别正确的指标很重要，一旦找到这样的指标，它就可以作为自动学习的基础。



使用误差偏移。不是试图最小化误差，通过设置一个非零的目标误差，可以给被控制系统带来一些变化。例如，转向控制器通常会试图最小化车辆到赛车线的距离，但通过使用误差偏移，这会导致车辆在赛车线的左侧或右侧行驶一小段距离。同样，如果不同的车辆在设置期望速度时使用不同的误差偏移，最终速度会有一些变化，这在交通模拟中可能是合适的。这样的效果也可以通过直接偏移目标值（）来实现，但在某些情况下，在控制器误差域内操作更容易。

## 40.5 PID 控制器的设计和调整



在设计 PID 控制器时，重要的是要正确地将战术 AI 层的参数与输入目标值 R 相关联，将车辆物理模拟中的参数与输出相关联，并且还要认识到闭环误差值的重要性。



如果使用一个用于管理速度的控制器，输入是我们期望的速度，输出是一个输入到踏板系统的值，误差是速度差。在这种情况下，缩放后的控制器输出可能从 - 1.0（需要减速）到 + 1.0（需要加速）变化。这个值需要进一步分配到实际的刹车和油门踏板输入中。



当用于转向控制器时，输入可能是车辆的所需位置，缩放后的输出输入到车辆的方向盘，误差是车辆到赛车线的垂直距离。



理解输入、输出和误差可以定义控制器的特定特性。例如，对于正常驾驶，转向应该相当灵敏但平稳。此外，我们当然应该避免过度转向和曲折行驶，所以我们应该追求无超调的特性。速度控制也可以很平滑，但在避免碰撞的情况下，我们可能会切换到一组为快速响应而调整的 PID 值，并接受一些振荡。



调整 PID 控制器通常是通过试错法完成的，但也可以通过分析计算出增益值应该是多少。然而，这需要对系统的机制有很好的了解，超出了本文的范围。重要的是一次只改变一个参数，这样在训练场景中对指标图的影响就不会被掩盖。



一旦确定了所需的特性，建议按照以下顺序调整控制器：



1. 将所有增益（）设置为 0，并增加 ，直到系统以理想的方式运行，没有超调或振荡。首先调整这个值是明智的，因为它通常对输出有最大的影响。
2. 增加 以消除稳态误差。
3. 根据需要调整 以减少任何超调或减少稳定时间。



在实践中，经常发现 和 大约是 的一半。一般来说，如果系统无法达到其期望的值，增加 。如果它振荡，减少 和 。如果它变化太慢，则增加 。记住，被控对象的特性也起作用，所以如果被控对象有很大的时间延迟，控制器可能需要更努力地工作来补偿。

## 40.6 自适应控制



在一个不断变化的系统中（例如车辆在燃烧燃料时重量发生变化或在不同的路面类型上行驶时），为我们的 PID 控制器选择的初始 K 值可能不再合适，控制器必须适应。状态切换或控制器参数的简单线性变化已经概述过，但也有更复杂的方法可用。



一种自适应控制方法是使用增益调度。这是通过一个简单的线性关系或更复杂的多项式方程，由外部因素（如车辆的速度或路面抓地力）直接调整控制器参数。当系统主要依赖于一个值时，增益调度可以很好地工作，但当值依赖于多个因素时，可能会特别难以调整。



模型参考自适应控制（MRAC）是一种自适应控制形式，其中系统特性的模型是预先确定的（例如，给定一个 20 的误差，我们希望以每秒 5 的速度减少误差）。在系统运行时，将测量的响应与参考模型响应进行比较，差异用于调整控制器参数。虽然 MRAC 是一种更复杂的自适应控制形式，但它比其他更简单的方法更容易理解和调整。关于所描述的自适应控制方案如何工作和实现的更多信息可以在其他地方找到 [Forrester 06]。

## 40.7 预测控制



预测控制展望未来，试图提前响应 R 的变化，从而补偿被控对象中的时间延迟。在工业控制器中使用的一种著名技术是模型预测控制 [Alba 02]，但这种类型的系统在游戏中可能过于复杂。



在实践中，我们可以使用一种更简单的预测控制形式，通过利用问题的知识，根据我们预期会发生的事情生成输入。以转向系统为例，我们可以将输入从垂直线位置更改为使用引导车辆的引导物对象 [Tomlinson 和 Melder 13]。在这种情况下，输入现在是车辆前进方向与车辆和引导物之间的线的角度，控制器误差是角度差。这是预测性的，因为引导物会在车辆需要之前开始转弯。需要注意的是，引导物的领先距离是 “被控对象” 的一部分，在调整时需要考虑。同样，速度控制器可以通过查看赛道来使用预测速度。

## 40.8 赛车中的其他控制器应用



PID 控制器除了目前讨论的速度和转向管理之外，还有许多其他应用领域。以下是一些进一步的应用。



转向控制器的类型。当驾驶模拟是高抓地力、需要平稳驾驶（例如一级方程式或印地赛车）且车辆响应迅速时，控制器将被调整为平稳（ 通常较低， 较小甚至为负）。相比之下，对于在低抓地力表面上的越野赛车，预计会有滑动和漂移，K 值要大得多。这是为了补偿由于较低的抓地力表面导致的输入和对车辆的影响之间的延迟。



速度控制器 - 分离通道。实际上有两种速度控制方法：仅使用油门和精确跟踪。使用仅油门技术，如果车辆速度过快，则使用发动机制动和轮胎摩擦来减速。精确跟踪也使用刹车来减速。现实世界中的赛车手会使用发动机制动来处理小的速度降低，仅在较大的速度降低时使用刹车。此外，由于制动力通常分配到所有轮胎，而加速度仅通过一个车轴，因此 PID 用于加速和制动的特性可能不同。因此，为了实现更逼真的速度控制，应该实现两个 PID 控制器的子通道：一个加速通道，仅对正误差做出响应，其输出是油门；一个制动通道，仅对负误差做出响应。可能还需要一个死区，以便对于小的负误差，油门和刹车都关闭，仅使用发动机制动。



在某点停车。这可以通过使用等于到该点的距离减去车辆滚动距离的误差来实现。为了在某点停车，需要知道车辆在一系列速度下的制动和滚动距离。滚动距离是在发动机制动和摩擦下的停车距离。通过比较到目标的距离和车辆在该速度下的滚动距离，差异可以用来控制刹车。当制动距离和滚动距离都短于实际距离时，需要应用油门使用这种方法，作者能够让人工智能驾驶 10 米，并在不到 5 秒的时间内平均在目标 2 毫米范围内停车。此控制器用于 Codemasters 的《尘埃 2》和《尘埃 3》中的交错起跑模式。



漂移。漂移是指汽车故意沿赛道侧向滑动，使运动方向与车辆朝向不同；两者之间的差异就是漂移角。控制器设置为误差是期望漂移角和测量漂移角之间的差值。



通常引发漂移的方法是急剧转动车辆并破坏后轮的牵引力（通过手刹或施加巨大的油门动力）。一旦牵引力被破坏，汽车的角动量将继续推动后轮克服侧向滑动的轮胎摩擦力。可以通过增加油门来增大漂移角，减少油门来减小漂移角，从而控制漂移，影响摩擦力和角动量之间的平衡。虽然可以使用 PID 控制器来管理漂移，但这非常困难，实际上，稍微作弊并直接修改后轮的动力和抓地力会更容易！在正常情况下，应禁用漂移管理，仅在可能出现特定漂移情况时启用。



抓地力损失预测、恢复和通道切换。在比赛中，当车手处于抓地力极限时，有时情况可能会迫使他们超出极限并使汽车稍微滑动。车手必须采取积极行动，以避免滑动变得更严重。因此，设计一个误差是轮胎滑动量直接测量值的 PID 控制器是有用的，即在正常情况下误差为零，但在抓地力丧失时变为非零。对滑动的反应是减少导致滑动的转向、刹车或加速量，因此理想情况下，应实施多达三个抓地力损失监测通道，分别输入到被控对象的刹车、油门和转向输入中。然而，这些应该与正常的 PID 驾驶控制器协同工作，而不是替代它们。这就需要在输入到被控对象之前混合不同的通道，或者更好的是，在一种增益调度方案中将 “滑动控制器” 级联到主驾驶控制器中。当激活时，每个滑动控制器应降低每个通道的 K 值。这种技术有点超出了简单的 PID 控制器，但它确实允许人工智能真实地测试汽车的极限。



优先级混合。虽然可以使用状态变化来切换控制器参数，但有些情况需要更模拟的方法。考虑两辆汽车并排转弯的情况。此时转向可能有多个可能的所需值（），一个用于转弯，一个用于避免碰撞，两者同时起作用。仍然可以通过基于名义优先级值 混合两个输入来使用控制器处理这种情况：



混合可以在单个 PID 控制器之前应用于所需值（），但如果两个输入的特性不同，可以将其实现为两个单独调整的 PID 通道，并在输入（）之前混合。如果使用后一种安排，请记住反馈回路将采样相同的转向输出 ，因此两个 PID 通道不是独立的，实际上是交叉耦合的。通过仔细调整可以利用这一点来平衡两个通道，但也可能导致不稳定。

## 40.9 结论



PID 控制器是人工智能程序员用于控制基于物理系统的特定方面的最简单但也是最通用的工具之一。它充当赛车人工智能战术层（定义所需的转向和速度目标）和车辆模拟（朝着目标采取行动）之间的链接。PID 可以在相当简单的层面上使用，以实现对战术要求变化的定制响应，也可以更深入地探索以处理诸如抓地力损失等驾驶问题。闭环 PID 也使程序员的工作更容易，因为它通过控制车辆在赛道上的实际行动来操作，因此程序员无需承担将抽象战术要求手动转换为实际驾驶输入的繁重任务。