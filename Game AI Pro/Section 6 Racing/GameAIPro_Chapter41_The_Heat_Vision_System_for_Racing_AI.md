# 六杠四、赛车 AI 的热视觉系统：确定最佳赛道位置的新方法



作者：Nic Melder

## 41.1 引言



在赛车游戏中，通常通过分析人工智能车辆周围的其他车辆，选择最佳的超车、阻挡、避让等车辆，然后让车辆偏离赛车线来实现这些行为，从而确定赛道位置。这个系统效果很好，并且在许多赛车游戏中都有出色的表现，但它有一个缺陷，即它一次只对一辆车做出反应。在大多数赛车情况下，这没问题，但在车群中驾驶时可能会导致一些异常行为。例如，一辆车超车后回到赛车线，却发现又需要再次超车另一辆稍远的车。一个聪明的车手会一次完成对两辆车的超车动作。热视觉系统的目的就是解决这个问题。

## 41.2 热视觉系统



热视觉系统基于即时战略游戏中使用的热图概念。它由一条一维的 “热线” 组成，该热线在车辆位置处跨越赛道宽度。然后根据赛车线的位置、车辆的当前位置、其他车辆等情况向热线添加（或移除）“热量”。一旦所有车辆都在热线上记录了信息，车辆就会被引导从当前位置移动到热量较低的位置。通过这种方式，车辆将根据其与赛道上其他车辆的当前情况找到最佳赛道位置。热线存储在一个与车辆位置处赛道宽度成比例的一维固定大小的浮点数组中。

## 41.3 向热线写入信息



从现在起，目标车辆将指其热线正在被写入的车辆，而观察到的车辆是目标车辆周围的其他车辆。



为每辆目标车向热线写入信息是一个三阶段的过程。首先，筛选车辆，只包括可能影响目标车辆的那些车辆。这将是目标车辆短距离（例如 50 米）内的所有车辆，以及一些特殊情况（例如，出于游戏玩法的原因，我们可能总是关心从目标车辆后面接近的任何车辆）。



第二阶段是运行一系列简单测试，以确定观察到的车辆的细节。这些简单测试将包括观察到的车辆是否在赛道上、是否与目标车辆并排、是否处于良好的阻挡 / 尾流（即距离不太远且速度不低于最低速度）、是否应该被超车（目标车辆快速接近）等位置。需要注意的是，对于给定的观察到的车辆，可能有多个测试结果为真（例如，一辆车可能既适合尾流又适合超车）。



最后阶段是根据这些测试的结果向热线写入信息。这是通过多次传递来完成的，每次在热线上写入不同的热信号（形状）。在这个阶段写入理想赛车线的热量也很重要。这些传递的一些示例包括以下内容：



- 位置：不可能在观察到的车辆所在的位置驾驶，所以在这个位置写入大量热量。
- 阻挡：如果观察到的车辆在玩家后面，它可能是一个很好的阻挡目标，所以在这个位置移除热量。
- 尾流：如果观察到的车辆处于良好的尾流位置，根据该车辆产生的尾流锥移除热量。



虽然可以将测试和写入阶段合并为一个阶段，但将它们分开的好处是它们也可以被其他系统使用。此外，热视觉系统可能不会一直使用，所以这些简单测试仍然可以与更传统的行为方法一起使用。例如，如果车辆偏离赛道或在旋转后方向错误，使用热视觉系统就没有意义，但 “在赛道上” 和 “是否旋转” 等测试仍然需要帮助车辆回到赛道上。



添加或移除的热量数量由许多因素决定。图 41.1 显示了许多不同行为可能添加的热信号。

## 41.4 平滑输出



一旦处理完所有观察到的车辆，得到的热线可能会非常粗糙，有许多不连续的地方。由于热线是一个简单的浮点值数组，可以使用图形技术对其进行平滑。平滑热线很重要，因为它将消除在确定所需赛道位置时可能导致 “卡顿” 的任何小的不连续点。

## 41.5 确定所需赛道位置



一旦创建并平滑了热线，就需要确定所需的赛道位置。理想情况下，这是热线上热量最少的点。然而，实际上可能无法移动到这个点，因为可能有一个大的 “热峰” 挡路。这个 “热峰” 可能是由与目标车辆并排行驶的车辆造成的，其中大量的热量作为横向移动的坚实边界。同样，最低点可能在一个较小的山峰后面，这将代表我们想要越过的战术最小值之间的折痕。见图 41.2。



在实践中，为了找到理想的赛道位置，目标位置应该从车辆位置沿着热量减少的线移动。为了避免局部最小值（即存在小热峰的地方），应该对目标点的移动应用动量和摩擦力。这类似于将一个球滚下山，球会向下滚动并且有足够的动量来克服任何小的颠簸。球停下来的地方就是目标车辆的理想赛道偏移位置。一旦找到了理想的赛道位置，就可以将其转换为赛道偏移量，然后传递给转向控制器。

## 41.6 实现注意事项



从热量写入的描述来看，似乎没有必要实际保留观察到的车辆是否并排、是否适合尾流等信息，因为无论最终行为是什么，我们都会将所有这些测试的热信号写入热线。然而，转向只是行为的一部分；可能还需要修改我们的速度。



一个简单的例子是，如果游戏模式要求人工智能跟随另一辆车，例如在一级方程式比赛中的游行圈。在这种情况下，将使用修改后的尾流行为来添加热量，但我们也需要与我们尾流 / 跟随的车辆匹配速度。由于很多时候我们可能需要知道哪些特定的观察到的车辆正在影响我们的位置，所以维护一个数组是有用的，该数组将热线上的一个点映射到提供最多热量的观察到的车辆。通过这种方式，可以很容易地快速确定在任何时候哪个车辆对目标车辆影响最大。维护这个列表在调试时也非常有帮助。



车辆可以添加的不同热信号的实际大小由许多因素决定，包括相对速度、车手特性和难度。例如，对于前面的车辆，一个激进的车手会比一个不那么激进的车手添加的热量在横向分布上更小。这将导致激进的车手需要更少的空间来超车，因此与不那么激进的车手相比，他在超车时与车辆之间的间隔更小。



出于这些原因以及游戏平衡的考虑，能够在多个维度上缩放热信号是很有用的。对于基于方形的热信号，横向宽度和沿赛道的距离应该可以独立缩放，而对于尾流锥，长度、角度和衰减应该是可控的。通过将这些可缩放的值与车手特性相关联，可以为不同的车手赋予个性。例如，你可以有一个很少尾流（长度短且角度小）且超车时留出很大空间（应用于观察到的车辆位置热信号的宽度大）的车手。

## 41.7 结论



本文介绍了一种确定车辆最佳赛道位置的新方法。不是选择一辆车做出反应并根据该车辆的位置定义行为（即，最佳目标车辆应该被尾流以激活尾流行为），热视觉系统考虑了周围的所有车辆，以建立赛道的局部战术视图。因此，车辆不需要不同的驾驶行为，如并排、阻挡或超车，而是这些动作自然发生。这个系统在赛道上驾驶时效果很好，特别是在车群中，但在其他情况下不起作用，如回到赛道上。它也只适用于有定义赛道的赛道式赛车游戏，因此不适用于像基于竞技场的破坏赛车游戏这样的自由漫游游戏。