# 六杠二、人工智能赛车的赛道表示与驾驶



作者：Simon Tomlinson 和 Nic Melder

## 39.1 引言



在人工智能赛车系统中，赛道的表示是最重要的元素之一。这个结构中包含的数据量和多样性将取决于游戏类型，但总会有物理布局的表示。通常也会有某种赛车线 —— 一种被人工智能用作沿赛道主要（最快）路线的指南。然而，赛车线和其他数据的性质取决于游戏类型的细节。



街机风格的游戏可能需要绕道去获取道具，在这种情况下，赛车线可能不太关乎最快路线，而更多地是选择最佳战术路线；也就是说，赛道会有大量分支和替代路线。在像一级方程式模拟这样定义非常严格的游戏中，会有一条单一的、高度优化的赛车线，其中包含所有人工智能车辆都可以参考的详细战术信息。由于所有车辆具有相似的特性，任何弯道的最佳速度都可以在开发过程中 “嵌入” 到赛道数据中。在一辆赛道上可以有多种车辆比赛的游戏中，可能有太多数据无法预先嵌入，因此需要一些技术来实时评估最佳速度等参数。实际上，如果计算资源允许，实时评估将考虑当前情况的变化（如非理想的弯道入口），因此是更可取的。理想情况下，任何人工智能解决方案都应该在战略（行为）层面使用近似的预嵌入数据，并在战术（驾驶）层面进行详细的实时评估。

## 39.2 物理赛道表示



赛道表示的最低目标是定义比赛区域的边界。一个好的标准表示方法是将赛道标记为沿着名义赛道中心的一系列节点，用垂直向量和法向量定义赛道的宽度和方向。然后将这些节点排列在数组或双向链表中，形成一系列四边形线段，如图 39.1 所示。这与之前发表的表示方法 [Biasillo 02a] 非常相似，但更以节点为中心，而不是侧重于线段的区域。需要注意的是，赛道通常投影到二维地面平面上；赛道的高度变化很重要，但需要单独处理。然而，如果赛道是真正的三维且有环形或许多立交桥 / 地下通道，这种方法就行不通了。



赛道宽度不一定是对称的，实际上很少是对称的。更重要的是保持由赛道节点和链接定义的路径相当平滑。赛道宽度的定义也是灵活的。一个好的定义是车辆比赛的主要柏油路面区域。然而，在现实世界的赛道中，经常有减速带、缓冲区、街道赛道的路口等等，所有这些在一定程度上都可能是可行驶的。因此，赛道边缘最好被视为模糊的，并在每一侧用三个值表示：主赛道边界（）、扩展的缓冲区边界（）和硬边界宽度，它定义了实心墙或障碍物（），如图 39.1 所示。这些宽度在赛道的每一侧分别定义，并且可以独立变化。然而，在有紧邻墙壁的赛道上，这三个宽度将是相同的。此外，赛道宽度应该是平滑的，因为突然的变化或弯折在后续处理中可能会造成麻烦。



需要注意的是，由法向量 定义的节点方向与节点之间的链接向量 不同。由于这种表示是以节点为中心的，它应该由节点处的赛道切线导出，该切线是前后链接的平均值，如公式 39.1 所示。

### 39.2.1 生成赛道



可以通过处理定义赛道表面的 “多边形汤” 来生成节点和宽度的物理赛道表示。然而，不推荐这种方法。它在街道赛道的路口或柏油路面的缓冲区等地方可能会出现问题，并且通常需要设计师干预来纠正这些问题。



更好的方法是让赛道设计师在赛道编辑工具中标记赛道节点、链接和不同的宽度。使用工具具有很大的优势。这样的工具可以在放置节点时提供大量的编程辅助 —— 例如，通过建议新节点放置的宽度或提供诸如链接和边缘平滑度等指标。对赛道的最后修改更容易处理，而且人眼比简单的算法更能判断模糊的赛道边缘。设计师还可以选择调整赛道以影响人工智能的行为 —— 例如，在困难区域作为最后手段缩小主赛道和硬赛道宽度，以减少人工智能的碰撞避免失败。

### 39.2.2 分支和开放式赛道



通常，赛道将是一个单一的节点列表，其中最后一个节点连接回第一个节点以形成闭环。然而，其他配置也是可能的。赛道可能有一个或多个分支，这将需要在数据中有多个链接引用。如果分支是高速的，在赛道表示中在实际物理分支之前的某个距离处设置分支是个好主意，这样就可以存储接近分支的最合适的赛车线。请记住，两条路线在物理上是重叠的，所以应该避免基于赛道参考系认为两辆车不会碰撞的代码。赛道也可以是点对点的，而不是环形的，在这种情况下，赛道的第一个和最后一个节点将有空链接。如果人工智能车辆驶过第一个 / 最后一个赛道节点，这可能会对其造成问题，但物理赛道在终点线之后应该总是包含一段缓冲距离，以便汽车减速、停止或驶过。一旦车辆离开摄像机视野，就可以将其移除，所以人工智能实际上永远不应该到达最后的人工智能赛道节点。

### 39.2.3 赛道节点间距



在赛道节点间距方面，需要在准确性和开发时间之间进行权衡。较小的间距意味着任意一对节点之间的角度变化较小，即赛道更接近直线，因此任何计算都更准确。这也意味着曲率或其他数据（如赛道宽度）的变化能更好地表示。然而，较长的线段意味着设计师在布置人工智能数据时工作量更小。此外，如果节点较少，与赛道相关的任何自动学习将更易于处理。一个好的折衷方案是可变间距，在高曲率区域集中，在长直道上间距更大。如果使用这种方法，人工智能会有一些额外的开销，因为沿赛道的距离必须逐段求和；它们不能再通过节点数乘以恒定间距来计算。此外，相邻线段长度的突然变化会导致切线 / 法线评估出现困难，因为较长的链接会主导计算。这些不良影响可以通过在几段内逐渐过渡长度（最好只在直道上）并预先计算和缓存链接长度来减少。

## 39.3 计算赛道数据



赛道数据主要有两种类型。首先，人工智能需要知道它在赛道上的位置；本质上是它在最近的赛道节点参考系中的位置。这可以称为 “赛道注册”，并且可以由此导出其他信息，如车辆相对于赛道的方向。这个数据几乎总是预先嵌入的。另一种信息是驾驶提示，如即将到来的赛道部分的最大可行速度。这也可以预先嵌入，但由于它可能取决于车辆特定的参数，通常必须实时计算。或者，我们可以嵌入弯道速度所依赖的坚实物理信息，如赛道的曲率半径、赛车线或两者。

### 39.3.1 赛道注册



赛道注册涉及计算三件事：定义车辆所在的链接线段的最近连续一对赛道节点、沿该线段的距离以及与参考线（如节点之间的链接向量）的垂直距离。



找到最近的节点对是一个简单的过程，即遍历节点并寻找到车辆位置的最小平方距离。该对中的第二个节点取决于车辆是在最近节点的前面还是后面，这可以通过与节点法线的点积来确定。可以使用连贯性 [Biasillo 02b]，从先前已知的最近节点向外搜索节点。如果没有先前的节点，则需要进行全面搜索，但可以通过对每 个节点进行初步粗略搜索来加快速度。一旦确定了节点对，通常将最低索引节点存储为注册节点，车辆位于该节点和列表中的下一个节点之间的线段上。



然后使用每个节点与车辆位置 之间的向量计算沿线段的距离。由于弯道赛道线段不是简单的矩形，将位置向量投影到节点之间的链接向量上会不准确 —— 实际上，它可能会显示车辆在一个线段内，而实际上并非如此。同样，如果车辆在一个线段的远端，仅投影到 法线上也可能不准确。为了解决这个问题，可以使用投影的组合作为比率，如公式 39.2 所示。



这提供了沿 在 0.0 到 1.0 之间的归一化纵向注册（）。要找到横向位置，只需计算 ，从而得到 的长度，如图 39.2 所示。



需要注意的是，如果车辆超出两条垂线的内交点（图 39.1 或图 39.3 中的点 ），则注册应被视为未定义，因为赛道的逻辑前进方向不再一致。此外，虽然在战略层面上对赛道中心线的注册是有用的，但战术驾驶计算需要对赛车线进行注册。这意味着一个赛道节点理想情况下不仅需要存储赛车线进入线段的垂直方向上的位置，还需要存储赛车线在该点的法线（切线）和垂线。使用与每个节点的固定横向偏移量结合主节点方向向量是一种替代方法，但由于赛车线角度在弯道周围与节点法线角度不同，这可能不准确。

### 39.3.2 曲率半径



计算曲率半径需要一个角度和一个距离。有多种构造方法，但首选的方法是基于节点使用赛道曲线的切线，而不是线段的中间，因为这样情况会更明确，如图 39.3 所示。假设在 处的切线延伸形成一个简单的弧到 （下一个赛道节点），由此可以找到 的长度。角度可以通过节点处的切线和链接向量的点积找到。然后，使用相似三角形，曲率半径 如公式 39.3 所示。



赛车线的曲率半径通常比赛道中心的曲率半径更有用，因为它用于计算最大转弯速度。然而，当人工智能车手偏离赛车线时，会出现其他半径，此时赛道中心半径可作为近似修正半径的上限值。

### 39.3.3 赛道的弯曲性质



虽然赛道表示是分段线性的，即节点之间是简单的直线链接，但应该明白，任何一段赛道实际上在一定程度上都是弯曲的。这意味着在赛道参考系内对位置的任何引用都是近似的。我们仍然可以沿着线性链接插值信息，如赛道宽度，但这些计算只有在节点处由其垂线形成的横跨赛道的线附近才是准确的。因此，如果可能的话，应该避免使用赛道参考系进行精细的碰撞避免。对于车辆与车辆的避免，始终使用物理世界坐标，但对于战略规划，近似的赛道注册就足够了。同样，公式 39.3 中定义的曲率半径严格来说是在 处的瞬时值。在实际赛道上， 处的切线会不同，因此曲率半径在整个线段上会有所变化。

## 39.4 赛道驾驶



在本节中，我们将讨论沿着主赛车线的逐帧驾驶。然而，人工智能代码也应该考虑不在理想线上的情况，并准备对计算进行近似调整。实际上，由于比赛实践永远不会与赛车线的理想情况完全匹配，应该意识到驾驶计算中的最终准确性实际上可能是多余的。

### 39.4.1 使用前瞻点或引导物转向



赛道转向基于使用赛车线作为指南。赛车线被定义为与每个赛道节点相关联的一系列位置，但可以使用线段内的横向距离在节点之间进行插值。如果转向是基于汽车赛道注册位置正前方的赛车线计算的，人工智能会倾向于进行大量小的修正，这会导致在赛道线上左右穿梭。在最坏的情况下，这种情况会累积，被用户注意到，并最终导致车辆失控打滑。



相反，更好的方法是朝着车辆前方一定距离的瞄准点转向，转向基于车辆当前方向与汽车中心和瞄准点之间的向量的角度。这有助于使转向更平滑。然而，这可能会导致异常行为；在急转弯处，较大的前瞻距离会使人工智能切入弯道内侧。为了解决这个问题，前瞻距离应该与赛道曲率和 / 或当前速度相关；具体的公式往往需要反复试验。



这种技术可以通过让转向瞄准一个实际的人工智能对象（称为引导物或兔子）来进一步改进。在每一帧，引导物沿着赛车线以等于车辆当前速度的距离进行更新，并根据前瞻距离的重新评估进行修正。使用引导物还有其他优点，因为它是一个可以操作以影响转向的对象。也可以通过使用缩放的节点垂直向量在整个线段上的插值，平行于赛车线但有一个小的偏移距离驾驶。

### 39.4.2 弯道速度和刹车距离



任何节点处的最大转弯速度基于局部曲率半径（）、车辆质量（）和其速度（）与轮胎可用抓地力极限（）的简单函数关系，如公式 39.4 所示。



然而，还有其他因素 —— 车辆悬挂、重量分布、下压力甚至转向锁都可能起作用。因此，一种更好的方法是根据半径值从车辆物理接口请求最大速度。这个请求可能使用修改后的公式 39.4，也可能使用查找表。



在理想的弯道中，曲率半径会从无穷大变为弯道方向的固定值，并且所有刹车都会在前一个直道上完成。然而，实际的弯道并非如此，最好的车手可以在完全转向之前刹车进入弯道起点。



一个好的解决方案是预测车辆在刹车时的速度，并将其与赛车线上每个未来赛道节点的最大可行速度进行比较。如果完全刹车时的预测速度大于某个节点的最大速度，那么车手必须刹车。如果速度预测降至零或更低且未超过节点速度，汽车则可以安全地继续加速。在战术层每隔几帧重新计算一次，如果可能的话，考虑每个节点的刹车率（如果车辆还需要转向，刹车率不会是 100%）。这在计算上可能很昂贵，因此替代方法包括在每个节点嵌入最大速度或让设计师在编辑工具中定义速度。然后可以使用 “到速度提示的距离” 与 “到该速度的刹车距离” 的比较作为刹车启动器。

### 39.4.3 避墙



避墙可以被视为中程或短程问题。中程问题是外推未来车辆位置，如果该位置在赛道外则采取纠正措施 [Biasillo 02b]。然而，有一些注意事项。首先，如果车辆成功地在弯道转向，那么外推应该考虑转弯率；否则，弯道外侧的车辆可能会无缘无故地与墙壁发生冲突。此外，任何转向都应该 “在控制范围内”，即在校抓地力极限内。此外，纠正措施应该基于可用的剩余抓地力；如果额外的转向会使车辆超出抓地力极限，那么刹车可能是更好的选择（即使这可能仍然无济于事，但更现实，因为不可避免的撞墙速度会更低）。如果外推与非硬赛道边界冲突，反应可能不那么严重，从而允许汽车驶离并恢复，而不是冒着失控的风险。如果使用了引导物对象，也可以验证它是否在赛道内，并且可以与外推一起使用。



然而，同时直接观察侧面和前方也是个好主意；即，根据与汽车旁边任何墙壁的接近程度进行小的修正，以保持安全的缓冲距离。在狭窄的赛道上，车辆必须靠近墙壁行驶时，这种方法可能更有效，因为外推是一种近似，可能过于保守。这种短程调整与基于 PID 的控制层 [Melder 和 Tomlinson 13] 配合使用时效果特别好，作为对主转向目标的修正混合在一起。

## 39.5 赛车线



什么是最佳赛车线？严格来说，它是车辆行驶的结果路径，经过优化以在最短时间内完成赛道。这不一定与任何局部区域的最快路线相同，因为在复杂路段中，为未来弯道做好进入准备可能比以最高速度通过当前弯道更重要。



即使可以定义这条线，使用引导物通常意味着车辆实际行驶的路径可能与赛车线指南不同。在编辑数据时应该记住存储的赛车线和实际路径之间的这种明显脱节；最重要的是最终的驾驶性能，而不一定是存储的赛车线数据的样子。在代码中，赛车线应该存储为每个赛道节点的宽度偏移量。这可以使用参考节点位置和归一化的垂线轻松转换为实际世界位置。



赛车线的生成可能是一个复杂的过程，这里没有足够的空间来探讨所有问题和技术；然而，以下是一些要点。要求设计师在赛道编辑工具中包含赛车线的初始估计，手动移动点并测量单圈时间，是一个耗时且繁琐的过程。另一种方法是记录经验丰富的用户在游戏中驾驶的赛车线。这确实有效，但记录的路线可能容易出现弯折和薄弱区域。人类的转向并不绝对平滑，几乎总是在转向图中包含增量或修正。记录线中的任何弯折都会导致该赛道部分的曲率半径被高估，从而使速度比实际可能的速度更低。此外，任何一圈都不太可能是 “完美的”；即使是最好的玩家也会犯一个或多个小错误，这会使某些部分无效。这并不是说要避免记录方法，但应该通过一些后处理来支持它，对几圈进行平均或修补，并通常消除弯折。无论使用上述哪种方法，请记住人工智能仅将赛车线用作指南，因此即使是最 “完美” 的存储赛车线也不会导致最完美的行驶线。



到目前为止，最好的方法是某种形式的自动学习 [Tomlinson 和 Melder 13]。这不仅可以加快优化过程，还可以消除战术驾驶计算中的人为因素，因为学习是基于输出结果而不是输入的赛车线格式。然而，请记住，线上的节点是相关的，即如果一个节点移动，周围的节点应该以连贯的方式移动。例如，如果学习算法将一个节点横向移动 0.5 米（如果赛车线被约束在赛道节点垂线上，这是唯一的自由度），那么前后节点应该根据与主要扰动节点的距离相关的函数移动较小的量。此外，确保指标（单圈时间）是在几圈上平均的；特别是，在环形赛道上，人工智能应该有半圈的助跑，而不是不具代表性的静止起步。人工智能中的随机性应该关闭，或者更确切地说设置为固定的中间值。即使使用学习方法，生成的赛车线实际上也只适用于特定车辆的能力，因为刹车或转弯抓地力的差异会微妙地影响线路。为每辆车记录一条线路是不切实际的，但应该考虑对不同车型进行平均，或者为不同车组使用两三条线路。

## 39.6 替代线路和其他战术信息



在竞争激烈的比赛中，实际的赛车线也可能考虑战略因素，例如，在可以容忍少量时间或速度损失的情况下，让对手更难超车。这意味着从概念上讲，存在一条最佳防守线，它可以以与赛车线相同的方式存储。同样，也可以存储一条或多条超车线。通常，在一个弯道处有多种可能的线路，包括在稍宽的对手内侧切入或在弯道入口处变宽以在出口处更早获得速度（“内切”）。当然，所有这些线路都需要大量额外的工作来优化和存储额外的数据，因此可能更倾向于使用从单一赛车线的横向偏移来产生的应急解决方案。不过，赛道节点上的标记仍然有用，例如，向人工智能指示在未来弯道处可能的超车入口。

## 39.7 使用样条曲线



在讨论赛道线段时，我们提到分段线性近似只在节点附近准确。通过在节点之间使用样条曲线可以改进这一点，这样赛道中心、边缘或赛车线的曲线在整个线段上都能完全定义。有多种样条曲线可供选择，如 Catmull - Rom 或 Bézier 样条曲线。然而，样条曲线有其利弊。注册不是直接的，通常必须使用诸如二分法之类的迭代过程来完成。同样，局部切线必须使用有限差分来估计。

## 39.8 结论



我们讨论了赛道的高度详细的表示方法，以及如何实时使用该赛道在速度和性能极限下引导人工智能车辆。这里的细节和复杂程度可能只适合模拟类型的赛车游戏，但所描述的方法可以为更街机风格的游戏进行简化。也有人建议通过使用样条曲线可以改进分段线性表示。进一步需要探索的领域包括学习技术以改进赛车线，以及更微妙的驾驶考虑因素，如高度变化（特别是坡顶）的影响，它可能会导致车辆暂时失去下压力，从而失去抓地力。