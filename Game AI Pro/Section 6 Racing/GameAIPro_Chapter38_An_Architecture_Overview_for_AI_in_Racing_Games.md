# 六杠一、赛车游戏人工智能架构概述



作者：Simon Tomlinson 和 Nic Melder

## 38.1 引言



本文描述了高速赛车人工智能的需求、架构和最佳实践。我们主要考虑高制作价值的模拟游戏，但街机风格的游戏也可以使用此处方法的简化元素来构建。本书赛车部分的后续文章将更详细地扩展赛车人工智能系统的一些关键方面。



其中许多技术已经存在了一段时间 [Biasillo 02a, 02b, 02c]，但在赛车中，胜负之间的差距可能只有几分之一米或秒。因此，追求准确性和细节非常重要，目的是让用户相信他的人工智能对手在赛道上和他一样专业。

## 38.2 理解物理原理



在设计人工智能系统之前，开发者充分理解所涉及的物理类型以及它将如何影响实现是很重要的。在非常简单的游戏中，人工智能会沿着预定义的样条线前进，所需的只是基于参数公式和基本碰撞检测来模拟转弯速度、加速度和刹车 —— 检查前方样条线在刹车距离内是否被阻塞。



这里不需要物理模拟。但在完整的模拟中，人工智能赛车将与玩家体验的类似，包括发动机模型、变速器、轮胎模型、刹车模型以及所有相关的车辆特性和怪癖。



车辆物理主要涉及力和轮胎。汽车的任何加速度，无论是速度变化还是方向变化，都会通过轮胎施加力。力的大小受轮胎性能限制，如果超过这个限制，轮胎将不再抓地，汽车就会打滑。在弯道中，这可能导致转向过度（汽车向弯道顶点切入，车尾甩出）或转向不足（汽车向弯道外侧漂移）。在加速或刹车时，轮胎可能会打滑或抱死，降低速度变化的效果，因此人工智能的一个关键动作是确保不超过可用的轮胎抓地力。这通过确保以正确的速度转弯、及时刹车以及通过逐渐踩油门来控制加速度来实现。如果人工智能过于保守，速度就会很慢，所以最好的人工智能，就像最好的人类车手一样，需要始终在 “抓地力极限” 附近工作。这就是整个人工智能设计的目标。



赛车物理的细节超出了本文的范围，但强烈建议人工智能开发者在这方面打下坚实的基础 [Pacejka 06]。

## 38.3 架构



最好将人工智能视为由四层和一个贯穿这些层的子系统组成。顶层是角色层或人物层。这一层在相当长的时间尺度上工作，负责影响人工智能性能的个体车手技能水平。下一层是战略层，它在单帧到几秒的短时间尺度上工作。战略层包含系统的行为元素，并根据对近、中距离赛道表示的检查来确定大致的转向和速度目标。再下一层是战术层，通常每帧都会处理，负责将转向和速度目标细化为确切的值。通常，在战略和战术层面会产生多个相互竞争的目标，这些目标将在最终控制层进行分析和组合。这一层负责计算控制器输入（转向、刹车和油门）以实现前几层的策略。



与这些层并列的是至关重要的碰撞避免子系统。通常可以根据它们执行分析的即时性将其分为两部分。在较远的范围内，人工智能需要查看汽车前方一段距离的赛道，并规划绕过任何障碍物（如碎片或损坏的车辆）的安全路线。在较近的范围内，人工智能需要因静态或动态障碍物进行小而快速的调整。例如，在靠近实心墙赛车、超车时与另一辆车并排行驶，或在对手后面紧跟以准备超车时的 “尾流” 行驶。

## 38.4 人工智能车手角色



在现实生活中，没有两个车手是相同的，他们有不同的能力，并且在比赛中采用略有不同的策略。在像一级方程式或印地赛车这样的固定规格比赛中，车辆性能相当相似，驾驶技能的差异将对比赛结果产生重大影响。在最低限度上，车手技能的差异会导致赛道上车体的物理位置有所不同。这不仅更现实，而且有助于确保玩家在比赛过程中遇到一些微小的挑战。如果做得好，车手角色可以融入观察到的行为中，为游戏体验增添显著的色彩。然而，只有在游戏中人工智能车手的行为能够区分开来时，这种色彩才真正有价值。通过赛前可查看的车手档案或游戏内的信号（如音频评论）来支持这些特征也会有所帮助。



主要特征将是技能，这是衡量他们在极限状态下驾驶能力的指标；次要特征可能包括攻击性、车辆控制和失误。主要是在任何与速度相关的计算中应用技能特征，例如在计算转弯速度和刹车距离时乘以实际可用的抓地力。这将产生降低整体速度的净效果。虽然这个特征可能在 [0, 100] 范围内向用户和设计师展示，但我们始终要在极限附近驾驶的要求意味着，在人工智能战略层及以下，这应该映射到一个更小的范围，比如 98 - 99%。虽然这可能看起来是一个小范围，但在几圈比赛中积累的 1% 的变化可能会产生惊人的大影响，特别是当在代码中的几个地方应用时。可能会发现需要一个更小的技能因素范围，以避免人工智能的表现过于分散。同样，通过映射到较低的范围（例如，80% - 82%），整个比赛体验应该会变得更容易，所以技能特征也可以用于修改整体游戏难度。



使用较小的范围会使用户更难辨别不同车手之间的速度差异。为了解决这个问题，可以为车手的技能应用生物节律。技能因素会随时间缓慢变化，例如使用周期为 100 秒的正弦波。这样，车手在几圈比赛中的平均技能可能是 99%，但在某些短时间内，技能因素可能会显著降低。这将使人工智能车手暂时容易被超车，但不会产生过大的长期影响。不一定非要使用正弦波作为生物节律，也值得尝试不同的波形，例如，低占空比的方波，在 90% 的时间内产生接近上限的技能因素，但在短时间内可能低至 90% 或 95%。通过定义一组规则，这个想法可以进一步扩展到涵盖完整的比赛节奏系统 [Jimenez 09, Melder 13]。



次要特征可用于影响行为变化，例如进入超车模式的概率、油门应用的速率或他们犯非受迫性错误的数量。攻击性高的车手会更靠近前面的车，并且超车时需要的空间更小；控制能力低的车手可能需要两倍的时间来踩下油门；失误特征高的车手可能会在弯道速度计算中导致随机错误。

## 38.5 赛车行为



赛车人工智能系统中的行为种类并不多，所以通常一个有限状态机（FSM）就足以表示它们。在任何时候，大多数行为都可能有效，所以它们通常都会竞争成为活动状态，并且应该在战略层的每次更新时进行审查。管理这一点的一个好方法是让每个有效状态（由当前状态的退出转换定义）评估一个 “效用” 分数。只要这个效用分数大于当前状态的分数，就会导致状态转换。为了避免短暂的状态和快速的转换，应该给当前状态的效用添加一个小的额外阈值。这将产生滞后效应，除非出现明显更强的替代状态，否则将倾向于保持当前的行为状态。以下是一些更常见的行为描述。

### 38.5.1 正常驾驶



这种行为的目标是尽可能快地绕主赛道行驶。人工智能应该合理地接近最佳赛车线，但在避免其他车辆方面要保持保守：在前面的任何车辆或旁边的车辆之间留出合理的空间。这种行为的效用是整个系统的基线常数，其他行为必须超过它。如果使用 [0, 1000] 的效用范围，500 是一个合适的值。

### 38.5.2 超车



在超车模式下，人工智能积极寻找一条能够让它超过前面一辆或多辆车的线路。人工智能仍然基本上沿着赛道行驶，但会进行调整以实现超车动作。在比赛开始等情况下，可能需要同时处理多个超车目标，否则结果行为可能看起来缺乏竞争力和机械。该状态的分析是查看赛道前方。如果在范围内有一个或多个对手，并且人工智能有速度优势，分析将确定一个足够宽的赛道宽度上的超车窗口。



这种分析越深入，超车事件就会越好，预判是关键。例如，前面的车现在可能不够慢，但如果它接近一个弯道，它可能会减速并提供机会。另一个例子是前面的车转向不足，很快会在内部打开一个可行的间隙。



不是每个超车机会都应该被利用，随机性或生物节律特征应该影响效用计算。一般来说，在所有车辆都全速行驶的直道上超车的可能性较小，所以当前和未来的赛道特征应该在效用中考虑。如果有明显的速度优势（例如对手因机械故障减速），那么超车应该总是被激活。请注意，这种行为在维度精度方面不应过于精细，因为当人工智能超车时，战术层和短程避免子系统将处理安全超过对手的细节。



一旦超车模式被激活，车手应该变得更具攻击性，甚至更接近极限。尽管有任何机械助力，如使用硝基，人工智能的技能水平也应该提高到接近饱和甚至超过饱和。例如，车手可能会故意选择接受暂时超过抓地力极限并轻微打滑（转向不足）的风险，通过在进入弯道内侧时晚刹车来超过对手，因为他们知道一旦占据位置并阻挡了另一辆车，他们就可以恢复镇定并完成转弯。避免容忍度也应该降低；人工智能在超车时将准备更靠近后面或旁边的对手。实际上，在某些游戏类型中，可能允许一些轻微的、受控制的接触。



对超车机会的战略分析应该继续，这样，例如，如果差距缩小，超车就会中止，人工智能将返回正常驾驶模式。为了避免人工智能的不稳定切换，在中止尝试后的几秒钟内禁止重新激活超车状态也是好的。成功的超车是指人工智能超过对手并领先一段距离，在这种情况下，它可以返回正常驾驶。不过，人工智能不应过早切换，因为状态变化导致的速度小幅降低可能意味着随着对手超过人工智能，位置优势会很快丧失。

### 38.5.3 防守和阻挡



在某些赛车风格中，通过移动到对手的路径中来防守超车是可以接受的。当对手从后面接近，不在同一条线上且具有当前或未来潜在速度优势时，将使用效用触发此状态。



防守和阻挡状态通过进行小的转向动作来操作，以使人工智能在赛道上的线路与后面的对手车辆相匹配。根据现行的赛车规则，一旦对手并排或甚至在超过设定的持续时间或横向移动后，防守可能会中止（例如，一级方程式规则允许一次横向移动，即不能来回穿梭）。



在除了最具攻击性的赛车类型之外的所有赛车类型中，如果将对手置于危险之中（例如，将他挤出赛道），防守应该终止。管理这一点的一个好方法是允许对手的人工智能或人类在感到危险时发送投诉消息，以便中止防守模式。与超车类似，当人工智能进行防守和阻挡时，速度余量应该推向极限。

### 38.5.4 分支



一些赛车类型使用有多个路线和分支的赛道；即使在经典模拟游戏中，也可能有维修通道。决定选择分支的效用值可以基于各种战略考虑：在模拟类型中，轮胎磨损、燃料水平和相对于其他车辆的位置，或者在更街机风格的游戏中，对捷径的价值与风险的分析。在任何情况下，关键细节是足够早地做出决定，以便能够遵循进入分支的正确线路。此外，人工智能需要特别注意可能阻挡进入分支的附近车辆 —— 如果必要，及时刹车以落在其他车辆后面。因此，这种行为不应结束，直到进入替代赛道，或者例如，由于有障碍物而中止分支。

### 38.5.5 恢复



在最逼真的游戏中，人工智能可能会偶尔犯错，导致偏离赛道或在赛道范围内打滑。因此，恢复行为的目标是重新回到比赛中。在实践中，赛道内和赛道外的恢复可能是使用指标触发的单独行为，例如指向错误的赛道方向或偏离主赛道边界太远。在任何情况下，首要任务是稳定汽车，停止滑动，如果方向错误或靠近障碍物则减速甚至停车。



在赛道外恢复时，目标是以适度的速度驶向赛道最近的边缘，给从后面接近的任何车辆让路。对于赛道内恢复，人工智能可以进行缓慢的急转弯，甚至可以尝试让后轮空转。在任何情况下，良好的驾驶礼仪意味着，在前方道路畅通之前，人工智能应该原地不动，以避免碰撞。



由于恢复过程在竞争力方面非常不利，应该尽可能给人工智能继续比赛的每一个机会，所以最好不要基于效用值的单次更新来触发恢复，而是在几秒钟内对效用进行积分。例如，在每秒 10 帧的战略更新率和 [0, 1000] 的效用范围内，每偏离赛道一米可能增加 10 分，每失去一个轮胎抓地力增加 10 分，但即使偏离赛道，每帧也减去 20 分。一旦汽车回到赛道上、稳定且方向正确，分数就会迅速减去，导致这种行为完成。

## 38.6 比赛编排器



比赛编排器本质上是一个脚本系统，设计师可以使用它在比赛过程中影响故事情节方面。它是一个单独的人工智能对象，接收来自单个人工智能车辆、物理系统或主游戏代码的事件触发。然后它在人物或战略层面与人工智能交互（尽管它也可以在物理或其他系统上实现动作）。事件的例子包括在比赛中途改变特定车手的技能水平、导致轮胎爆胎或触发人工智能自定义行为（例如，试图与玩家碰撞）。

## 38.7 接口



人工智能与车辆之间的主要接口应该与人类控制器和汽车之间的接口相同，以便人工智能和人类可以互换。人工智能还需要一个接口从物理中提取指标，如可用抓地力和每个轮胎是否当前在滑动。一辆人工智能车辆向另一辆询问详细信息，如 “你要左转吗？” 也没有坏处。这可能看起来像作弊，但现实生活中有经验的车手总是能够读懂迹象并解读对手的意图。当然，一个真正的车手可能不会总是正确解读，所以在人工智能请求接口中添加一些模糊性和随机性可能是合适的。

## 38.8 平衡人工智能



人工智能必须始终保持平衡和调整，以确保每辆车都能尽可能快地行驶，但也要在赛道上保持车辆的良好分布，以便玩家始终感觉与其他车辆 “有互动”。平衡人工智能通常是游戏开发过程中最困难的部分。它可能非常耗时且有压力，所以总是值得考虑这个过程将如何工作以及可以构建什么工具来缓解痛苦。



目标是最大化玩家的体验；我们希望他们努力竞争和超车，但最终我们希望不同能力的玩家仍然有合理的获胜机会。在像一级方程式这样车辆规格严格受限的场景中，问题主要是使一组相当相似的人工智能对手的表现接近玩家。在同一赛道上车辆性能范围更广的游戏中，问题更大。



正是出于这个原因，许多游戏采用了一种称为橡皮筋效应 [Melder 13] 的系统，试图在比赛过程中改变人工智能的速度以最好地匹配玩家的速度。通常，目标是在比赛开始时领先玩家，但在比赛结束时落后，理想情况下是玩家在比赛的最后几百米达到获胜位置。请注意，平衡的机制可能不完全在于人工智能。如果人工智能超过 100% 的抓地力极限，它会犯错、打滑，最终其性能会受到影响，从而阻碍平衡过程。



通常最好将人工智能平衡视为实现群体中性能正确分布的过程，而与玩家的整体平衡最好通过车辆物理中的调整（如轮胎抓地力、发动机功率和扭矩）来实现。还要记住，在一些实现中，人工智能使用的是物理的 “简化” 版本，即使所有参数都相等，也可能不会产生与人类车辆相同的结果。在物理平衡调整中也必须考虑到这一点。

### 38.8.1 离线自动学习



即使不使用动态的游戏内系统，也有大量机会使用离线自动学习来优化人工智能性能。在开发初期，赛车线的定义通常是由设计师直接在赛道上放置样条线来指定的，但这可以改进。一个简单的改进是使用二分法逐个优化赛车线上的每个节点 [Biasillo 02c]。然而，熟悉多元优化的人知道这种策略可能容易产生错误的解决方案。



大致来说，问题在于赛车线是其各部分的总和，或者更确切地说，每个部分或节点都不是独立于其周围的节点的。考虑一个包含 10 个节点的曲线上的单个节点，它是平滑的但不是最优的。如果将单个节点横向移动 0.5 米，这只会在赛车线上产生一个弯折，可能会导致人工智能减速。在实践中，需要做的是连贯且按比例地移动几个点。实现这一点的一个好技术是改进的遗传算法。这基于随机蒙特卡洛技术，其中随机选择和修改多个变量，如果测量的过程指标（通常是平均单圈时间）有所改善，则保留新解决方案，否则丢弃它并尝试新的尝试。



在多元问题中，蒙特卡洛通常比线性搜索快约 √N 倍，其中 N 是变量的数量。遗传算法提高效率的地方在于它们一起处理问题中的变量组，将来自两个亲本的几个节点的线路拼接在一起。如果再结合连贯的突变（修改相邻节点的序列），那么这种自动化技术可以大大改进。此外，在遗传算法的构建中利用赛道知识可能非常有利。例如，标记已知形成曲线的节点组，并鼓励遵循可能有利的模式的突变，将有助于遗传算法找到一个好的解决方案。还要注意，赛车线的优化不是自动学习的唯一领域。战略层使用的参数，如效用权重和控制层或 PID 控制器中的常数，也适合这种技术。



使用自动学习有许多陷阱和提示。与任何数值优化方法一样，问题中优化的参数数量越多，难度呈几何级数增加。因此，如果要使用自动学习，人工智能应该从一开始就以尽量减少数据量的方式进行设计。例如，在定义赛车线时，节点应该放置得更宽，以尽量减少赛道周围的节点数量。



自动学习的另一个陷阱是可能很难看出解决方案是如何产生的，并且对底层系统的任何需要重新评估解决方案的更改可能会很耗时。出于这个原因，应该始终提供手动编辑方法作为备用。然而，其他优化方法也可能遇到类似的问题。例如，在仅通过人类玩家记录赛车线的情况下，赛道的重大变化仍然需要重新学习、记录和测试整个赛道。



最终，平衡过程是否有效的最终裁决者必须是人类。在像比赛这样复杂的过程中，即使人工智能的单圈时间表明它们已经优化，但实际上人工智能可能并不具有竞争力。这可能是因为当其他车辆在赛道上时，人工智能跑得更慢，或者因为人工智能太容易或太难被超车。在不同场景下对不同能力的玩家进行测试将始终是一个必不可少的平衡工具。

## 38.9 结论



本文详细描述了高速赛车游戏中人工智能的广泛架构。实现的细节和深度将取决于赛车游戏的风格，但大多数游戏将需要所描述的大部分（如果不是全部）元素。然而，在现实生活中，赛车往往取决于微小的细节，在高端赛车模拟中也是如此。在这方面，我们实际上只是提供了一个起点；在追求真实感、性能和卓越性方面，还有很多需要学习和试验的领域。



赛车人工智能的实现充满了矛盾。主要的矛盾在于人工智能必须实时运行，做出复杂的决策，不仅要保持对汽车的控制，还要将其驾驶到能力的极限边缘。然而，人工智能的成功在于长时间的准备预烘焙数据、调整参数和预测潜在困难场景的解决方案。因此，矛盾在于成功的赛车人工智能是实时控制和精心策划的数据之间的谨慎平衡。此外，不应在设计阶段偷工减料；在一个高度关联的人工智能系统中，在开发后期发现的弱点可能很难补救。