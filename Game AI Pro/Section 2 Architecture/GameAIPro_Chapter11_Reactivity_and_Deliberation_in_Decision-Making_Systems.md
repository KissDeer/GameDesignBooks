二杠八、决策系统中的反应性和深思熟虑
卡尔・科特
11.1 引言
为视频游戏设计决策系统可能非常复杂，通常基于经验、直觉和持续的重构。多年来，成功发布的游戏使用了两种主要类型的决策模型：基于图形建模语言的决策模型，如有限状态机（FSM）、分层有限状态机（HFSM）和行为树（BT），以及基于符号规划语言的决策模型，如面向目标的行动规划器（GOAP）和分层任务网络（HTN）。不幸的是，很少有文献解释应该如何以及何时使用每种方法，以及它们最适合哪种架构问题。
本章将介绍关于反应性和深思熟虑的一些考虑和想法，这是决策系统的两个关键机制。反应性是指智能体在其环境中感知到刺激时做出响应的能力，而深思熟虑是指智能体做出决策并采取相应行动的能力。通常，在设计每个视频游戏智能体时，这两者都在一定程度上是必需的。通过展示如何将这些关键概念作为核心设计原则进行整合，我们将解释如何避免常见的陷阱并创建更具可扩展性和灵活性的决策系统。
11.2 让我们从头开始
在最简单的表达中，典型的决策系统围绕着感知 - 思考 - 行动模型展开，如图 11.1 所示。它描述了智能体需要从其环境中收集信息（感知），在一些决策过程中使用收集到的信息来决定下一步做什么（思考），相应地采取新的行动（行动），并重复这些步骤以创造自主性。
虽然这个模型展示了智能体的 “内在自我” 与其环境之间非常直观的关系，但它没有描述创建适应性行为所涉及的决策机制的性质。事实上，大多数游戏至少需要两个主要的决策机制：反应性和深思熟虑。接下来的部分将更详细地描述它们是什么以及它们在决策系统中的具体作用。
11.2.1 什么是反应性？
反应性是指智能体对其环境中感知到的刺激做出响应的能力。视频游戏中的大部分乐趣来自于智能体对玩家存在的反应 —— 无论是直接感知（例如，看到玩家）还是间接感知（例如，听到物体破碎在地面上的声音）。为了做出响应，智能体必须在很短的时间内采取某些行动，否则它会产生行为假象，玩家可能会认为这些假象与他们自己的能力相比要么不可信，要么不够具有挑战性。这些特定的行动被称为 “反应”，正如我们稍后将看到的，在设计决策系统时至关重要。图 11.2 展示了一个行为时间线，其中包含了典型的反应示例。
反应可以分为两类：无意识反应和认知反应。无意识反应是指身体对某些事件的不受控制的反应，如疼痛、窒息或打喷嚏。认知反应是指需要最少的上下文解释才能触发的反应。例如，在图书馆中，大声的声音可能会引起注意，但在建筑工地上，这可能是预期的。
根据我们的定义，反应可以持续很短的时间（例如，智能体重新定向朝向玩家所需的瞬间），也可以持续一段时间（例如，智能体疼痛 10 秒）。这意味着在反应期间，可以感知到其他刺激，这些刺激可能会引发其他反应，如图 11.3 所示的时间线所示。
11.2.2 什么是深思熟虑？
深思熟虑是指智能体考虑许多知识元素来决定下一步做什么的能力。在视频游戏中，它主要定义了智能体在每种情况下的行为，从快节奏的行动情况（例如，战斗）到更具战略性的情况（例如，调查一个区域）。事实上，深思熟虑包括执行任何任务所需的所有理性和非理性的内省机制。例如，它包括信息分析过程、直觉、过去的经验、情感、思考过程、随机评估、逻辑等。在本文中，我们将使用术语 “决策模型” 来指代所有这些类型的内省机制。
一个决策模型可以在瞬间、几秒、几分钟、几天甚至几年内做出决策。对于视频游戏，大多数决策通常在几秒或更短的时间内完成。
11.3 常见误区 #1：一个决策模型统治一切！
支持决策系统中反应性的典型方法是使用一个能够满足反应性和深思熟虑要求的决策模型。尽管这种方法看起来很诱人，但它有许多缺点，将在以下部分讨论。
11.3.1 本质不同
基于反应性和深思熟虑的定义，可以有效地得出结论，只要深思熟虑的实现允许在很短的时间内做出决策并采取行动，反应性和深思熟虑就可以合并在一起。然而，这个结论只考虑了决策模型本身的响应性方面；它没有考虑触发决策需求的原因以及所采取行动的动态本身。那么，让我们来分析一下。
关于深思熟虑和反应性的第一个区别是，在这两种机制中，触发新行动需求的原因不同。对于反应性，触发反应是由中断引起的，这些中断的优先级高于当前正在进行的事情。
对于深思熟虑，决策的需求来自两个不同的来源：（1）当前的深思熟虑的行动（或反应）完成，必须采取新的行动，（2）当前的上下文以某种方式发生变化，使当前的行动或行动计划无效或取消。虽然一些深思熟虑的决策必须迅速做出，但其他决策可以花费一段时间而不会造成任何问题。这意味着深思熟虑不仅仅是关于响应性。另一方面，它是反应性的主要方面。在一般的视频游戏中，深思熟虑往往是快速的，因为看到智能体在长时间处于思考状态而不采取任何行动是不有趣的。人们主要认为智能体应该立即知道该做什么以及如何去做，而不会犹豫不决。尽管如此，在这两种情况下触发决策需求的本质是根本不同的。
关于反应性和深思熟虑本质的第二个观察与它们各自采取的行动的性质有关。虽然人们认为智能体应该立即知道该做什么以及如何去做，但也期望智能体在进行深思熟虑的行动时，不会因为不明显的原因而每秒都改变主意。基于此，我们可以看到反应性和深思熟虑的第二个重要区别：反应性机制的目标是创建行动的即时变化，以反映身体 / 环境意识，而深思熟虑机制的目标是根据上下文参与可能持续最长时间的最佳行动。虽然这种差异看起来很微妙，但它对反应性和深思熟虑决策模型有很大的影响。
图 11.4 所示的示例表示一个非常简单的 FSM，描述了一个典型动作游戏中智能体的深思熟虑决策模型。
这个 FSM 可以立即评估和执行转换，也就是说，它可以用于支持反应性决策模型。这些状态描述了非常高级的行为，如追逐威胁、巡逻环境、参与战斗和逃离威胁。这些行为可以分解为许多子动作，但它们不属于该 FSM 中表达的深思熟虑决策模型。转换使用的符号也代表了高级概念，如看到威胁、受伤、靠近或远离威胁。需要注意的是，这个示例中没有显示反应性决策模型。行为时间线显示了不期望的行为假象。
为了理解这个 FSM 的正确动态，我们需要了解智能体如何从其传感器感知和分析信息，以及对于这个智能体来说受伤意味着什么。对于这个示例，我们将关注感知系统，并假设转换的 “威胁可见” 符号直接与视觉系统挂钩。图 11.5 显示了一种情况的时间线，在追逐过程中，由于物体阻止智能体始终看到威胁，智能体可能会暂时失去对威胁的视线。
通过查看时间线，我们可以观察到行为轨迹中的许多转换。它们表示智能体在几秒钟内多次从对威胁的奔跑姿态转变为慢速巡逻姿态，因为视觉系统与威胁失去了直接视线。从玩家的角度来看，行为转换似乎不正常，它们很可能被判断为由于不明显的原因而导致的不期望的行为假象。更不用说动画系统可能甚至没有足够的响应能力来执行这些快速的姿态转换而不产生动画弹出假象。这是一个很好的例子，说明响应性不是深思熟虑决策模型需要考虑的唯一标准；在适当的时间内维持行动对于提供可信的行为也至关重要。
在这种情况下，我们可以通过将转换的 “威胁可见” 符号与追逐中看到 / 失去威胁的逻辑表示挂钩来解决这个问题，该逻辑表示将包括某种形式的过滤（使用滞后算法或其他类似方法），以避免产生不期望的振荡。图 11.6 显示了该逻辑表示产生的理想时间线版本。
11.3.2 难以统一
考虑到反应性和深思熟虑机制的不同性质，试图将它们统一起来非常具有挑战性：反应性主要是关于中断，而深思熟虑主要是关于维持状态。任何试图使用一个独特的模型来调和它们的尝试都是试图代表概念上的对立面。
图 11.7 表示了在 11.3.1 节中呈现的相同 FSM 示例，但包括两个反应状态：受伤和窒息。
因为追逐、巡逻、战斗和逃离是深思熟虑状态，设计为尽可能长时间保持活跃，所以它们随时可能被中断。这解释了为什么在图 11.7 中，我们可以看到每个深思熟虑状态都有向每个反应状态的转换。因此，向模型中添加新的反应状态将需要从所有现有的深思熟虑状态添加新的转换。向模型中添加新的深思熟虑状态时也是如此。随着复杂性的增加，很容易看出模型将难以理解和维护，主要是因为它试图在同一模型中混合两种非常不同的转换动态。为了解决这个问题，考虑使用多个可以相互交互的决策模型将是很有趣的。
11.3.3 使用多个决策模型
可以避免仅使用一个决策模型的限制。图 11.8 展示了一种允许使用多个决策模型的架构解决方案。设计原则非常简单：创建一个模块（行动选择器），负责充当深思熟虑和反应性模块之间的选择器开关。
通过这种架构解决方案，深思熟虑和反应性模块可以使用自己的决策模型，只要它们都能接收相同的刺激并输出各自的行动集。例如，深思熟虑模块可以使用图 11.4 中呈现的 FSM，而反应性模块可以使用非常简单的规则集或决策树来评估根据感知到的刺激应该请求哪种反应。至于行动选择器本身的实现，它也可以使用自己的决策模型，只要它能够在需要做出新决策时向深思熟虑模块发出信号，或者取消当前的深思熟虑行动以执行反应。图 11.9 显示了最终的时间线。
11.4 常见误区 #2：一个概念模型统治一切！
另一个常见的误区是，反应性和深思熟虑机制使用相同的概念模型来实现，以描述智能体在每种情况下必须如何行为。概念模型包括创建决策系统所需的所有概念的定义及其静态 / 动态关系。事实上，当仔细观察每个机制时，我们可以看到许多重要的区别，将在以下部分讨论。
11.4.1 意识与程序性知识
反应性与 “危险意识” 有关，而深思熟虑与程序性知识有关。反应在试图模仿与身体内部自我保护机制相关的生理反应的决策系统中起着重要作用。在 11.2.1 节中介绍了反应的两个主要类别：无意识反应和认知反应。无意识反应通常是身体为了促使个体从危险情况中退出而产生的。认知反应是主动的对应反应，个体将在某些事情威胁到其身体完整性之前先发制人地做出反应。
通过仔细观察这些生理现象，我们可以提取出有趣的设计要求：
・无意识反应的优先级高于认知反应。由于身体受到伤害（如疼痛、窒息或燃烧）而产生的反应优先于任何先发制人的反应。
・同时发生的无意识反应可以组合。不同的身体伤害可以同时发生，导致同时发生无意识反应。例如，一个窒息的个体可能同时被远程武器伤害。
・一些无意识反应比其他反应具有更高的优先级。一些关键的身体伤害，如被爆炸吹走或处于剧痛中，优先于不太关键的伤害。
・认知反应取决于危险意识的水平。根据个体是否预期到危险，它可能会或可能不会对某些刺激做出反应。例如，在斗殴中听到物体破碎的大声响不会让任何人感到惊讶，而在安静的教室中，这可能会引起巨大的惊讶反应。
深思熟虑与危险意识的概念没有同样的联系。事实上，深思熟虑是将这种危险意识概念与许多其他概念一起考虑，以执行对智能体重要但不一定危及智能体的任务。这意味着深思熟虑的主要焦点是知识，更确切地说，是程序性知识。程序性知识是执行任何任务所需的知识。当编程智能体在其环境中执行任务时，程序员实际上是使用各种决策机制对其所需的所有程序性知识进行编码。根据智能体试图实现的目标，可以使用不同的概念模型。例如，当智能体参与近距离战斗情况时，它不会使用与参与远程战斗情况时相同的决策规则。通常，这两种情况使用不同的概念来表示环境中重要的事物和使用的最佳策略。
11.4.2 使用多个概念模型
使用不同的概念模型通常可以将复杂性分解为更简单的模型。这意味着，通过使用正确的抽象级别，应该更容易编写更简单的规则和更简单的代码来维护。在 11.3.3 节中介绍的行动选择器就是这种方法的一个很好的例子。除了允许反应性和深思熟虑模块使用自己的决策模型外，它还允许它们独立使用自己的概念模型。使用行动选择器作为反应性和深思熟虑模块之间的序列器，还通过消除对深思熟虑概念模型的大部分依赖来简化反应性模块的实现，以选择每个反应后应遵循的深思熟虑行动（如图 11.7 所示）。
同样的推理适用于行动选择器的实现。它可以使用一些简单的规则来实现，因为它使用了正确的抽象级别。在这种情况下，行动选择器只需要与反应性和深思熟虑模块共享最小的概念集，即知道特定行动是反应还是深思熟虑行动。图 11.10 显示了根据其概念模型，行动选择器的预期时间线。
11.4.3 分离决策与执行
如 11.4.2 节所述，程序性知识是编程智能体执行某些任务（或行动）时的关键概念。事实上，程序性知识通常描述执行任务所需的两个方面：执行任务的决策模型（例如，行动序列、各种选项、如何管理事件等）和管理任务的决策模型（例如，开始条件、取消条件、完成条件等）。分离这些决策模型对于降低复杂性非常有用。
在图 11.4 中的 FSM 中，每个状态都描述了如果条件满足，智能体应该执行的任务。实际上，它并没有描述智能体在执行此任务期间将确切地做什么；它只描述了管理任务的决策模型。这意味着执行模型的细节可以以某种方式从决策模型本身抽象出来，而不会影响深思熟虑机制。这个想法已经被多次用于创建所谓的 “混合架构”[Murphy 01]。图 11.11 展示了一个基于 11.3.3 节中示例的混合架构的示例。
与 11.3.3 节中呈现的示例只有三个区别。第一个区别是，深思熟虑层明确使用决策模型来管理行动，而不是行动本身。第二个区别是，行动选择器的作用不仅是对行动进行排序，还必须从控制层的行动池中选择要执行的行动。最后一个区别是添加了控制层，其中包含一个行动池，其中包含要执行的必要实现。这些行动中的每一个都可以使用不同的决策模型和 / 或概念模型。如果它们各自的执行模型需要，它们也必须被设计为具有反应性。
这种架构非常强大，因为它提供了许多方法来将大型决策系统的复杂性分解为更简单的模块。例如，更改用于实现行动的特定算法而不影响其他行动或其他层的任何组件非常容易。向现有行动的概念模型中添加一个新的概念以增强其实现也可以代表对系统的非常孤立的修改。
11.5 结论
本文将深思熟虑和反应性机制作为设计决策系统时需要考虑的两个主要元素进行了介绍。通过理解它们的基本区别，讨论了如何降低决策系统的固有复杂性。因此，选择何时使用 FSM、BT、规划器或任何其他决策模型可以比纯粹的经验方法更容易，并且基于更坚实的基础。