# 三杠八、面向移动游戏的高效人群模拟
**格雷厄姆·彭特尼**

## 24.1 引言
人群模拟是游戏AI行业中不断探索和实验的主题[Pelechano et al. 07, Sung et al. 04]。现代游戏中越来越多的AI控制的智能体。因此，创建一个真实、健壮且对设计师友好的移动系统至关重要。
传统的寻路方法为每个智能体计算单独的路径，尽管许多路径可能有相似的部分。这些冗余的路径计算抑制了在移动硬件上对大量单位的模拟。
移动塔防游戏《坚守阵地2》（Fieldrunners 2）结合了矢量流场和转向行为，以有效地模拟数千个智能体，称为单位。本文将描述《坚守阵地2》中使用的流场生成、流采样和单位移动的系统。将从基础开始详细描述构建和平衡动态人群模拟系统的过程。

## 24.2 网格
网格提供了游戏世界的离散化，并定义了单位可以移动的区域。对于《坚守阵地2》，网格单元的大小略宽于最宽的单位，以便每个计算的路径都可以被每个单位穿越。每个网格单元可以是开放的，表示单位可以通过它，或者是阻塞的，表示该单元不可通行。

## 24.3 流场
单位沿着静态矢量流场在网格中移动。流场表示网格中每个单元到最近目的地的最佳路径方向，是连续流函数的近似。给定一组目的地点，流函数定义了归一化矢量的矢量场，指示到最近目的地的最佳路径的方向。该流函数类似于描述流体动力学中流的常用方法[Cabral and Leedom 93]，不同之处在于所有流矢量都是归一化的。根据这个定义，我们可以将流场定义为流函数的离散化。
流场以与标准寻路系统相同的方式引导单位到最近的目的地；然而，单位的路径信息被编码在流场中，消除了单位单独计算路径的需要。
矢量流场对于每组潜在目的地是特定的，因此可以被共享一组目的地点的所有单位使用。由于流场表示整个游戏世界的路径信息，除非网格的可通行区域或目的地点集发生变化，否则它不需要更新。
例如，如果横跨河流的桥梁被摧毁，流场只需要重新计算一次以考虑到可通行区域的变化。遵循该流场的单位将隐式地响应游戏世界的变化而改变它们各自的路径。
流场由每个网格单元的单个归一化矢量组成，如图24.1所示。流场和一组独特的目的地点一起称为路径。例如，对应于m×n网格的路径是m×n个归一化矢量的集合和一个或多个目的地点的集合。由于表示流函数所需的矢量数量，这种方法可能会导致过高的内存使用。内存消耗线性依赖于网格单元数量和独立路径数量的乘积。《坚守阵地2》中的地图最多限制为三条独特路径，并且地图网格尺寸足够小，以至于流场内存使用并未成为一个重要问题。
网格大小，从而流场的分辨率，不需要很高就能产生可信的移动特性。使用双线性插值，可以从低分辨率流场中的四个最近矢量近似出连续流函数[Alexander 06]。随着网格分辨率的提高，流场对同一流函数进行越来越高的采样。流场中矢量的双线性插值改善了单位路径的连续性和有机性。

## 24.4 生成流场
流场是通过修改后的传统点对点寻路函数生成的。《坚守阵地2》中使用的算法基于迪杰斯特拉算法（Dijkstra's algorithm）[Dijkstra 59]；然而，其他替代的寻路算法也能够生成流场。
《坚守阵地2》中使用的算法首先将每个路径目的地的网格单元添加到开放列表中。随着迪杰斯特拉算法的正常迭代进行，节点从开放列表中删除，并链接到具有最低计算路径成本的附近单元。当开放列表中的单元扩展时，新扩展单元的流矢量设置为指向它所链接的单元的方向。该算法不会在找到路径时终止，而是扩展添加到开放列表中的所有可通行单元，为每个单元分配一个流矢量，并在开放列表为空时终止。本书网站（http://www.gameaipro.com）上随本文提供的演示代码包含在GenerateFlowField()函数中流场生成的完整实现。
每当路径的目的地集或网格的可通行区域发生变化时，前面的算法用于为每个路径生成流场。

## 24.5 单位
《坚守阵地2》需要一个能够支持数十种不同单位的人群动力学系统，每个单位都具有独特的移动特性。《坚守阵地2》中的单位是基于克雷格·雷诺兹（Craig Reynolds）的Boid模型的简单自主智能体[Reynolds 99]。每个单位都有一组物理属性和转向行为，共同控制其移动。
此图显示了作用在左侧单位上的所有转向力，但不包括流场跟随。
转向行为的集合及其实现在所有单位类型中都是一致的。单位的物理属性（例如，总质量、大小、敏捷性）定义了其独特的移动特性。
《坚守阵地2》中的单位表示为具有相应速度的点质量。单位的转向行为通过向其施加一组力来控制点质量。这些转向力的优先组合赋予单位加速度，从而产生真实、感知上智能的移动。转向行为在游戏中广泛用于控制单位移动，并在许多出版物中进行了描述[Reynolds 99, Millington and Funge 09]。在《坚守阵地2》中，对一些转向行为的标准实现进行了特定修改，以支持更动态的单位交互。
《坚守阵地2》中的单位使用五种转向行为的有限、贪婪、优先求和（其中四种如图24.2所示）。按优先级降序排列的五种行为包括流场跟随、避障、分离、对齐和凝聚。在每个模拟步骤中，单位仅受指定的总转向力大小的影响。转向行为产生的力按优先级顺序添加到运行总和中，直到达到最大大小。任何未添加到总和中的转向力都将被忽略。
分离、对齐和凝聚转向力共同描述了群聚行为[Reynolds 99]。在《坚守阵地2》中，群聚用于鼓励单位在靠近其他单位时作为一个群体凝聚地移动。
避障有助于更快的单位智能地绕过较慢的单位。避障和分离行为的实现与雷诺兹的原始实现略有不同[Reynolds 99]。避障转向行为产生一个与单位速度垂直的“侧步”力，该力与邻居的位置和相对速度成比例。分离转向行为产生的力根据邻居的动能与该力应用的单位的动能之比进行缩放。质量和速度较小（大概更灵活）的单位将更容易让位于更大、更不易操纵的单位。
最后，流场跟随使单位沿流场指定的方向移动。通过对单位位置的四个最近流矢量进行线性插值来计算流场方向。
质量、最大力、最大速度和邻居半径属性描述了单位的独特行为。质量除了用于计算转向行为导致的加速度外，还用于计算单位的动能。最大力值决定了在单个模拟步骤中可以影响单位的转向力的最大组合大小。单位的敏捷性值定义为单位的最大力与其质量的比值 - 单位的最大加速度。最后，最大速度属性限制了单位速度的大小，邻居半径属性将用于计算群聚力的邻居集限制在一定半径内的邻居。

## 24.6 调整单位移动值
为单位找到正确的属性值集以产生所需的行为是必要的。在基于转向行为的模拟中，这是众所周知的困难和艰巨的。设计师开发并使用了一种系统方法来平衡《坚守阵地2》中的单位属性。为了简单起见，所有单位使用相同的加权、优先转向行为集，依靠其物理属性实现独特行为。
首先，将最大速度属性设置为合理的值，其余属性给予任意的基础值。因为单位的最大速度最容易可视化，所以它提供了一个很好的起点。其余的值将分别进行调整。
接下来，调整最大力值以产生该类型单个单位的可信移动特性。因为最大力影响单位的敏捷性，它将改变视觉方面，如转弯速度和制动。
对于一组同质单位，改变单位邻居半径属性的结果可以很容易地单独观察到。较小的邻居半径将允许单位更紧密地聚集，而增加邻居半径将使单位分散。
最后，所有单位的质量相对于彼此进行调整。在调整单位质量时，其敏捷性必须保持不变，否则单位先前调整的移动特性将发生变化。

## 24.7 移动限制和性能考虑
这种方法中最大的运行时性能问题是生成和处理用于计算群聚转向力的相邻单位列表。在《坚守阵地2》中，通过使用松散四叉树[Ulrich 00]来减少相邻单位搜索空间，缓解了性能问题。具有大邻居半径的单位将产生大量需要考虑的邻居，从而降低性能。组合群聚力的计算可以提供可测量的性能改进，因为中间值可以在后续计算中重用。
移动处理器上的浮点运算可能很慢，减少路径和移动计算中所需的操作数量也可以带来改进。在《坚守阵地2》中，常见的优化是将表示矢量大小的标量存储为其各自平方值。这允许使用平方矢量大小进行矢量长度比较，无需计算许多浮点平方根值。
基于流场的系统在大量单位需要导航到一组共同目标时提供最大的好处。每个单位的独特目标位置集都需要一个单独的流场。随着独特目标集的数量增加，维护必要流场所需的计算和内存可能会变得过于复杂和庞大。表示流场所需的内存随着网格单元的数量线性增长，而寻路计算复杂度相当于所使用的寻路算法的最坏情况复杂度。在《坚守阵地2》的情况下，使用了迪杰斯特拉算法，这导致了依赖于网格单元数量的准线性时间复杂度。最小化流场内存消耗的一种方法是将流矢量保存为“北”矢量的特定旋转（通常为<0,1>）。当访问给定单元的流方向时，重新创建已知的基矢量并旋转该单元特定的量。或者，如果流矢量限制为特定方向（例如，基本方向），它们可以存储为一个字节的整数，其值对应于特定的潜在方向。
随着移动硬件向多核处理器发展，正确利用多线程算法变得重要。生成多个流场的问题可以很容易地建模为并行过程。流场的相互独立性允许它们与其他流场并行计算，可能在不同的线程或进程中。转向行为的组合和独立性也允许它们并行计算，只要它们被累积并集体应用于单位。总之，流场生成和转向行为计算的内在并行性使得多线程优化变得微不足道。

## 24.8 好处
由于它提供的一组独特好处，《坚守阵地2》选择了这种单位移动方法。路径信息被预计算并存储在流场中；因此，对于给定的世界配置，它只计算一次。流场的这一特性在《坚守阵地2》中提供了显著的性能优势，因为世界的可通行性很少被修改。
世界上所有位置的路径信息在一次遍历中计算，产生与迪杰斯特拉算法相当的基于网格大小的复杂度。与传统寻路方法相比，时间复杂度与单位数量呈线性关系，这种方法与模拟的单位数量呈常数关系。对于《坚守阵地2》，这使得具有数千个独立和多样化单位的复杂场景能够在移动设备上以交互式帧率运行。
像这样基于转向行为的方法在定义独特单位行为方面提供了很大的灵活性。转向行为依赖于组合来定义复杂行为，使专业化和添加模块化和封装。新转向行为的组合或现有转向行为的修改都可以轻松应用于单位以定义独特的移动风格。

## 24.9 结论和未来工作
《坚守阵地2》中使用的系统使用静态矢量流场和转向行为在移动设备上模拟数千个单位。与传统寻路技术不同，所提出的导航系统通过将所有区域的路径信息编码在矢量流场中来最小化冗余路径计算。
基于流场的寻路技术提供了一种独特的方法来减少冗余的寻路计算，通过计算从每个点的最佳路径。《坚守阵地2》中使用的流场生成技术基于迪杰斯特拉算法，出于简单性和设计原因。更先进的寻路算法，如Theta*[Nash et al. 07]，可以生成更平滑、更有机的流场。流场可以通过混合静态和动态流场来扩展，以纳入单位的替代动机和关注点[Alexander 06]。尽管有这种潜在的改进，静态流场和转向行为为《坚守阵地2》提供了强大、真实的人群模拟。
