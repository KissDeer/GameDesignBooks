# 三杠二、选择搜索空间表示
**内森·R·斯特尔特万特**

## 目录
## 18.1 引言
游戏中路径规划架构的选择将有助于确定游戏能够轻松支持哪些功能，以及哪些功能需要付出巨大努力来实现。有一些很好的文章描述了不同类型的路径规划架构[Tozour 04]，并且在不同的论坛上也有关于路径规划架构正确选择的辩论[Tozour 08, Champandard 10]。每种选择都有其自身的优点和缺点，其优势的强弱将取决于正在开发的游戏类型和分配给开发架构的时间。本文的目标是总结和扩展针对不同架构的一些论点。

需要知道的是，对于大多数游戏来说，所有可行的路径规划架构都是游戏中角色可以行走的空间的抽象。这是因为用于模拟世界的物理原理并没有直接用作路径规划的表示。因此，在某种意义上，这里的许多争论都与哪种表示最接近游戏世界的底层物理原理有关。

本文重点关注主要的表示形式：网格、航路点图和导航网格。我们假设大多数读者熟悉这些表示形式，因为它们可能是当今最常用的架构。此外，在本书中可以找到其中几种架构的示例。但是，作为参考，图18.1（a）显示了一个示例地图。图18.1（b）显示了地图的网格分解，图18.1（c）显示了地图上的航路点图，图18.1（d）显示了三角形分解，这是一种导航网格。本文主要面向独立或小型开发人员，因为他们更有可能在使用的架构上有选择。

## 18.2 任务
首先，我们简要强调在比较路径规划表示时将考虑的特征。这些特征包括内存使用、本地化的容易程度、规划、平滑、路径跟踪和表示的动态修改。我们还讨论了实现所需的时间。

内存使用仅通过在内存中构建和存储地图表示的开销来衡量。本地化是从空间坐标移动到路径规划表示所特有的表示的过程。例如，当用户点击鼠标时，记录点击的坐标。然后，必须将其转换为导航网格中的网格单元或多边形。规划是在两个位置之间找到有效路径的成本。平滑和路径跟踪是获取规划路径并去除尖锐转弯或不连续性以提高整体质量的过程。这可以作为规划的一部分、规划后或角色跟踪路径时进行。动态修改是在游戏进行时对表示进行更改的成本。

请注意，这些任务的具体组合取决于正在创建的游戏，因此下面每个论点的权重取决于每个任务在您的游戏中的重要性。例如，网格对于塔防游戏是一种合适的表示，但MMORPG中的大型开放世界通常对于网格来说太大。

除了用于路径规划的空间表示外，该表示还经常用于更通用的查询，以促进AI行为。这些可能包括战斗中的定位、新建筑建造的最佳位置或战斗中最受保护的位置。这些查询取决于游戏，因此我们不会直接考虑它们。

## 18.3 网格
网格的最简单实现是通过一个表示阻塞和非阻塞单元格的数组来表示世界。更复杂的实现可以包括关于坡度、地形类型或其他对规划有用的元信息的信息。网格传统上仅表示二维世界，但也可以用于表示三维世界[Sturtevant 11]。

优点：
- 网格是最简单的表示形式之一，易于实现。一个可行的实现可以在几个小时内完成。
- 网格表示可以使用文本编辑器在外部轻松编辑。这可以节省大量的工具构建工作[Van Dongen 10]。
- 网格中的地形成本易于动态更新。例如，在《龙腾世纪：起源》中，玩家检测到的陷阱可以很容易地在相关网格单元中用几个位标记。A*在规划时很容易考虑这些成本，尽管如果太多单元格被重新加权，规划的成本会增加。
- 网格中的可通行单元格可以以类似更新地形成本的方式快速修改。
- 在网格中进行本地化很容易，只需将坐标除以网格分辨率即可返回本地化的网格单元。

缺点：
- 在大世界中，网格内存密集。请注意，当世界很大但可步行空间相对较小时，可以使用稀疏表示[Sturtevant 11]。
- 网格移动中通常会出现特征性的45°和90°角，因此通常必须进行路径平滑，尽管也可以使用任意角度的规划方法[Nash et al. 07]。
- 由于世界的细粒度表示，网格中的路径规划可能很昂贵。可以使用某种形式的抽象来解决这个问题[Rabin 00, Sturtevant 07]。
- 网格世界通常包含许多对称路径，这可能会增加路径规划的成本。可以使用一些技术来避免这种情况（例如[Harabor and Grastien 11]），但也可以通过不同的状态表示来避免。

## 18.4 航路点图
航路点图将世界表示为抽象图。重要的是，航路点图在图中的节点和可步行空间之间没有明确的映射。在导航网格流行之前，航路点图被广泛使用。虽然它们因其缺点而受到批评[Tozour 08]，但也因其优点而受到赞扬[Champandard 10]。

优点：
- 航路点图相对容易实现。
- 如果更改是提前知道的，航路点图很容易修改。例如，如果世界中的门关闭并上锁，开发人员可以很容易地标记穿过门开口的图中的边缘，并在门关闭时阻止它们。
- 航路点图只表示网格中发现的点的一小部分。这种可步行空间的稀疏表示既易于存储，又导致廉价的路径规划请求。

缺点：
- 如果图中没有足够的可步行边缘，路径质量可能会受到影响，但过多的可步行边缘会影响存储和规划的复杂性。
- 航路点图可能需要手动放置节点以获得良好的路径质量。
- 在航路点图上进行本地化需要在游戏空间和图之间进行映射。如果一个角色被从图中撞出，可能不清楚该角色在航路点图中实际应该在哪里。
- 由于没有底层状态空间的显式表示，在航路点图外进行平滑可能会导致角色卡在物理或其他对象上。
- 如果动态变化不是提前知道的，那么处理起来会很困难。如果一个角色可以在墙上意外地创建一个洞，那么航路点图上需要新的连接。然而，检查所有附近的连接以验证它们是否由于地图的变化而变得可通行可能会很昂贵。

## 18.5 导航网格
导航网格使用凸多边形来表示世界[Tozour 04]。导航网格的一个特殊情况是约束Delaunay三角剖分[Chen 09]，其中世界仅由三角形表示。请注意，网格也可以看作是导航网格的一种特殊情况，因为这两种表示都使用凸多边形，但它们在实践中的用法有很大不同。

优点：
- 多边形可以比网格更准确地表示世界，因为它们可以表示非网格对齐的世界。
- 由于多边形的准确表示，在移动之前和移动期间更容易正确进行平滑。这种准确性还可以用于更严格的动画约束。
- 导航网格上的路径规划通常很快，因为世界的表示相当粗糙。但是，这不会影响路径质量，因为角色可以自由地以任何角度行走。
- 导航网格不像网格那样内存密集，因为它们可以用几个多边形表示大空间。

缺点：
- 实现导航网格所需的时间很长，尽管有很好的开源实现可用[Mononen 11]。
- 导航网格通常需要几何算法，在特殊情况下可能会失败，例如平行线，这意味着实现更加困难[Chen 09]。
- 与网格世界的更改相比，导航网格的更改可能难以或昂贵地实现。
- 如果实现不佳，在导航网格上进行本地化可能会很昂贵。良好的实现将使用额外的数据结构，如网格，来加速该过程[Demyen 06]。

## 18.6 结论
总之，每个路径规划架构都有其自身的优点和缺点。架构的选择应取决于正在开发的游戏类型、已有的工具以及实现和调试的可用时间。许多游戏引擎都带有自己的路径规划表示，但对于必须执行新实现的情况，我们总结其优缺点如下：

网格在地形基本为2D、实现时间有限、世界动态以及有足够内存时最有用。它们不太适合非常大的开放世界游戏，或需要高质量动画的可步行空间的确切边界的游戏。

航路点图在实现时间有限、需要快速路径规划以及不需要准确表示世界时最有用。

导航网格在有足够的时间进行测试和实现时最佳。如果实现得好，它们是可能的实现中最灵活的，但对于较小的项目可能会过度。

最终，最好的表示是能够最大限度地减少开发人员的努力，并帮助使游戏体验尽可能引人入胜的表示。这在任何游戏中可能都不同，但了解每个架构之间的权衡将帮助您在任何新项目中做出最佳决策。
