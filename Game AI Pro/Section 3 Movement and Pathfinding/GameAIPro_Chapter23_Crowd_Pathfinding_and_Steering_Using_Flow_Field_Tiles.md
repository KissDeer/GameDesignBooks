# 三杠七、使用流场瓦片的人群寻路与转向
**以利亚·爱默生**

## 23.1 引言
使用流场瓦片进行人群寻路和转向是一种解决在大型地图上移动数百至数千个个体智能体的计算问题的技术。通过使用动态流场瓦片，可以实现更现代的转向管道，具有避障、群聚、动态编队、人群行为以及支持任意物理力量等功能，同时避免了为每个智能体重复重建个体路径的沉重CPU负担。此外，尽管路径复杂，智能体仍能立即移动，为AI和玩家提供即时反馈。

## 23.2 动机
在开发《最高指挥官2》时，我们的任务是改进移动和寻路行为。与许多具有寻路功能的游戏一样，《最高指挥官》中的每个单位都会沿着固定的单向A*路径移动。最终，单位会与其他单位发生碰撞，特别是在编队移动或进入战斗时。当路径交叉且单位碰撞时，现有代码会停止单位并等待冲突解决，而不是围绕障碍物重建新路径。这是因为每次发生碰撞时重建路径会变成一个复合问题，特别是在大型战斗中，新路径可能会导致第二次和第三次碰撞，导致游戏停滞不前。这种行为在一千个单位中重复发生，控制这些单位的玩家都在疯狂地点击彼此的单位，本质上是在乞求它们相互冲突和碰撞。

为了克服这个路径重建问题，所有的移动都被设计为倾向于保持在同一路径上，导致物理、编队、AI、命中反应等方面受到限制。这样，寻路限制了整个用户体验。

由于《最高指挥官》的单一路径寻路解决方案，玩家在地图上移动单位时会照看它们。他们会花费时间观察和点击，观察和点击，以帮助他们的单位应对游戏中不断变化的障碍物和环境。

## 23.3 世界布局
在《最高指挥官2》引擎中，世界被分解为包含网格方块的各个扇区，每个网格方块为1×1米，每个扇区包含10×10个网格方块。还有门户窗口，每个门户窗口跨越扇区边界。图23.1展示了一个示例。

在图23.1中，扇区通过可通行的门户窗口连接。门户窗口在扇区边界两侧的墙壁处开始和结束。每个窗口侧有一个门户，每个门户中心是一个N路图中的节点，其边缘连接到可通行的、同一扇区的门户。

## 23.4 三种场类型
对于每个10×10米的网格扇区，有三种不同的10×10米的2D数组，或数据场，被该算法使用。这三种场类型是成本场、积分场和流场。成本场为每个网格方块存储预定义的“路径成本”值，并在构建积分场时用作输入。积分场为每个网格位置存储积分的“到目标的成本”值，并在构建流场时用作输入。最后，流场包含路径目标方向。以下部分将更详细地介绍每个场。

### 23.4.1 成本场
成本场是一个8位场，包含0 - 255范围内的成本值，其中255是一个特殊情况，用于表示墙壁，1 - 254表示遍历该网格位置的路径成本。不同的成本可以用于表示斜坡或难以移动的区域，如沼泽。成本场的每个网格位置至少有一个成本；如果该位置有额外的成本，则将其添加到一个成本中。

如果一个10×10米的扇区没有任何成本，则会引用一个全局静态的“清晰”成本场，该成本场充满了一。这样，您只需要在包含唯一数据的成本场上花费内存。在即时战略游戏中，有惊人数量的清晰扇区。在《最高指挥官2》中，由于广泛的开放和平坦地区、湖泊和海洋，我们大约有50 - 70％的可通行空间被标记为清晰。

成本场数据由我们的编辑器预先构建，它将墙壁和几何斜坡转换为成本值。我们的设计团队还可以可视化此路径成本信息，并对其进行更改。

### 23.4.2 积分场
积分场是一个24位场，其中前16位是总积分成本量，后8位用于积分标志，如“活动波前”和“视线”。您可以选择使用32位浮点数来表示积分成本，使其成为40位场，以花费更多内存来获得更好的流结果。

### 23.4.3 流场
流场是一个8位场，前四位用作指向方向查找表的索引，后四位作为标志，如“可通行”和“具有视线”。流场包含智能体转向管道用于绕过山丘和墙壁朝向路径目标流动的所有主要方向和标志。

## 23.5 路径请求
一旦您有一个有效的目标位置和一个或多个源位置，您就可以创建一个路径请求。路径请求将首先通过门户节点图运行A*。A*步行者从源位置开始，穿过门户节点，到达目标，从而产生一个“下一个”门户节点的链表。这个过程与下一个路径请求源继续，但这次门户步行者运行“合并”A*，其中步行者更喜欢停止并指向先前行驶的门户节点以“合并”与先前的A*结果。使用“合并”A*，您更有可能共享流场结果，并且源更有可能更接近地路径，这是选择多个源向单个目标移动时所需的行为。

如果您的A*到目标的路径成功，下一步是遍历您的下一个门户节点列表，并为每个节点提交一个流场请求。此时，您已经完成了路径请求，并且由于您只使用合并A*遍历了门户节点图，因此您使用了非常少的CPU。

## 23.6 积分器
我们将积分器定义为负责接受单个流场请求，并在一个或多个滴答内构建单个流场瓦片的类。这是通过将请求的成本场数据以及请求的“初始波前”作为输入来实现的。初始波前是目标位置的列表，每个位置都有一个预定义的积分成本值。

积分器接受初始波前并使用Eikonal方程[Ki Jeong 08]向外积分。想象一下触摸静止的水，创建一个在水面上移动的涟漪波的效果。积分器的活动波前在穿越可通行表面时的行为类似，同时将越来越大的积分成本值设置到积分场中。它重复这个过程，直到活动波前通过撞击墙壁或扇区边界而停止移动。为了更好地理解积分过程，让我们回顾一下积分器的积分步骤。

### 23.6.1 积分步骤1：重置积分场
积分器的第一步是重置其积分场值并应用初始目标波前。如果请求的流场具有最终的1×1目标，则其初始目标波前是一个单独的1×1位置，具有零积分成本值。但是，如果流场请求来自10×1或1×10门户，则将有十个目标位置，具有十个不同的积分成本目标。

为了获得更高质量的流结果，您可以在门户路径中至少提前集成一个流场。然后，您可以将先前积分的成本作为您的初始门户窗口成本进行结转，而不是使用零，有效地使跨边界的流无缝。这种质量改进的代价是使流瓦片顺序依赖，因此更难被其他路径请求重用。

### 23.6.2 积分步骤2：视线传递
如果我们从实际路径目标进行积分，那么我们首先运行视线（LOS）传递。我们这样做是为了在路径目标附近获得最高质量的流方向。当智能体在LOS内时，它可以完全忽略流场结果，而只是朝着确切的目标位置转向。如果没有LOS传递，由于积分器只查看上、下、左、右四个邻居，您可能会在目标周围出现菱形的流方向。

通过在成本积分传递期间查看所有八个邻居，可以改善目标周围的流，但我们不建议这样做；标记LOS是廉价的，并且在LOS内，通过完全忽略流场，您可以获得最高质量的路径方向。

要集成LOS，您可以像往常一样让初始目标波前向外积分，但是，与其比较成本场邻居成本来确定积分成本，只需在移动波前时将波前成本增加一，并将该位置标记为“具有视线”。这样做直到波前遇到任何成本大于一的东西。

一旦我们遇到成本大于一的东西，我们需要确定该位置是否是LOS角落。我们通过查看该位置的邻居来做到这一点。如果一侧的成本大于一，而另一侧的成本不大于一，我们就有一个LOS角落。

对于所有LOS角落，我们从网格方块的外边缘位置开始构建一条2D线，朝着远离目标的方向。使用Bresenham的线算法沿着网格跟踪这条线，将每个网格位置标记为“波前阻塞”，并将该位置放入第二个活动波前列表中，稍后由成本积分传递使用。通过将每个位置标记为“波前阻塞”，LOS集成波前将沿着标记目标可见边缘的线停止。

您可以通过在门户窗口位置携带“具有视线”和“波前阻塞”标志来将LOS角落线穿过扇区边界。然后，当您构建邻居的积分场时，对于每个具有“波前阻塞”标志的门户窗口位置，将其视为到目标的LOS角落，并相应地构建其余的线。这将使LOS在扇区边界上无缝。

继续向外移动LOS传递波前，直到它通过撞击墙壁或具有“波前阻塞”标志的位置而停止移动。除了使用Bresenham的线算法花费的时间外，LOS第一次传递非常便宜，因为它不查看相邻的成本值。波前只是设置标志，偶尔检测角落并在线上迭代。

图23.2展示了LOS传递的结果。每个清晰的白色网格方块都被标记为“具有视线”。每个LOS角落都有一条线，与该线重叠的每个网格方块都被标记为“波前阻塞”。

### 23.6.3 积分步骤3：成本积分传递
我们现在准备进行成本场积分。与LOS传递一样，我们从活动波前列表开始。这个活动波前来自于先前LOS传递的“波前阻塞”位置的列表。这样，我们只积分从目标不可见的位置。

我们将这个波前向外积分，直到它通过撞击墙壁或扇区边界而停止移动。在每个网格位置，我们通过将最便宜的成本场和积分成本场的上、下、左或右邻居的成本相加来计算积分成本。然后重复这个Eikonal方程过程，将波前向外移动到每个位置的未积分、非墙壁邻居。

在积分过程中，注意由于小的成本差异而导致的先前积分结果的重叠。为了解决这个昂贵的行为，确保您的波前在遇到先前积分的结果时停止，除非您在积分成本上确实有显著差异。如果您不这样做，您可能会面临波前来回反弹的风险，在不必要的情况下消耗结果。换句话说，如果一条不同的路径稍微便宜一些，那么不要费心在场上回溯，只是为了节省那小小的寻路成本差异。

以下是一个适当重叠先前积分成本结果的示例。想象一条单一路径分成两条路径，每条分割路径都通向相同的目标位置。然而，一条分割路径有一个漫长而昂贵的沙坑，而另一条则没有。积分波前将远离目标，分成两条，并在路径的开头相互汇聚。当它们相遇时，更便宜的波前将重叠更昂贵的波前的结果，并继续积分，回溯到昂贵的路径，直到更便宜的积分成本与先前积分的成本没有显著差异。这种回溯行为将具有将流场方向从沙坑重定向到更便宜路径的效果。这与A*中的回溯没有什么不同；只是指出这种行为是好的，因为在积分场时它更昂贵。

### 23.6.4 积分步骤4：流场传递
我们现在准备从我们新创建的积分场构建流场。这是通过遍历每个积分成本位置并写出LOS标志或比较所有八个NW、N、NE、E、SE、S、SW、W邻居来确定我们应该为该位置采取的“最便宜”方向来完成的。

图23.3展示了最终的流场方向。请注意，对于具有目标LOS的位置或清晰瓦片内的位置，没有进行任何工作。一旦构建了流场，我们将其提交到流场缓存中。

## 23.7 流场缓存
流场缓存包含我们所有构建的流场，每个流场都有自己基于其带您通过的门户窗口的唯一ID。这样，尽管目标不同，但工作可以在路径请求之间共享。

如果您的地图中有一个双向走廊，很有可能多个路径将需要相同的走廊流场结果。流场也可以被引用跟踪，因此当没有更多引用时，它可以被丢弃或放在定时器上稍后丢弃。您还可以预先构建所有流场排列并将它们存储在磁盘上，这样您只需要构建具有自定义LOS目标信息的流场。

## 23.8 支持动态环境和查询
发明这种技术的全部意义在于实时更好地处理我们游戏环境的动态性质。为此，我们在构建一切时都考虑到了动态变化。

如果智能体的位置移动到计划路径中的扇区之外，我们可以通过在门户节点上运行另一个“合并”A*来轻松支持移动源。

我们通过重建目标的流场来支持移动目标。如果目标越过扇区边界，则在幕后重建路径的门户节点。新路径请求的大多数流场已经构建并将在缓存中，因此很少需要重建流场。一旦新路径准备就绪，智能体将从旧路径无缝切换到新路径。

我们通过标记包含它们的扇区及其相关门户的成本场为脏来支持更改墙壁和山丘。然后，为位于脏扇区边界及其邻居上的节点重建门户图。最后，重建受这些更改影响的路径。

所有这些都是通过标记事物为脏并根据优先级队列重建它们来完成的，其中队列中的每个项目都被给予固定毫秒数的时间片。这使我们能够控制随着时间的推移重建的内容、时间和方式。

## 23.9 成本印章支持
成本印章代表一组自定义的成本值，您可以“盖章”到世界中。在《最高指挥官2》中，我们需要放置具有自定义墙壁以及自定义可通行区域的建筑物。玩家可以通过使用不同大小的结构，包括1×1网格墙壁，基本上绘制出全新的可通行景观。

成本印章在替换它们之前记录原始成本场值。放置成本印章后，重叠的扇区将被标记为脏，动态图和路径重建过程将处理其他一切。

## 23.10 源成本数据
地图编辑器将通过查看几何形状构建成本场数据，在适当的地方放置墙壁和山丘。我们会运行一个模糊传递，在墙壁附近添加成本梯度，以改善在走廊和锯齿状边缘周围的流结果。

所有成本数据也在编辑器中显示，以便设计人员可以根据需要手动添加和删除路径成本。这对设计团队来说是一个巨大的好处，因为他们终于可以控制单位在他们的地图上的移动位置和方式。

## 23.11 不同的移动类型
《最高指挥官2》引擎中的每个智能体都有自己的移动类型。每个移动类型都有自己的成本场数据，因此产生自己的门户图。这样，仅能在陆地上行驶的坦克将与可以在湖泊和沼泽上行驶的气垫船有不同的路径。

编辑器将为每个移动类型构建不同的成本数据。为了支持大型单位，在地图上运行了一个特殊的墙壁缓冲过程，将墙壁向外移动。这具有关闭对于大型单位来说太小的狭窄间隙的效果，并将墙壁和山边推出，以便大型单位在附近时不会在视觉上重叠它们。

如果用户选择了具有不同移动类型的单位，例如一队喷气式飞机、一些仅能在陆地上行驶的坦克、一些气垫船和一个超级大型实验机器人，游戏将在为不兼容单位构建更多路径之前，为所有兼容单位使用“最严格限制移动类型”的路径。

## 23.12 使用流场的转向
当智能体使用流场转向时，有一些需要注意的if - else条件。首先，如果智能体没有有效的流场，它应该转向下一个门户位置。一旦智能体有了流场，它应该寻找LOS标志以转向其目标；否则，它应该使用指定的流场方向。

当智能体接收新的流场方向时，我们建议存储一个路径方向向量，并在穿过网格方块时融入新的流方向。这具有在智能体穿越场时平滑流场方向的效果。

## 23.13 墙壁和物理
使用流场，您的寻路智能体可以在任何方向移动，而无需重建路径的高昂费用。一旦您的智能体在任何方向移动，它们必然会撞到墙壁或其他智能体。在《最高指挥官2》引擎中，智能体可以相互推挤，也可以沿着墙壁滑动使用物理。

在我们的游戏中拥有物理允许新的游戏玩法场景，例如将单位推回的爆炸或可以推回一百辆坦克的超级大型机器人。我们有一个结构可以任意地在地图上推拉单位，以及一个可以将单位吸入旋风中，将它们旋转直到它们撞在一起的大型单位。如果没有使用流场瓦片相关的更便宜的移动成本，这些新的游戏玩法场景是不可能的。

## 23.14 岛屿场
可以实现一个可选的岛屿场类型，其中包含岛屿ID，每个岛屿ID代表一个单独的可通行岛屿。想象一下夏威夷的不同岛屿：如果您在一个岛屿上，您只能开车到同一岛屿内的位置。

对于每个扇区，您存储其岛屿ID。如果扇区中有多个岛屿ID，则该扇区具有一个岛屿场，将ID分解为单个网格位置。有了这些信息，您可以快速确定路径请求是否有效。

在《最高指挥官2》引擎中，您可以将鼠标移动到地图上的任何位置，并看到鼠标图标从箭头变为停止标志，表明您无法到达该位置。此功能是通过检索源和目标位置的岛屿 ID 来查看它们是否匹配来实现的。
23.15 最小化 CPU 占用
您可以通过限制每滴答提交的瓦片或网格方块的数量来强制低 CPU 使用。您还可以轻松地在线程之间分散积分工作，因为积分场内存与其他所有内容分开。
23.16 未来工作
以下是进一步改进此技术的一些想法。
通过跨重叠扇区连接门户图节点来支持 3D 空间。
预处理并压缩所有流场排列并从磁盘流式传输它们。
通过使用扇区层次结构和 N 路图来添加对任意大小地图的支持。
使用 GPU 而不是 CPU 构建流场 [Ki Jeong 07]。
支持多个目标。多个目标流场非常适合僵尸追逐英雄。
23.17 结论
我们在《最高指挥官 2》上的工作表明，超越单一路径解决方案并开始研究基于场的解决方案以支持即时战略游戏中数百至数千个智能体的动态人群路径和转向是有利的。在本文中，我们展示了如何表示和分析可通行地形以生成可以驱动数百个单位到达目标的流场。此外，我们表明，与单个单位寻路请求相比，这种方法在计算上是廉价的，即使面对动态地形和查询也是如此。希望您能从我们在《最高指挥官 2》引擎中的经验中受益，并在您的下一个游戏中继续扩展和改进基于场的寻路。