# 五杠五、一个简单实用的社会动态系统



作者：Phil Carlisle

## 35.1 引言



当前拥有大量角色的游戏存在的一个问题是，它们往往没有描绘出在现实世界的任何社会群体中常见的许多协调互动，例如朋友在派对上聚在一起，或者久别重逢的亲人相互拥抱。社会互动是我们理解社会群体结构的重要组成部分，为了使游戏世界的体验更引人入胜，我们明智的做法是描绘这些互动。



本文将描述一个基于模块化组件的社会动态实现，这些组件共同构成一个系统，使角色能够参与并描绘社会互动。在行为树、黑板、动画和运动控制器等常用组件的基础上，我们将讨论社会情境中常见的非语言行为方面，并提供源代码示例和实际实现细节。

## 35.2 观察的重要性



当动画师制作角色时，他们通过实现自己观察到的动作来进行创作，这些观察要么来自他们自己的经验，要么来自看到其他类似角色。



同样，这里实现的许多方法旨在重现学者和动画师所观察到的社会互动方面。所有这些工作的基础是这样一个观念：对互动的观察是我们能够实现它们的关键。如果我们要在角色中近似呈现生命的幻觉，就必须研究生活。



对创建可信角色感兴趣的 AI 程序员强烈建议成为人类互动的敏锐观察者。发现能够帮助展现任何特定关系或社会动态的微妙互动相对容易，特别是如果我们拍摄一些这样的互动并稍后分析视频的话。适合在不被察觉的情况下捕捉社会互动的小型数码相机相对便宜，并且在处理任何特定场景时是一个强大的工具。

## 35.3 什么是社会动态？



社会动态是指两个或多个角色之间必须实时发生的任何社会互动。通常，互动涉及空间位置、时间和方向等元素，因此称为 “动态”。有许多不同的元素可以归类为社会动态，它们中的每一个都可以为角色的更可信的社会互动做出贡献，最终增加游戏世界的可信度。



典型的例子有：

### 35.3.1 注视控制



通过观察角色的脸，我们可以了解很多关于他们的信息。我们理解的一个关键方面是，如果一个角色正在注视（看）一个物体，那么它很可能意识到那个物体。注视的另一个方面是它将我们的注意力集中在对角色重要的事物上。例如，如果一个角色长时间注视另一个角色，我们可以理解这个角色对另一个角色感兴趣。这对于向玩家表明一个角色被另一个角色吸引是有用的。同样，如果我们看到一个角色突然朝某个方向注视，我们也可能应该朝那个方向注意，这对于将玩家的视线引向特定的视觉事件是有用的。

### 35.3.2 空间距离控制



当我们与其他人互动时，我们倾向于根据我们对他们的熟悉程度、我们是否喜欢他们等因素与他们保持特定的距离。这个研究领域在社会心理学中被称为空间距离学，它很重要，因为它为我们提供了一个人类在任何社会群体中如何移动的模型。



作为人类，我们在不同的社会互动中保持一个偏好的距离。例如，在社交聊天时，我们有一个相对宽松的距离，但当试图与某人亲密接触时，我们通常会靠得更近，通常在容易接触的范围内。我们应该关注空间距离学，因为它为我们形成小型社会群体提供了一个总体指导，特别是在空间方面。读者可以参考 Claudio Pedica 关于在游戏中应用这种空间距离的一篇有用的论文 [Pedica 和 Vilhjálmsson 08]。

### 35.3.3 姿势



当与他人互动时，我们通常会根据互动的性质和我们与他们的关系采取特定的姿势。在与朋友聊天的情境中，我们可能会采取放松的姿势，手臂放在身体两侧或做手势。我们可能也会站得更宽，并且通常会向我们感兴趣的人倾斜。相反，如果我们遇到一个对我们有权威的人，或者处于一个要求我们克制行为的社会压力角色中，我们可能会通过采取更封闭的姿势来表现这一点，双脚更稳地站立且靠得更近，背部挺直甚至稍微向后倾斜。这些相对微妙的姿势变化可以在社会互动中用来表示角色之间的差异。此外，我们的姿势也会影响我们行走时的步态元素。例如，动画师经常夸大某些动作来影响姿势的变化，以模仿好或坏的情绪。

### 35.3.4 手势



这可能是社会动态中最具挑战性的方面，因为它看起来很简单。在角色上简单地播放手势动画很容易，但我们做手势的根本原因和我们做出的手势是相当复杂的。在游戏中我们遇到问题最大的领域是角色手势的协调。如果我们观察现实世界的社会互动，我们会看到许多角色相互接触的手势例子。例如，一个简单的问候可能会导致握手。然而在游戏中，协调动画实际上相当困难，尤其是因为制作足够广泛的手势动画以实现协调的成本很高。



建议读者查阅有关具身会话代理的文献，以获取更多关于姿势和手势研究的信息；一本很好的参考书籍是《具身会话代理》[Cassell 00]。



我们还注意到，上述社会动态元素并不是每个情况的绝对要求。它们应该被视为为玩家提供微妙但有用提示的额外细节，就像额外的纹理数据用于为渲染对象添加细节一样。然而，随着我们对社会互动如何影响玩家感知的理解不断发展，未来的游戏可能会具有更深入的社会互动。

## 35.4 实现



我们没有尝试创建一个描绘所有社会动态的单一系统，而是构建了多个处理社会行为各个方面的系统，并依靠这些系统的组合来实现整体功能。在示例代码中，你会注意到所有实体都是简单的组合。有关所使用的基于组件的架构的更多详细信息，请参考第 34 章 “一个简单且健壮的知识表示系统”。



社会动态系统的组件实现大致与前面讨论的社会动态方面一致。注视、空间距离、姿势和手势控制组件在角色模板实例化期间在运行时简单地添加到角色中。在可能的情况下，一个组件执行一小部分行为，而不需要其他组件的方面，但对于许多这些社会行为，需要其他组件。通常，社会组件会将动作委托给其他组件。例如，控制角色互动社交距离的空间距离组件需要有一个运动组件或其他面向移动的组件，以便请求角色改变位置。



在描述社会动态系统中涉及的各种组件之前，我们应该描述它们是如何协调的。一些社会互动完全基于个体自身。例如，个体选择他们的注视焦点，从而选择他们的注意力。然而，大多数社会互动涉及对另一个人的动态反应。这些互动通常可能涉及随时间变化的角色群体。一次聊天可能开始时只有两三个角色，随着更多人加入，人数可能会增加到五六个，最终最初的角色可能会离开聊天，最初的群体成员都不再参与。最初的群体成员引发了一场持续时间超过引发者参与时间的社会互动。这使我们意识到必须实例化另一个实体来监控和控制群体活动的参与。

### 35.4.1 社会对象组件



这个组件负责协调系统中大部分的群体形成方面。其核心是一个处理集合成员关系的组件，允许角色请求加入群体、移除不再参与的角色，并在群体结构中分配资源和 / 或位置。这个系统还负责宣传社会互动的可用性，并在资源有限时组织流量控制，例如在小组讨论中控制同时说话的人数。



这个社会对象组件通常在对象实例化期间添加到世界中，或者在对社会遭遇有接受能力的角色更新期间动态添加。前者的一个例子是热狗摊，在那里实例化社会对象组件以控制角色购买热狗时的行为。后者的一个例子是当一个角色满足 <空闲>、< 想要社交 >、< 看到朋友 > 和 < 朋友也想要社交 > 的真实条件时。当社交活动的条件满足时，角色生成一个游戏对象，并添加一个社会对象组件。这成为一个社会互动的提议，社会对象组件开始其协调互动的角色。

### 35.4.2 社会组件



各种社会动态组件在角色内部的协调由社会组件控制。这个组件负责查询世界中可用的潜在互动、形成参与请求、控制注意力焦点等。这个组件的大部分工作涉及处理通过游戏传播的事件，并将事件发送到社会动态系统的不同组件进行处理。例如，社会组件向其父游戏对象发送一个事件，以表明角色的注意力已经改变。

### 35.4.3 注视组件



这可能是最容易实现的组件，因为它作为动画组件的一个简单修饰符起作用。在角色的 xml 模板架构中添加一个注视组件意味着该组件首先通过请求访问角色游戏对象的动画组件来初始化自己。如果访问失败，注视组件会断言失败，提醒程序员存在依赖关系。下一步是注视组件将自己添加为动画组件的监听器，这允许它在动画提交用于渲染最终角色之前修改动画。在监听器回调方法中，注视控制器简单地在特定限制内改变头部骨骼的方向，以及脊柱骨骼的方向，如图 35.1 所示。



请参考 `UpdateGaze()` 方法以了解修改动画所涉及的实际数学运算，但值得注意的是，对于具有更多脊柱节点的角色，每个脊柱骨骼的旋转应该根据它们在层次结构中离头部骨骼的距离进行缩放。这允许一定程度的躯干扭转，这对于模仿人类躯干的扭转是理想的。显然，典型游戏角色的脊柱链接数量比人类少，所以总会存在一些视觉上的不连续性，但一般来说，一些躯干扭转足以表现动作。应该注意的是，允许的躯干和头部骨骼的旋转量应该仔细选择，以便它们处于对于任何给定角色类型（取决于年龄、体型等）通常被认为舒适的运动范围内。



注视组件会对通过社会组件发送的 “看向” 另一个实体和 / 或位置的事件做出反应。注视的持续时间会根据 “看向” 事件中注明的互动强度进行修改。最终，注视控制器会重置注视方向，或者甚至可能调整当前注视方向，使其暂时偏离注视目标一小段时间。在 AI 组件的黑板中指定的角色个性数据允许修改注视，使得害羞的角色比自信的角色更频繁地移开视线。

### 35.4.4 社会原点



协调社会互动中的运动的一个关键方面是拥有一个共享的社会原点。将许多社会互动视为一组具有空间方向的定时动作是很有用的；为了有连贯的动画，我们必须假设社会互动是相对于一个共享原点进行的。这允许每个互动在世界空间中的任何地方起作用，因为协调是在相对于社会互动的空间中进行的，并传播给所有参与者。



协调共享原点的角色是社会对象组件类的一部分，作为其作为互动仲裁者的职责的一部分。参与互动的个体角色在计算自己的运动时必须尊重这个共享原点，同时也要尊重其他角色的运动。这种方法与在跑酷类行为中用于动画角色的移动原点技术有一些相似之处。如需更多信息，请查看 [AIGameDev.com](https://aigamedev.com/) 上对 Naughty Dog 的 Laurent Ancessi 的采访 [Ancessi 10]。

### 35.4.5 空间距离组件



在社会互动中控制与其他角色的接近度需要访问角色的运动组件（或其他用于在空间中移动和定向角色的功能）。空间距离组件的请求受到角色运动的运动、导航和碰撞避免策略的限制。空间距离组件负责在社会群体中的任何角色移动期间计算角色的理想位置。



这意味着，例如，如果一个角色离开群体，其他角色可能会改变位置，以在社会互动中保持合理的接近度。在实践中，这意味着每个角色都试图与群体中的所有其他角色保持舒适的空间距离，同时仍然保持其他约束，如视线或对于有积极情感的角色足够接近以便用手势触摸。与转向行为非常相似，空间距离通过一个简单的向量长度计算来维持，该计算涉及角色离群体圆圈的距离。这种行为近似于社会科学家 Adam Kendon 所观察到的现象，他将其称为 “O 框架”[Kendon 90]，尽管必须注意的是，抑制任何移动力是有用的，这样角色就不会不断地改变位置（图 35.2）。

### 35.4.6 姿势组件



姿势是较容易实现的组件之一，因为它仅仅依赖于动画选择和 / 或混合来达到预期效果。所提供的实现展示了这种动画选择的最简单形式，即简单地影响可用动画选择的偏差。一个更复杂的实现将是在动画混合树中添加混合节点，根据角色的整体情绪以不同的权重混合不同的姿势剪辑。这需要准备许多与通常会影响姿势的情绪变化相对应的类似动画剪辑。



然后，可以通过简单地从可用动画集中选择适当的剪辑来表现疲劳、快乐、悲伤和兴奋等效果。在演示中提供的 Floyd 角色的情况下，有许多根据角色黑板中持有的名义 “情绪” 值选择的动画剪辑。通过这种方式，我们能够通过相当微妙的姿势变化来表现多种情绪；例如肩膀下垂、眼皮耷拉，或者对于作为喜剧配角工人机器人的 Floyd 来说，他的 “眼睛” 发光稍微减弱以表示更阴沉的情绪。

### 35.4.7 手势组件



手势在角色的描绘中起着重要作用，因为玩家可以通过观察角色做出的手势快速评估角色的感受。经常做手势、手臂动作幅度大且身体重心转移大的角色通常被认为更有活力和积极。再次，手势组件本质上通过选择不同的动画剪辑来修改角色的动画。在这种情况下，剪辑通常在基本运动剪辑的基础上叠加混合。对于类人角色，我们必须注意不要在执行其他会使手势看起来不合适的动画时尝试做手势。例如，当角色正在前滚时，做问候手势是没有意义的。



手势组件功能中更具挑战性的一个方面是知道何时发起手势。通常，当我们试图表达观点或引导对话时，我们会更多地做手势。通常，这种手势 “语言” 通过用手势强调关键词来支撑讨论，社会科学家称之为非语言交流。全面描述非语言交流的作用超出了本章的范围，但它对于可信的角色非常重要。建议读者寻找这方面的学术著作，如 Michael Argyle 的《身体交流》[Argyle 88]。



鉴于手势通常伴随讲话，允许音频工程师在音频剪辑的适当点发送事件来触发手势可能是有用的。另一个问题是当手势需要触摸另一个角色时。这需要很高的精度，以在不穿透另一个角色的网格的情况下实现触摸。虽然在示例代码中没有实现，但在涉及其他角色的手势中，通常使用一个简单的 2 骨逆运动学控制器来控制手的精确位置。



虽然图 35.3 中的类图可能看起来很复杂，但这个组件系统的优点是每个组件都相对容易实现。因为每个组件处理行为的一个方面，我们可以构建代码，使其只处理那个单一方面，从而简单明了。在实践中，这意味着我们可以选择性地实现每个组件；组件通过事件连接在一起，通常彼此不了解或不依赖对方来运行。这种情况的例外是，大多数讨论的组件需要访问动画组件，并且许多组件的功能需要将社会组件添加到角色中以协调行为。即使这也不是严格的要求，因为可以通过简单地将相关事件注入事件流中供各个组件读取来调试行为。

## 35.5 执行



如图 35.3 所示，各个组件包含在一个游戏对象父容器中。每个组件可以通过黑板从 AI 组件访问数据。当一个角色通过感知系统或事件系统意识到可用的社会互动可能性时，这个信息被放入黑板中。这反过来使行为树条件变为真，从而导致一个事件被发送到父游戏对象的社会组件。社会组件又向被感知对象的社会对象组件发送一个事件，请求参与互动。



一旦社会对象组件收到足够的请求来履行其职责，它就会向所有参与者发送一个事件，通知他们在互动中的角色。在这个通知之前，所有智能体都继续他们之前的行为。应该注意的是，一个给定智能体可以请求参与的潜在社会互动的数量应该由游戏的要求决定，并且可能会影响整体性能。请求太少意味着智能体看起来不善于社交，但请求太多会在智能体成功开始互动后必须移除请求时产生不必要的处理。设置互动原点以及参与者信息、轮流和其他协调信息的事件会定期发送。最后，当互动被认为完成时，社会对象组件发送一个事件以释放所有剩余的参与者，允许他们继续寻找其他互动或采取替代行为。



在主游戏循环中对 AI 组件的每次更新都会执行角色行为树，这反过来又会更新黑板中的数据。在同一更新循环中，社会组件读取更新后的数据，并向其他组件发送事件，这些组件会以适当的位置 / 方向 / 姿势 / 注视等变化做出响应。这些变化的最终效果要么被吸收到当前动画中，要么作为力输出，然后在下一次运动更新中被纳入。

## 35.6 结论



游戏角色对社会动态行为的需求是引人注目的。随着我们追求越来越高的视觉真实感，我们也应该追求行为真实感。这并不是说我们需要将自己局限于 “现实” 行为，而是建议我们关注那些增加角色可信度的行为方面。对这些行为方面采用基于组件的方法使我们能够迭代地实现和完善我们对这些方面的处理方法。我们可以从一个简单的 “看向玩家” 组件开始，并随着时间的推移扩展系统。目标是创建让玩家相信它们是有生命的角色，并确保它们在使游戏成为引人入胜的体验中发挥作用。融入角色社会动态的更精细细节有助于引导我们进入玩家相信生命幻觉的世界。