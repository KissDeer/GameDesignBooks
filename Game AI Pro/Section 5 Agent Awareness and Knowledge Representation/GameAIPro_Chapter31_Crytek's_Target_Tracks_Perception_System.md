# 五杠一、Crytek 的目标轨迹感知系统



作者：Rich Welsh

## 31.1 引言



我们所有的知识都源于我们的感知。—— 列奥纳多・达・芬奇



感知是我们日常生活中习以为常的东西。如果没有视觉、听觉、嗅觉、触觉和味觉的能力，我们将对周围的世界一无所知，也无法与他人交流。



编写优秀且可信的人工智能的最大挑战之一是让 “人工智能” 看起来像 “自然智能”。作为开发者，在我们创建的虚拟世界中我们拥有全能的能力 —— 向人工智能体传递信息而不受模拟人类感知的限制，就像调用一个函数一样简单。



电影《黑客帝国》中的一个场景中，主角被一个通过电话传来的无形声音引导出办公室以避免被捕获。凭借我们对游戏世界状态的访问权限，我们可以很容易地以这种方式将关于目标和 / 或威胁的知识传递给人工智能体；然而，一旦玩家意识到人工智能在作弊，他们自然会感到被欺骗。从这个意义上说，“自然智能” 也可以被认为是 “人工愚蠢”。人工智能体可以随时获取关于游戏世界状态的任何和所有信息，但为了让它们的行为更可信、更像人类，我们故意不让它们知道这些信息。



那么，如果让人工智能体直接从游戏中查询信息会给它们太多知识，还有什么其他选择呢？很简单，防止人工智能体知道太多的最好方法是给它们类似于人类玩家的限制。由于玩家通过解读视觉和声音来确定游戏世界的状态，人工智能应该尽可能令人信服地模拟这一点。



在尝试模拟人工智能对刺激的感知时，这个系统的主要焦点是目标选择和优先级排序。当面对几个潜在目标（例如，敌对特工、玩家等）时，人工智能体应该选择与哪个目标交战？



Crytek 为模拟有限感知和处理目标选择而实施的系统称为目标轨迹感知系统（TTPS）。该系统最初由 Kevin Kirst 为《孤岛危机 2》编写，已被证明足够强大和适应性强，可再次用于 Crytek 的所有当前项目，并成为 CryENGINE 3 人工智能系统的一个组成部分。

## 31.2 系统概述



TTPS 由三个主要部分组成：



- 刺激（Stims）：这些是世界中发生的可感知事件（或刺激）的数据表示（见图 31.1）。
- 感知管理器：负责处理、处理和在某些情况下生成刺激。
- 目标轨迹管理器：此管理器负责随时间存储和更新每个智能体的感知，并包含对目标进行优先级排序的逻辑。

## 31.3 刺激



任何来自潜在目标（包括任何当前目标）的游戏内刺激都需要以一致的方式处理。通过创建一个包含关于可感知事件的数据和一个可以解释它们的处理程序的简单结构，我们能够创建一个接口，使人工智能体能够开始理解周围的世界。在 TTPS 中，这个结构被称为刺激（stimulus 的缩写）。



刺激需要包含以下信息来描述一个事件：产生的刺激类型（本节后面会讨论）、源的实体 ID、刺激产生的位置或方向以及可以感知该刺激的半径。随着更多特殊情况事件被添加到游戏中，诸如第二个实体 ID 之类的附加信息可能会很有用，尽管大多数事件可以使用上述初始数据集来描述。例如，由脚步声产生的刺激将包含 AUDIO_MOVEMENT 类型、脚步声的位置以及产生它的角色的实体 ID。然而，为被投掷的盒子产生的刺激将需要 AUDIO_COLLISION 类型、盒子与世界碰撞的位置、盒子的实体 ID 以及投掷盒子的角色的实体 ID（以便确定该动作是由友好角色还是敌对角色执行的）。



在刺激到达感知处理逻辑之前，必须有一种方法对它们进行过滤，以避免对不重要的刺激进行不必要的处理。不是每个智能体都对每个事件感兴趣，所以从一开始就忽略那些刺激是减少需要处理的刺激流量的直接方法。让智能体订阅它们感兴趣的事件类型，并将其与刺激的事件类型进行比较，这是一种非常低成本的测试。



过滤刺激的第二种方法是查看每个智能体的感知范围和作为刺激数据一部分的可感知半径。如果智能体距离太远而无法感知该刺激，则可以将其丢弃。



最后，在每个智能体的感知配置中，事件类型可以用诸如 “仅敌对” 之类的标志进行注册，允许忽略由友好智能体产生的此类事件。这在减少需要处理的刺激量方面会产生很大的不同，因为在许多第一人称射击游戏中，人工智能体遇到的唯一敌对目标是玩家，这意味着由其他人工智能体产生的任何事件都不会被处理。

### 31.3.1 刺激类型



有了定义明确的刺激结构和一个将刺激传递给感知管理器的简单接口，就可以从代码库的任何地方创建刺激。虽然生成的大多数刺激倾向于属于视觉和声音类别，但也有一些不属于这两个类别，因此是更特殊的情况。以下各节将讨论这三种类型。

#### 31.3.1.1 声音



虽然最初看起来每个声音都会产生一个可感知的事件，但通常只有少数声音是人工智能感兴趣的。例如，大多数环境声音对人工智能体没有兴趣 —— 鸟鸣或机械嗡嗡声等环境声音为玩家增添了游戏氛围，但它们不会给人工智能提供关于潜在威胁和目标的任何有用信息。另一方面，诸如爆炸和武器射击等攻击性声音对智能体非常重要，因为识别其来源可能使它们免受伤害，或者可能使它们在战斗中援助同事。



在 CryENGINE 中，处理武器射击的代码在发射武器的同时生成这些刺激。由于 “射击” 事件是从动画系统触发的，这意味着动画、音频提示、视觉效果（枪口闪光、曳光弹等）与枪声音频刺激同步。虽然智能体可能来不及做出反应和躲避，但这有助于建立一个更现实的感知模型。爆炸的处理方式类似，负责生成爆炸的代码也会生成刺激。



碰撞声音是一种更复杂的事件类型。虽然它们以与常规刺激相同的方式生成，但碰撞的敌对性概念很难表示。在这些情况下，我们通过在刺激中存储声音源的实体 ID（导致碰撞的物品）和对碰撞负责的角色的附加实体 ID 来 “作弊”。例如，一个人工智能体撞到一个桶上会发送一个以桶的 ID 为源的刺激，并将笨拙的智能体的 ID 作为额外数据。通过这样做，感知管理器能够使用辅助 ID 来确定是否是友好智能体导致了碰撞（从而可能忽略该刺激）。如果玩家导致了碰撞噪音（通过投掷道具或打翻东西），那么人工智能会将碰撞视为可疑，因为碰撞是由敌对者产生的。

#### 31.3.1.2 视觉



为了确定一个人工智能体是否能够看到某物，大多数游戏倾向于使用从智能体到目标的光线投射。虽然这确实测试了两者之间是否有清晰的视线，但它可能很快变得昂贵。例如，在我们的游戏中，我们试图将活动的人工智能体数量限制为 16 个。这意味着每个智能体可能会看到 15 个其他人工智能角色。在最坏的情况下，这可能意味着在考虑玩家之前需要请求 120 次光线投射来检查所有人工智能体之间的可见性！



在用于《除暴战警 2》的人工智能系统中，每个智能体可以注册在进行可见性检查之前目标需要达到的敌对程度。这些敌对程度是敌对、中立和友好。通过让人工智能体只注册对敌对目标的兴趣，这意味着任何非敌对目标对智能体来说都是不可见的，大大减少了所需的光线投射数量。如果一个目标改变了敌对性（例如，从中立变为敌对目标），人工智能系统将根据需要开始或停止可见性测试。



最初为《除暴战警 2》开发人工智能时，每个智能体都要与其他每个智能体和玩家进行测试。这意味着在一个有 16 个活动智能体和玩家的环境中，需要 136 次光线投射。在优化为让智能体只注册对敌对目标的兴趣之后，只需要 16 次光线投射（假设所有人工智能体彼此视为非敌对）。



可以对视觉刺激的生成进行进一步优化。在 CryAISystem 中，每个智能体都有一个视野距离和一个视野范围。通过进行这些成本更低的测试，看看潜在的视觉目标是否在智能体的视野锥内，然后再请求光线投射，可以避免很多不必要的光线投射。

#### 31.3.1.3 特殊情况



剩下的少数刺激往往是你希望你的人工智能意识到的事件，但不属于正常的视觉或声音类别。对于其中一些事件，你可以有效地将它们视为狗哨 —— 创建一个声音刺激但不播放任何音频，并将其发送到感知管理器。然后，这些刺激可以按照你需要的任何方式进行处理。



对于不能视为声音的刺激，通常需要额外的数据。我们游戏中的一个例子是子弹雨。当子弹雨发生时，人工智能不一定知道其起源点（或敌对性，尽管我们会在刺激中传递射手的 ID，以便我们可以将子弹雨添加到适当的目标轨迹中 —— 如 31.5 节目标轨迹中所解释的）；然而，子弹雨的来向是已知的。因此，这种类型的刺激需要与声音刺激略有不同的处理方式，让智能体在不知道射手位置的情况下对受到攻击做出反应（表 31.1）。

## 31.4 感知管理器



感知管理器是 TTPS 的中层管理部分。它为刺激进入系统提供了一个单一的入口点，同时也进行一些特定情况的处理和自身的刺激生成。由于刺激可以来自代码库的任何地方，拥有这个单一入口点意味着只需要向游戏的其余部分开放一个接口。刺激都共享相同的基本结构，这意味着通过在该接口中只暴露一个函数可以进行进一步的封装。在此之后，TTPS 对代码库的其余部分来说可以成为一个黑盒，其最小接口由用于注册刺激和查询给定智能体的当前最佳目标的函数组成。



如本文前面所述，感知管理器不仅负责接收外部刺激，还负责生成一些内部刺激。由于它是将有效刺激转发到目标轨迹管理器的集中位置，将此逻辑放在这里是有意义的。



感知管理器内部生成的刺激都是视觉刺激。拥有所有活动人工智能体的列表，感知管理器可以依次迭代每个智能体，测试该特定智能体是否可以看到任何已知的可观察对象（在 CryAISystem 的情况下，已知可观察对象的列表是包含所有活动角色，包括玩家的列表）。如果一个可观察对象在活动人工智能体的视野距离和视野范围内，则执行异步光线投射。（由于光线投射执行成本高昂，并且可见性测试并不紧急到需要在同一帧内得到结果，请求延迟光线投射是完全可以接受的。）在接收到光线投射的结果后，清晰的视线意味着生成一个视觉刺激并将其传递给目标轨迹管理器。



以这种方式生成视觉刺激在大多数情况下效果很好，但不允许智能体有周边视觉。为了实现这一点，我们使用另一组用于次要视野距离和视野范围的值。如果一个可观察对象在这个次要视野范围内但不在主要视野范围内（并且仍然接收到清晰的光线投射），则会向目标轨迹管理器发送一个次要视觉刺激。这个刺激具有比主要刺激更低的峰值感知值（这个值在选择目标时用于刺激优先级排序，在 31.6 节 ADSR 包络中会进一步解释）和更长的起始时间。通过有更长的起始时间，处于周边视野的目标将比处于主要视野范围内的目标需要更长时间来识别。如果目标从周边视野进入智能体的主要视野范围，主要视觉刺激将优先于次要刺激。这些值将在后面的章节中更详细地解释。

## 31.5 目标轨迹



游戏世界中的每个智能体都需要跟踪它们识别的任何目标。这在开发智能体的行为时很重要，因为它可以用于在存在多个目标的情况下确定要优先考虑的目标。



一旦一个刺激从一个事件发送并传递到目标轨迹管理器，该目标就被智能体感知并被跟踪。在跟踪目标时，从该目标接收到的所有刺激（并转换为包络，如 31.6 节 ADSR 包络中所解释的）然后一起存储在一个单一的目标轨迹中。这个包络容器代表了一个特定智能体对单个目标的所有感知。通过以这种方式存储包络，我们可以让目标轨迹负责它们包含的包络 —— 随着时间更新感知值，并在它们过期后最终删除它们。



每个目标轨迹对于每个事件类型最多只记住一个包络。由于每个轨迹都与一个特定目标相关联，对于具有与该轨迹中现有包络相同事件类型的新接收到的包络，将简单地更新过时的那个。



通过使用轨迹内的最高包络值作为该轨迹的整体值（因此也是该轨迹目标的值），为智能体找到最佳目标就像选择具有最高值的轨迹一样简单。

## 31.6 ADSR 包络



一旦刺激被感知管理器过滤，目标轨迹管理器就不需要用于测试其有效性的数据。此时唯一需要的信息是刺激的来源。目标轨迹管理器不是直接存储刺激，而是创建 ADSR 包络（这个术语基于音乐合成器中使用的系统；见图 31.2）。



当最初接收到一个刺激时，会创建一个包络并赋予一个感知值，这个感知值将用于与其他刺激比较重要性。这个值随着时间推移而变化，当来自同一源的相同事件类型的刺激继续被接收时保持不变。一旦停止接收刺激，该事件就不再可感知，因此该值开始下降。



每个事件类型可以有不同的峰值。这意味着如果一个单一目标（例如，相同的智能体或玩家）是多个不同刺激的来源，有些刺激在目标选择方面会有更大的权重。这个峰值是在配置文件中定义的任意数字，但应该在所有事件类型之间保持平衡。例如，在我们当前的刺激配置中，脚步声的感知值峰值为 25，武器声音的峰值为 50，主要视野视觉刺激的峰值为 100。这意味着如果一个目标可以听到武器射击声并且也能看到，那么视觉刺激将被认为是当前正在感知的最重要事件。

### 31.6.1 包络阶段



ADSR 包络分为以下四个阶段。

#### 31.6.1.1 起始（Attack）



起始阶段有三个参数：忽略时间、峰值和时间。当接收到一个新刺激时，会创建一个包络并在起始阶段开始。在这个阶段，包络的值将在指定的时间内从 0 上升到峰值。忽略时间是从刺激产生到人工智能感知它的延迟。通常将其设置为 0，因为大多数刺激希望立即被注册；然而，在一些特殊情况下（例如模拟声音延迟）它可能会有用。

#### 31.6.1.2 衰减（Decay）



衰减阶段只以时间为参数。在起始阶段达到峰值后，包络值可以在衰减阶段指定的时间内略有下降。包络衰减到的值在维持参数中指定。这种衰减是为了让新刺激有机会被识别为比已经维持了一段时间的刺激具有更高的优先级。

#### 31.6.1.3 维持（Sustain）



维持阶段取峰值的一个分数。一旦衰减阶段完成，包络将维持在等于指定峰值分数的感知值。只要刺激仍然有效，这个阶段就保持活动，因此包络值将始终保持不变。如果维持分数为 1，包络将保持在峰值，直到进入释放阶段。

#### 31.6.1.4 释放（Release）



释放阶段以时间为参数。一旦刺激不再有效，包络就进入释放阶段。对于声音来说，这是在声音停止后立即发生，对于视觉来说，是当不再接收到该视觉的刺激时（通常是因为与源的视线已经丢失）。在释放阶段，包络值慢慢下降，直到它达到 0 或刺激再次变得有效。

### 31.6.2 修饰符



虽然包络的基础值可以用于确定目标优先级，但处于维持阶段的所有相同类型（针对不同目标）的刺激将具有相等的权重。考虑到这一点，应用修改乘数到基础包络值，以便根据用户指定的标准进一步加权。



TTPS 支持针对不同刺激的一系列乘数。我们使用的最有用的乘数之一是基于距离的；靠近人工智能的目标乘数为 1，而 50 米或更远的目标乘数为 0。这个乘数根据距离线性缩放，即距离人工智能 25 米的目标其包络值将乘以 0.5。

### 31.6.3 脉冲



脉冲是通过代码触发的对包络值的人工提升。在下面的示例配置中（见清单 31.1），设置了一个脉冲，为主要视觉包络的威胁值增加 12.5，它将在 7.5 秒内衰减到 0。要触发一个脉冲，向感知管理器发送一个带有脉冲名称和应用它的智能体的信号。示例中的脉冲在智能体正在追逐（“紧跟”）一个目标时使用。通过发送一个脉冲，它有助于使当前正在追逐的目标保持为最佳目标，即使在主要视野中发现了第二个目标。

### 31.6.4 威胁等级



威胁等级更多地用于智能体的行为而不是选择目标。一旦一个目标被指定为智能体的最佳可用选项，就可以获取该 “最佳目标” 的威胁等级，并且行为会相应地做出反应。威胁等级以峰值包络值的百分比存储，如清单 31.1 中的示例感知配置文件所示。

## 31.7 数据驱动感知



刺激需要转换为 ADSR 包络以供感知管理器使用，尽管不同的智能体在目标优先级排序时可能希望对刺激进行不同的加权。例如，如果你有一个失明的智能体，那么视觉刺激根本不会被注册，但音频刺激会有更高的权重。我们选择的实现方式是通过一组用 XML 编写的刺激 / 包络设置配置文件。（在所有人工智能体希望具有相同感知的情况下，只需要一个配置文件。）清单 31.1 是一个在 TTPS 中如何配置刺激的示例。



拥有这样一个灵活的感知系统在开发过程中非常有用；它允许我们通过更改感知配置文件中的参数，更轻松地为游戏的各种潜行和战斗部分调整人工智能。例如，增加视觉刺激的起始时间会给玩家更多时间从掩体中探出身子观察周围，或者冲向下一个掩体位置而不会立即被人工智能发现。



将这些值以数据形式暴露给设计师也非常重要。这使他们能够试验并快速迭代人工智能的感知模型，而无需每次都构建新游戏或需要程序员协助。

## 31.8 结论



虽然有很多不同的方法来模拟感知和对目标进行优先级排序，但目标轨迹感知系统在几个不同的 3A 游戏中已被证明是强大且灵活的。自最初编写以来，该系统几乎没有进行修改，最显著的是最近在配置文件中添加了威胁等级。这一添加几乎完全是为了从 TTPS 中提取更多信息，而不是改变系统的底层逻辑或流程。



拥有一个封装良好且具有简洁、最小接口的感知管理系统有助于简化刺激的生成。在大型团队中，感知管理器的单函数接口使团队其他成员在需要时很容易添加刺激。



非商业用途的 CryENGINE 3 SDK 可在网上免费获取，它使用 TTPS 进行感知处理。
