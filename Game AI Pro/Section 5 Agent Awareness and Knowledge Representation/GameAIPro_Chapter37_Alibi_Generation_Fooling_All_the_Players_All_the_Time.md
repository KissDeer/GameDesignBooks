# 五杠七、不在场证明生成：始终愚弄所有玩家



作者：Ben Sunshine-Hill

## 37.1 引言



沙盒游戏世界不断扩大。近期的开放世界游戏让玩家能在数十或数百平方英里的区域内自由漫游。而且不只是规模，内容的密度和多样性标准也在不断提高。当然，标准肯定会提高！我们不只是想给玩家一个空间，而是想给他们一个世界。一个充满生机、能做出反应、相互交互的世界，在这个世界里玩家的行为会产生深远影响，每个门口、每个过着虚拟生活的角色背后都隐藏着新的情节。在这里，事情不断发生，如果玩家有胆量，就可以参与其中。无论如何，这是理想状态。但是，尽管大型内容团队、高效的关卡构建技术以及谨慎使用的程序内容生成技术为我们带来了更大、更多样化的世界，我们仍在努力探索如何填充和模拟这些世界。我们倾向于在玩家周围区域（“模拟气泡”）随机生成角色，营造出一个人口密集的世界的假象。但要维持这种假象很棘手。如果玩家挡住了刚生成的非玩家角色（NPC）的路，他会如何重新规划路线？如果玩家扒窃他，会发现什么？如果玩家跟踪他，他会去哪里？如果对角色生成采取随意的方法，答案可能是 “往回走”、“0 到 10 之间的随机金钱数” 和 “无目的地游荡”…… 但这已经不够好了。现在标准提高了。



不在场证明生成是一种更周全、更一致的角色生成方式。NPC 仍然是随机生成以填充模拟气泡，但在必要时，会给他们提供不在场证明：完整的背景故事、目标和存在状态；在一个充满生机的世界里扮演一个有血有肉角色所需的一切。如果处理得当，玩家将无法确定一个 NPC 是一直存在还是几秒钟前才被赋予了不在场证明。

### 37.1.1 背景



不在场证明生成在很大程度上依赖于概率论。要充分理解本文，你应该熟悉联合分布等术语、像 和 这样的符号，以及贝叶斯网络等工具。如需了解该领域的入门知识，我强烈推荐可汗学院的概率系列视频。

## 37.2 理想世界



假设你的游戏在终极硬件上运行：一个具有无限内存的无限快处理器。当然，这样就不需要模拟气泡了；直接模拟世界上所有的角色会更简单。也没有必要让他们在中途开始：只需让每个人从家里开始，在模拟的第一帧中运行几个游戏小时。



这并不是说你不需要程序生成。由于你的内容团队不是无限的，你仍然需要首先使用它来创建世界人口。但不是生成他们的当前状态，而是让系统生成关于他们的信息：他们住在哪里、在哪里工作、如何穿着、从事何种活动；他们的人工智能规则将处理其余部分。作为内容创作者，你需要创建以下内容：



1. 一个关于角色的不可变 “事实” 特征列表。这个列表可能包括 “角色住在哪里” 和 “角色有多高”。其中一些可能是直接可见的（“角色的头发颜色是什么”），但大多数只能间接观察到（“角色喜欢什么食物”）。
2. 每个事实的可能值列表以及每个值的可能性。（对于像 “角色住在哪里” 这样的特征，这可能是根据世界中的信息生成的。）
3. 一个关于角色的可变状态特征列表。其中大多数将是直接可见的，如 “角色目前正在做什么”，但有些可能不太明显，如 “角色有多饿”。
4. 角色如何根据其不可变事实和当前状态选择行动的规则，以及这些行动如何影响角色状态的规则。



你可能会把大部分时间花在第二项上，决定哪些事实与其他事实相关，以及每个值的可能性有多大。相比之下，你不必费心去想 “角色现在在墨西哥餐厅的可能性有多大” 这样的信息，因为没有必要。每个角色都会过自己的生活，其不可变事实、可变状态和行为规则之间的相互作用将导致一个可变状态，这个状态要么包括 “在墨西哥餐厅”，要么不包括。换句话说，角色的不可变事实是原因，可变状态是结果。一个事实包括 “喜欢墨西哥食物” 的角色在任何给定时刻比不喜欢的角色更有可能在墨西哥餐厅，而不需要你专门硬编码。



不在场证明生成则相反。它首先只生成关于角色的可见信息。之后，如果有必要，它将可见信息视为原因，并生成不可见信息（不在场证明）作为结果。例如，如果一个角色生成时的可见信息包括 “在墨西哥餐厅”，后来玩家与该角色交谈并需要一个不在场证明，为该角色生成的不在场证明比平均情况更有可能包括 “喜欢墨西哥食物”。



但是 —— 这就是有点棘手的地方 —— 你应该多久生成一次在墨西哥餐厅的人，以及在墨西哥餐厅的人喜欢墨西哥食物的可能性到底有多大？使不在场证明生成有用的关键特征是，作为内容创作者，你仍然只需要负责想出最初的四个项目。用于在中途生成角色并在之后为他们提供不在场证明的所有相关信息都是在预处理步骤中基于原始信息生成的。



让我们更深入地探讨一下。不在场证明生成的运行时组件有三个部分：生成初始的、没有不在场证明的角色，确定何时需要不在场证明，以及为角色生成不在场证明。我们将依次探讨这些部分。

### 37.2.1 海森堡



如果没有示例应用程序，很难深入探讨这个 “理想世界” 的内容，所以我们将介绍我们的示例：海森堡。海森堡是一个对城市中行人的简单模拟，城市规模和人口与曼哈顿相似。（其街道布局改编自伊拉克巴士拉的一个地区。）城市中有数千个潜在的兴趣点，如家庭、办公楼、餐厅、银行和剧院。在完整的模拟中，一个角色有一个家和一个工作场所。他们根据当前位置选择下一个目标（如 “去工作” 或 “在一家不错的餐厅吃饭”），通过最短路径走到那里，然后根据目标类型在那里停留一段随机时间。目标可以是往返差事或单程旅行。对于某些类型的目标（例如，买热狗），角色会选择最近的同类目的地；对于其他目标（例如，拜访朋友），他们会在世界中选择一个特定的目的地。之后，他们要么返回之前的位置，要么选择一个新目标，这取决于目标类型。



海森堡的机制很简单，但实时模拟数百万个角色超出了当前一代视频游戏硬件的能力。



我们将世界划分为每个约八个街区的区域，并使用不在场证明生成来管理角色，只模拟玩家可见的区域。每个区域通过 “门户” 与相邻区域相连，门户通常位于街区中间。我们预先计算了从任何门户到任何其他门户、从区域内的任何建筑物到同一区域内的任何其他建筑物以及从任何门户到区域内的任何建筑物的通过区域的最短路径。这些预先计算的路径被称为 “路径段”，角色通过遵循一系列这些路径段从一个地方移动到另一个地方。一个角色的初始信息包括他们当前的路径段（包括方向）；他们的不在场证明包括他们之前离开的建筑物和他们要前往的建筑物，以及他们旅行的原因（图 37.1）。

## 37.3 初始生成



当然，角色的初始生成是我们已经知道如何做的事情，因为我们一直在做。它需要非常快速地完成，因为我们要为每个角色，包括不重要的背景角色进行生成。从不在场证明生成的角度来看，初始生成最重要的方面是它必须与完整模拟中的角色分布一致。如果你生成一个角色沿着一条小巷走向死胡同，而小巷尽头没有任何目的地（或者没有其他人工智能原因说明角色会去那里），就不可能为那个角色生成不在场证明。更微妙的是，如果那个方向只有一个目的地，每个沿着那条路走的角色都会得到一个包括前往那个目的地的不在场证明，所以小巷的人口最好与那个目的地的受欢迎程度完全一致。

### 37.3.1 人口规模



我们需要考虑的初始生成的第一部分是决定在特定地方（例如，当玩家第一次走进书店时）生成多少个角色，以及多久生成新的角色（新顾客走进门）。最重要的是这两个过程要匹配。如果进入率太高，书店一开始会很空旷，然后很快就会人满为患；如果太低，书店会随着时间变得空旷。



对于海森堡，在将世界划分为区域后，我们确定了通过每个区域的所有可能路径，路径的每一端要么是区域边界，要么是建筑物入口。我们计算并存储了每条路径的平均人口。（请注意，一条 “路径” 可能有几个街区长，一个街区的人行道会有许多沿着它的 “路径”。）



当玩家进入一个新区域的视野时，我们使用泊松分布来生成初始人口。这是一种关于人口的随机分布，它以平均人口作为唯一参数，并假设角色的位置相互独立。可以使用一个简单的迭代算法 [Knuth 69] 从泊松分布中采样。



当相邻区域不可见时，为了在区域路径的起点生成进入该区域的新角色，我们使用指数分布来生成 “下一次到达的时间”。这个分布以平均进入率作为唯一参数。如果一条路径段的平均人口是 P，沿着这条路径段全程旅行的时间是 t，那么平均进入率就是 。在采样到下一次到达的时间后，为那个未来时间设置一个延迟事件；当事件触发时，一个新角色进入那条路径段，并生成一个新的下一次到达时间。一个全局优先队列管理所有到达时间。当两个相邻区域都可见时，我们不会从一个区域生成新的进入另一个区域的角色，因为这会导致角色明显地突然出现。相反，角色通过正常方式进入该区域：之前在另一个区域。



泊松分布和指数分布在数学上是用于这些任务的 “正确” 分布，假设具有简单的独立性和同质性属性。没有什么理由偏离它们。此外，由于这些分布每个路径只依赖于两个数字，所以这些数据可以简单地预先计算并存储。

### 37.3.2 位置和其他信息



对于在路径上开始的每个角色，有必要定义他们在路径上的位置。这可以通过在路径上采样一个随机位置，然后偏移一个小的随机量来启动碰撞避免来完成。角色的外观 —— 脸、衣服等 —— 也是作为一组网格随机生成的，然后合并。

## 37.4 确定何时需要不在场证明



在决定是否为给定角色生成不在场证明时，你需要在真实性和性能之间取得平衡。一旦角色有了不在场证明，模拟他们可能会变得更昂贵，而且不在场证明生成过程本身也可能很昂贵。然而，等待太久才生成不在场证明可能会导致无法找到一个与玩家已经观察到的关于该角色的所有信息一致的不在场证明。



理想情况下，你希望在角色没有不在场证明和有不在场证明的行为可能出现分歧之前的某个时候生成不在场证明。如果一个角色刚刚开始沿着一个没有目的地的街区行走，他们的短期行为几乎没有不确定性。只有当他们走到街区尽头需要决定转弯方向时，他们才会依赖隐藏的内部状态。与玩家的互动也可能需要提前生成不在场证明。



对于海森堡，将角色行走的区域划分为通过区域的路径在这里对我们有利。由于一个角色的初始状态通常包括几个街区的行走，所以他们第一次转弯时不需要生成不在场证明。只有当他们接近区域边界 —— 也就是他们通过该区域的路径的尽头时 —— 才需要不在场证明。此外，如果一个角色在几乎到达他们所在区域路径的尽头时才出现，我们不会立即生成不在场证明；相反，我们为他们选择一条通过下一个区域的随机路径，因为玩家只能看到路径的一小部分，无法推断他们的路径。

## 37.5 生成不在场证明



成功生成不在场证明始于初始生成所奠定的基础。与初始生成一样，目标是想出一组与某些先验条件一致的数据。然而，存储整个用于不在场证明生成的条件概率表是完全不可行的 —— 它太大了。真正的诀窍是找到不在场证明分布的紧凑表示形式以及从中采样的方法。有几种选择；我们在这里介绍一种，其他的在 37.6 节中介绍。



进入 Metropolis - Hastings 算法。这是一种从难以直接采样甚至计算的分布中生成随机样本的技术。它是一种随机游走技术，从某个初始条件开始，然后在许多迭代中逐步修改该条件。虽然初始条件不是随机的，但随着时间的推移，当前状态的分布会收敛到所需的概率分布。在传统的 Metropolis - Hastings 中，目标通常是从同一分布中生成大量样本；最初的几百次迭代被称为预热期，会被丢弃，因为它们可能与初始状态相关。然而，对于不在场证明生成，我们把所有的迭代都花在预热期上；之后，我们将最后一个状态作为不在场证明。



Metropolis - Hastings 算法最好的部分是我们实际上不需要计算条件概率。给定初始数据 D，要采样一个不在场证明 ，我们需要比较两个不在场证明的相对概率，。根据贝叶斯法则，这与 相同。所以我们需要提供一个函数 。我们还需要提供一个转移函数，它在给定 作为输入的情况下随机选择一个 “附近” 的候选不在场证明 ，以及一个函数 ，它告诉我们那个转移的概率 —— 从 移动到 时选择候选不在场证明 的概率。



在每次迭代中，我们使用随机转移函数将 扰动为 。然后我们计算接受概率，。我们以概率 a 接受 ；如果不接受，我们当前的不在场证明仍然是 。



对于海森堡，我们通过分析生成了一小套可用于生成 的表 [Sunshine - Hill 11]；这些表包括条件概率表和每个目的地的概率分布表（如进入率）。记住，一个不在场证明包括源建筑物和目标建筑物；为了扰动一个不在场证明，我们先扰动源建筑物，然后是目标建筑物。世界上的每个建筑物都有一个附近建筑物（包括建筑物本身）的表，源建筑物和目标建筑物的扰动是从当前源建筑物和目标建筑物的表中均匀采样的。为了避免除以零，我们从表中删除了单向转移，这通常会使它们大小不同。这意味着 是源表和目标表大小乘积的倒数。



不在场证明生成分两步进行：首先，确定角色要去哪里，其次，确定为什么。“哪里” 包括他们的源和目标。“为什么” 包括他们当前的目的地是单程旅行、往返差事还是从往返差事中返回，以及他们的目标是什么。第二步很重要，因为它有助于确定角色的下一个行动，并且因为它确定了源或目标对他们是否有任何特殊意义。如果玩家看到一个角色回家到一个特定的建筑物，那个角色最好在未来继续回到同一个建筑物。

## 37.6 不在场证明生成的选项



不在场证明生成最困难的部分是设计和构建用于采样的数据。我已经向你展示了黄金标准 —— 从封闭形式的概率分布中进行 Metropolis - Hastings 采样 —— 但还有其他一些选择。

### 37.6.1 精确计算



对于海森堡，我们构建了一个不在场证明分布的表示形式，它被证明与 “理想世界”（完整模拟）的稳态分布相同。我不会骗你：做到这一点非常非常困难。即使对于我们使用的简单角色人工智能，求解整个方程组也花了几周时间，并涉及到随机过程理论中非常晦涩的领域。如果你能做到这一点，这种方法很好，因为它的结果肯定是正确的；但如果你的人工智能规则非常复杂，这就不可行了。



如需了解更多关于 Metropolis - Hastings 的信息，我推荐 [Chib and Greenberg 95]。

### 37.6.2 预设不在场证明



一种非常非常简单的不在场证明生成方法是为每个独特的初始条件集存储一个预先录制的不在场证明列表。例如，你可能有一个专门为穿着西装、拿着纸袋、在特定街区向东走的男性准备的不在场证明列表。每当需要时，从列表中随机（或顺序）选择一个不在场证明应用。



这种方法的好处当然是简单。不需要复杂的概率计算，而且它是 “生成” 不在场证明最快的方法。这是一种一刀切的解决方案。缺点是需要在空间需求和多样性之间做出妥协：每个初始条件集的不在场证明越多，空间需求就越大；但不在场证明越少，不在场证明生成能够创造的多样性就越少。



空间需求取决于世界大小和初始条件的多样性。前者影响磁盘空间和内存空间；后者只影响内存空间，因为只需要为在玩家当前位置附近创建的角色生成不在场证明，所以列表可以分页进出。因此，至少限制那些界定不在场证明列表的初始条件的维度是特别重要的。例如，在上面的例子中，你可能选择不针对拿着纸袋和不拿着纸袋的情况分别列出。



记录过程很简单：有一个选项可以完全模拟充满人口的整个世界，运行一段时间，然后在不同的初始条件下拍摄人物快照。禁用图形、声音和任何其他与模拟无关的子系统是有用的。如果你的角色都从确定性的位置开始，记得在开始采样之前给他们一些时间四处游荡。此外，不要采样太频繁，否则相邻路径的不在场证明可能最终会过度相关。这个过程可以非正式地并行化；在几台机器上运行一夜，然后合并它们的不在场证明列表。

### 37.6.3 混合生成



对于那些想要多样性和大量初始条件空间，但仍想使用记录来生成不在场证明列表的人来说，有一种潜在的中间途径。基本思路是从预设不在场证明开始，然后使用随机扰动为不在场证明的某些方面（而不是其他方面）增加多样性。



最有可能采用的策略是扰动角色的当前目的地，但只在相同类型的目的地之间进行。与 Metropolis - Hastings 方法一样，每个建筑物都有一个附近建筑物的转移表，但现在只在相同类型的建筑物之间。并且与预设不在场证明方法一样，每组初始数据都有一个可供选择的不在场证明表。首先，选择一个预设不在场证明；然后，使用该不在场证明目的地的转移表来改变不在场证明的目的地。只需要进行几次预热迭代，甚至只需要一次，并且 （只要当前路径是沿着到 的最短路径；否则，它为 0），所以接受概率只是表大小的比率。甚至称其为 Metropolis - Hastings 都有点牵强；它基本上只是在可能的目的地空间上的随机游走。

## 37.7 维护和删除角色

关于不在场证明生成，一个重要的问题是何时删除角色，特别是如果我们将其视为对 “模拟气泡” 方法的改进。作为第一种方法，我们可以在角色当前所在区域变得不可见时简单地删除他们。这类似于模拟气泡，但会产生明显的潜在问题。即使玩家没有长时间观察一个角色，如果她转过一个角落，回来后发现角色不见了，她仍然可能会注意到。我们可以通过仅在玩家距离超过指定距离或角色不可见一段时间后才清空不可见区域来降低这种可能性；这样，即使在完整模拟中，玩家也不能保证能够找到相同的角色。对于角色可能停留一段时间的内部位置，应该使用更长的不可见截止时间。

延长有不在场证明的角色的寿命是个好主意。一个有不在场证明的角色通常是因为他们在某些方面对角色特别重要，所以他们可能会在角色记忆中停留更长时间。这可能会导致一种情况，即一个不可见的区域中有几个有不在场证明的角色，但其他地方则无人居住。当你最初填充一个已经有角色（有或没有不在场证明）的区域时，你应该从用于泊松分布的 “平均人口” 参数中减去这个人口，但不从用于指数分布的参数中减去。

作为这些策略的替代方案，LOD Trader（在 “使用 LOD Trader 进行出色的 AI 细节层次控制” 一章中讨论）是管理不在场证明的理想工具。角色是否有不在场证明可以被视为一个 LOD 特征，没有不在场证明的级别给予 ULTB 惩罚。同样，如在 LOD Trader 中所讨论的，与其根据阈值距离或时间删除角色，不如将存在视为一个特征，将向不存在的转变给予 US 和 FD 惩罚。当一个区域变得可见时仍然创建初始角色，并且如前所述，在生成初始人口时，从平均人口参数中减去任何当前人口。

## 37.8 结论

不在场证明生成，从其最基本的形式来看，是一个简单的想法：延迟生成细节。这里的 “延迟” 是计算机科学意义上的：在首次需要时，而不是之前或之后。有多种方法可以做到这一点，从简单和非正式的（预设不在场证明）到复杂和理论上精确的（Metropolis - Hastings）。无论采用哪种方法，最重要的目标是牢记 “理想游戏世界” 的概念，并设计你的不在场证明生成系统，以便无缝地复制那个理想游戏世界的体验。