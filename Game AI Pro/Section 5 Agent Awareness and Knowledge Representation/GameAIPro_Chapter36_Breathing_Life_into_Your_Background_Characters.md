# 五杠六、赋予你的背景角色生命



作者：David “Rez” Graham

## 36.1 引言



背景人工智能是任何包含非玩家角色、生物和其他背景元素的游戏的重要组成部分，因为它能增加游戏的可信度和沉浸感。在本文中，非玩家角色（NPC）指的是背景角色，与敌人或主要的、故事驱动的角色相对，不过你也完全可以将这些原则应用到其他角色上。



让这些背景 NPC 看起来有自己的生活和个性，从而使游戏世界充满生机是很重要的。如果你的 NPC 是静态的，看起来没有在忙于自己的生活，那么你的游戏世界就会显得沉闷。关键是，由于这些是次要 NPC，它们在内存、CPU 时间或开发时间方面不能消耗太多。



所选技术还必须能够在处理的 NPC 数量、其人工智能的复杂性以及处理频率方面进行扩展，因为随着开发进度的削减，NPC 的行为和内容很可能会缩减。同时也存在性能和内存方面的问题。在游戏接近尾声时，CPU 和内存密集型系统最终可能会被缩减，因此所选解决方案必须能够轻松地向两个方向扩展。

## 36.2 常见技术



许多游戏在添加背景 NPC 时会使用一些常见技术。一种方法是使用循环空闲动画，即 NPC 不断重复播放单个动画。比如，可能有一个铁匠在整个游戏过程中只是不停地锤打一把剑，或者有一个旅店老板一直在擦拭柜台。这通常与其他 NPC 运行随机行走循环相结合，这些 NPC 只是选择一个随机位置，走到那里，空闲一分钟，然后再重复这个过程。不幸的是，这些技术看起来都不太好，想想 NES 和 SNES 时代的老角色扮演游戏也做着同样的事情，这就不足为奇了。



另一个常见的错误是走向另一个极端，试图实现一个复杂的人工智能系统。如果你已经为主要 NPC 或敌人使用了一个复杂的人工智能系统，可能会想将其用于背景角色，但这通常是个错误。从本质上讲，背景角色不是玩家关注的焦点。它们只是为了增添氛围。一个更简单、更快且占用内存更少的系统通常是更好的选择，因为它可以让你拥有更多的背景 NPC，这对于营造一个大城市的假象很重要。只看到四五个 NPC 四处游荡不足以让玩家相信他身处一个城市，但看到二十或三十个可能就够了。这里的目标是两全其美，并能够根据需要向两个方向扩展你的解决方案。

## 36.3 日程系统描述



确定背景人工智能策略是否可行的三个重要标准是高性能、可扩展性和易于实现。性能很重要，因为你可能希望一次运行几十个甚至几百个 NPC。在更新期间运行复杂的评分函数通常成本太高，不是一个可行的解决方案。拥有一个模块化系统，允许你用简单组件替换复杂组件，可以让你在不重写任何内容的情况下调整系统性能。最终的解决方案从实现和维护的角度来看也必须是低风险的。它应该尽可能以数据驱动，这样一旦构建完成，设计师和动画师就应该能够完成创建尽可能多的背景 NPC 所需的 90% 的工作。



满足这三个标准并仍能获得合理行为的一种方法是使用日程系统。日程可以被看作是一个黑盒，输入是当前时间，输出是一个动作。实际上，这些动作只不过是 “去这里并播放这个动画”。单独来看，一个 NPC 可能仍然相当可预测且单调，但如果你有十几个或更多的 NPC 都运行不同的日程，你就会突然拥有一个充满生机的世界。从本质上讲，日程只是一组时间块，每个时间块定义了执行该日程的 NPC 的行为。该系统是一个轻量级、数据驱动的分层状态机，顶级状态选择基于时间。



我们在《模拟人生：中世纪》中使用了类似的系统，为设计师提供了他们所追求的灵活性。它也在许多角色扮演游戏和模拟游戏中成功应用，这种系统在这些类型的游戏中效果很好。它也可以用于其他类型的游戏，如第一人称射击游戏、冒险游戏等，但你可能需要进行一些修改。我们将在本章后面进一步讨论这个问题。

## 36.4 日程架构



这个日程系统有三个关键组件：日程、日程条目和动作。这些概念共同构成了背景人工智能系统的核心。

### 36.4.1 日程



日程通过指针、ID 或系统适用的其他方式与 NPC 相关联。日程是访问 NPC 上的任何日程数据并在运行时操作日程的顶级接口。日程包含许多日程条目，每个日程条目代表一段时间（见下文）。在这个系统中，NPC 一次只能处于一个日程条目中，不过只要规则足够简单，允许日程分层也不是太难。一个例子是允许 NPC 考虑他们所在的所有日程的所有可能动作。另一个想法是允许一个 NPC 有多个日程，但一次只有一个活动日程。在《模拟人生：中世纪》中，我们选择了后一种方法。



日程负责根据当前时间移动到适当的日程条目。它们还负责调用当前运行的条目并返回 NPC 要执行的适当动作。运行中的日程的任何需要被游戏其他部分访问的功能都应该放在这里。



在本文附带的示例代码（可在本书网站 [http://www.gameaipro.com](http://www.gameaipro.com/) 上获取）中，日程组件由 ScheduleInstance 和 ScheduleDefinition 类实现。ScheduleInstance 表示日程的运行时数据，如当前哪个条目处于活动状态，而 ScheduleDefinition 表示从不改变的静态数据，如 ID 和与该日程相关联的日程条目。

### 36.4.2 日程条目



日程条目是日程中的一个时间片段。它管理日程条目的生命周期，并确定何时移动到下一个条目。日程条目还封装了 NPC 在寻找要做的事情时所做的决策。因此，日程条目通常使用策略模式或其他设计模式实现，这些模式使你能够轻松地将一个条目替换为另一个 [Gamma 等人 01]。



每当 NPC 在日程中处于空闲状态时，它会调用日程以寻找新动作。日程调用当前活动的日程条目，该条目进而运行实际的决策逻辑，为 NPC 寻找要执行的新动作。这个动作被返回给 NPC，然后 NPC 执行相应的动作。日程条目中用于选择新动作的函数是一个纯虚函数，其实现取决于实例化的具体子类。日程条目都是可互换的，并符合一个单一接口。实例化的具体日程条目由数据中设置的类型决定，该类型被传递给一个工厂。



定义不同的日程条目子类并覆盖动作选择器函数，可以让你很好地控制背景 NPC 人工智能逻辑的复杂程度。



你可以返回一个单一动作，或从列表中返回一个随机动作，或者你可以运行一系列复杂的评分算法，根据当前世界状态权衡 NPC 的欲望和目标。这正是《模拟人生：中世纪》所做的。每个日程条目都有一组 Sim 要满足的超出其标准欲望的欲望。例如，铁匠可能会试图通过在锻造炉工作来满足他 “成为铁匠” 的欲望。



日程条目类型也可以混合搭配。一些日程条目可以返回一个单一动作，而其他条目可能使用更复杂的评分形式。改变决策策略就像改变日程数据一样简单。然后你可以构建一个各种决策策略的库，让你的设计师为每种情况选择他们想要的策略。这就是数据驱动的日程系统的强大之处。



在本文附带的示例代码中，日程条目系统从 ScheduleEntry 基类开始，该类声明了纯虚函数 ChooseNewAction () 作为动作选择器。这个类以及示例子类在 ScheduleEntry.cpp 文件中定义。

### 36.4.3 动作和对象所有权



动作是日程的输出，代表 NPC 所做的事情。它们通常定义一个目标对象、动作的持续时间、可能的动画以及执行动作所需的任何其他数据。动作在很大程度上取决于游戏；每个游戏可能都有自己让 NPC 与世界互动的方式。这部分系统是与你的游戏世界的接口。日程条目中的动作选择器返回的动作应该采用适合你的游戏的格式。在《模拟人生：中世纪》中，我们称它们为交互定义。它们是包含在 Sim 上实例化交互所需信息的对象。



通常，仅仅让 NPC 与目标对象交互是不够的。更常见的是让 NPC 在自己的床上睡觉或在特定的锻造炉工作。我们希望两者兼顾，所以动作系统也需要处理对象所有权的概念。



所有可以交互的游戏对象都应该有一个类型 ID，它定义了对象的类型。对象类型实际上只是设计师用来标记相似对象组的元数据。例如，所有的床都可以归为 “床” 类型。这允许 NPC 拥有特定类型的对象，大大简化了日程数据。例如，一个日程可能有一个动作，告诉 NPC 去睡觉。NPC 会查看它拥有的对象映射，检查是否有 “床” 对象。如果有，它就会使用那张床。如果没有，可以定义一些默认行为。也许 NPC 会选择一张随机的床，或者也许它会放弃这个动作并选择一个新的。同样的动作可以不加修改地应用于多个 NPC，并且效果很好。每个 NPC 都会去它自己合适的床。



定义对象所有权也是因游戏而异的。一种常见的方法是在你的 NPC 工具中设置对象所有权，作为对象类型到对象 ID 的映射集。这样，设计师就可以指定它。另一种方法是支持更大、更广泛的标签。例如，在《模拟人生：中世纪》中，设计师有一个电子表格，允许他们将 NPC 映射到他们的家和工作建筑。这允许他们使用这些建筑中的所有对象，所以当他们被告知 “回家” 时，他们会去合适的地方。



例如，考虑清单 36.1 中的示例动作 XML 定义。



动作的目标是一个对象类型 ID。这不是世界中的一个特定对象，而是一种对象类型。这将导致 NPC 搜索它拥有的对象映射，如果它拥有合适类型的对象，就在该对象上执行动作。如果没有，它将运行一些默认行为，比如找到最近的那种类型的对象。



这也允许你针对一个组，其中多个 NPC 可能拥有不同的对象。在上面的例子中，可能有多个 “面包师烤箱” 类型的烤箱对象，每个都由不同的 NPC 拥有。这大大减少了数据重复。



如本文所述，该系统只允许 NPC 拥有任何给定类型的单个对象。只要你有合理的处理规则，没有什么能阻止你允许 NPC 拥有同一类型的多个对象。一个例子是总是选择最近的对象。



在本文附带的示例代码中，动作像日程一样分为实例和定义。有 ActionInstance 类和 ActionDefinition 类。ActionInstance 类处理所有运行时数据，而 ActionDefinition 类处理静态数据。

### 36.4.4 整合



将这三个系统整合在一起，为创建一个简单的日程系统提供了一个很好的框架。为了进一步说明这一点，请看清单 36.2。

## 36.5 日程模板



日程的一个缺点是它们往往会导致大量的数据重复。例如，如果你的游戏有昼夜循环，很可能每个 NPC 都会有一个睡觉的日程条目。事实上，许多条目彼此会非常相似。你可以通过允许模板和数据继承来缓解这个问题。



假设你有一个警卫日程条目，它确定警卫应该站在哪里。如果你在模板中构建这个条目，你可以将该模板应用于每个警卫的日程，并只覆盖特定于该日程的特定数据。添加这个功能相当简单。模板本身应该与日程条目具有完全相同的模式，所以你所需要做的就是为每个模板创建一个日程条目，并将其存储在一个表中以便于查找。



看一下清单 36.3，了解这个模板在 XML 中的示例。



定义警卫日程只是指向模板并覆盖你关心的值的问题，如清单 36.4 所示。

## 36.6 改进



这个系统可以进行一些改进。首先，只有日程条目使用模板系统，而实际上日程的所有组件都可以从中受益。日程的每个部分都应该是可继承的，这样设计师就可以构建一个不同日程部分的工具箱，组合成他们的 NPC 的最终日程。



另一个改进是日程缓存的处理。目前，每个日程、模板、动作和条目都存储在内存中。这样做是为了简单和便于解释。更合适的实现将取决于你的游戏设计。如果你的 NPC 很少切换日程，你可以清除当前未使用的日程，并在必要时动态加载它们。这甚至可以在日程条目层进行，因为从一个条目移动到另一个条目并不经常发生。



在演示中，ID 被处理为字符串。这是日程与动作和 NPC 相链接的方式。这也是我们选择这种方法的另一个原因，因为它简单且便于解释。每个游戏对对象 ID 的处理方式都不同，并且有自己将对象链接在一起的方法。然而，值得注意的是，进行字符串比较来匹配 ID 不是一个好策略。至少，你会想要将这些字符串哈希成唯一的 ID。



另一个需要考虑的是日程的刚性。如果你有一个日程，每天下午 6 点让 NPC 去旅馆吃晚餐和喝酒，很容易就会有一堆 NPC 同时停止他们正在做的事情，立即前往旅馆。一个更好的解决方案是使用以该日程条目结束时间为中心的高斯分布函数来随机化日程更新时间。只要你不介意他们有时早一点，这将导致 NPC 在合理接近调整时间的时候移动到下一个条目。你也可以依靠动作本身来注入一些随机性。这就是我们在《模拟人生：中世纪》中所做的。切换到新日程的 Sim 会在前往预定位置之前完成他们当前的交互。



将日程系统集成到现有的人工智能系统中可能会非常强大。核心人工智能系统需要能够在必要时覆盖日程系统。例如，如果玩家攻击面包师，面包师的日程应该被抛弃，他应该要么反击要么逃跑。一旦威胁消失，他可以恢复他的日程。这也适用于敌人。你可以为所有敌人分配一个日程，一旦他们注意到玩家，这个日程就会被覆盖。



目前，日程条目是由时间定义的。它们代表 NPC 在特定时间应该做什么，但不是所有游戏都有时间的概念。幸运的是，很容易将其改为其他东西。例如，你可以有根据游戏事件或玩家移动来选择日程条目的日程。你可以让 NPC 处于一个警卫日程条目中，当警报响起时该条目会改变。



你甚至可以混合这两种方式，让一些日程条目由时间控制，而其他条目由事件控制。这将允许你拥有按照日程运行但也能对周围世界做出反应的 NPC。例如，你可以有一个有典型工作日程的店主，当城镇受到兽人攻击时他也能做出反应。记住，这个日程系统背后的底层结构是一个分层有限状态机。相对容易让它更接近其根源。



当前系统的另一个限制是 NPC 只能拥有任何给定类型的单个对象。只要你有合理的规则，没有什么能阻止你允许 NPC 拥有同一类型的多个对象。



最后，所有的日程数据都在 XML 中。要求设计师手动编辑这个 XML 是不现实的，所以你需要构建一个日程工具，它可以生成必要的数据并将其链接到游戏对象。一个带有网格控件的简单 C# 应用程序就足够了。



注意，这是一个拥有基于组件的对象层次结构 [Rene 05] 真正有帮助的地方。你可以简单地构建一个处理所有日程数据的组件，并将其附加到任何需要通过日程控制的游戏对象上。你可以有另一个组件来跟踪对象类型，并允许带有该组件的对象成为日程的目标。这将允许你轻松地插入日程系统。

## 36.7 结论



NPC 可以成就或破坏玩家在你的游戏中的沉浸感。如果你有一个 NPC 在整个游戏中都在墙上钉木板或打磨剑，一个充满生机的世界的幻觉就会消失。幸运的是，使用日程系统可以快速轻松地创建可信的背景角色。NPC 被锁定在日程中，并通过非常简单的行为人工智能进行更新。只需几个日程，城镇的喧嚣就会开始显现。玩家会看到 NPC 过着他们的日常生活，并开始从中推断出一个故事。只需很少的工作，你的游戏世界就可以充满生机。