# 五杠二、如何抓住忍者：2D 潜行平台游戏中的 NPC 感知



作者：Brook Miles

## 32.1 引言



《忍者印记》是 Klei Entertainment 开发的一款 2D 潜行平台游戏。玩家扮演忍者，在关卡中潜行，藏身于阴影、爬过通风管道，并伏击毫无防备的守卫。然而，我们使用的引擎是基于 Klei 之前的游戏《闪克 2》，而如果说《闪克》有什么特点的话…… 那肯定不是擅长潜行。



在《闪克》和《闪克 2》中，人工智能敌人只关心可攻击目标（玩家，或合作游戏中的多个玩家）。它们会生成，当玩家进入攻击范围时选择一个合适的玩家进行攻击，并一直持续到杀死该玩家或被玩家杀死。



这在以持续正面战斗为重点的《闪克》游戏中效果很好。但对于《忍者印记》，我们需要更微妙的行为。守卫需要有多个级别的警觉性；玩家需要能够用声音或移动分散他们的注意力，或者打破视线以逃脱检测，然后再绕回来从背后攻击。守卫需要对周围环境有一定的感知，注意到有什么不对劲的地方，调查引起他们注意的事物，并对倒下的同伴做出反应。



为了满足人工智能角色对周围世界中的事件和物体的感知需求，我们实施的一个改变是一个数据驱动的兴趣系统，它允许设计师或脚本编写者定义世界中的兴趣源，并让智能体适当地检测和响应它们。



在《忍者印记》中，目标和兴趣是相似的概念；它们各自代表游戏世界中一个智能体能够感知并应该做出反应的物体。然而，在表示每个概念的数据以及智能体的相关行为方面存在很大差异，这导致决定在游戏中将它们实现为单独的实体。



也许最重要的是，所有目标基本上是平等的：如果它是敌人，就射击它！智能体在有目标时进行的大多数处理都致力于跟踪其位置并攻击它。有目标的智能体将始终处于高度戒备状态，并会忽略大多数其他刺激，直到它或其目标死亡。另一方面，兴趣代表不是目标的事物；它们被假定为静止的，但数量更多且种类更多，正如我们稍后将看到的。当智能体有兴趣时，它通常会尝试调查该兴趣并搜索周围区域，同时留意目标或其他更重要的潜在兴趣。

## 32.2 从闪克到忍者 —— 注意目标之外的事物



作为从《闪克 2》源代码树分支出来的忍者部分，智能体最初获得了注意兴趣点的能力。一个兴趣点仅仅由关卡中的一个 2D 点组成，是一个要接近但不一定射击的东西。



这些兴趣点是在每个智能体大脑的更新循环中从声音、尸体和损坏的灯光等来源创建的。更新循环会收集并迭代每种类型的游戏对象，对于声音，是一个简单的 2D 点列表。在收集了潜在兴趣列表后，会根据接近度或其他硬编码标准选择一个作为当前兴趣，智能体将对其做出响应。这种设置在某些情况下有效，但存在我们想要克服的重大问题。



首先，如果设计师希望智能体对任何新的且之前未定义的对象或事件感兴趣，他们需要请求程序员在大脑中添加一组新的检查，并可能添加新的数据结构来跟踪所感知的事物。当时已经很明显，这个过程可能会很繁琐和耗时，但最终这将被证明是一个严重的限制。在游戏中我们最终有大约 60 种不同类型的兴趣源，并且这个依赖程序员的过程可能严重阻碍了开发。



其次，没有考虑多个智能体对同一个兴趣点的反应。如果你发出很大的噪音，附近的每个人都会跑过来，这在某种程度上是有道理的，但如果你只是打破了一盏灯呢？四个守卫都走过去呆呆地盯着灯，各自在心里想着应该有人对此做点什么，这有意义吗？



如果一群站在一起的智能体检测到一个兴趣源，理想情况下，那个 “群体” 中的一两个（关于忍者如何处理群体，请参阅 2.5 节以获取更多信息）会被派去检查，而其余的则只是保持警觉并在后面等待搜索结果。这不仅感觉更自然，还为玩家提供了更有趣的游戏机会，让他们能够分散紧密聚集的守卫，并在黑暗的角落单独对付他们，而不是跑进一个灯火通明的房间被五个拿着自动武器的人射杀。

## 32.3 感官



我们确定，从根本上说，我们的智能体需要检测世界上的兴趣源有两大类，它们能看到的事物和能听到的事物，这就给了我们两种感官：视觉和听觉。



视觉检测涉及一系列检查，包括以下问题：兴趣源是否在智能体的视野锥内？与兴趣源相关的游戏对象当前是否被光源照亮，或者智能体是否有夜视标志从而无需此要求？在智能体眼睛位置和兴趣源位置之间是否有任何阻挡视线的碰撞？



如图 32.1 所示，视野锥通常由相对于智能体眼睛位置的偏移和方向、定义其宽度的角度以及最大距离来定义。其他视野几何形状也是可能的；我们有一些只是单一光线、整个圆、或用于特定目的的正方形或梯形。



对于声音，检测是通过从兴趣源位置到智能体头部位置的寻路来确定的。当设计师从我们的关卡编辑器导出关卡时，其中一个步骤是从关卡内的所有空白空间生成一个三角形网格（我们还生成关卡内所有固体碰撞的反向网格，用于渲染地图）。我们在运行时使用这个 “声音网格” 从 “声音” 兴趣源到任何可能听到它的智能体执行 A * 寻路 [Millington 06]。



音频系统在玩家角色和世界内的声音事件源之间执行相同的寻路操作，以确定要应用的过滤量。声音和地图网格都是使用 Jonathan Shewchuk [Shewchuk 05] 的 Triangle 程序生成的，该程序生成非常干净的网格，并具有各种有用的选项来控制网格质量、密度和其他对数学爱好者有吸引力的属性。



出于性能和游戏玩法的原因，视觉和声音兴趣源定义了一个最大半径，只有在该半径内的智能体才会被测试以确定它们是否能够检测到兴趣源。

## 32.4 兴趣源的定义



从我们的两种核心感官出发，现在我们可以允许设计师创建一个代表他们想要的任何对象或事件的兴趣源，只要它可以通过视觉或听觉测试被检测到。设计师可以指定 “枪声” 声音、“脚步声” 声音、“尸体” 视觉或 “可疑” 视觉。智能体的行为脚本可以使用指定的兴趣源类型来确定任何特殊行为，但后端只需要知道如何确定智能体是否能够看到或听到兴趣源。



你也可以稍微改变 “视觉” 和 “听觉” 的定义。《忍者印记》中智能体的一个特殊情况是警犬，我们希望它们能够在黑暗中 “闻到” 玩家，但出于游戏玩法的原因，只能在很短的距离内。在这种情况下，不需要创建一个全新的嗅觉测试，我们可以简单地定义一个附着在玩家游戏对象上的视觉兴趣源，并要求任何注意到它的智能体具有 “狗” 标签，如清单 32.1 所示。瞧，我们就有了一个 “嗅觉” 兴趣。

### 32.4.1 兴趣源存在于世界中，兴趣存在于大脑中



兴趣只是智能体大脑中此刻它感兴趣的事物的记录。它可能有一个对创建它的兴趣源的引用（如果有的话），但即使没有，它仍然有所有必要信息的副本，兴趣的感官、源类型、其位置、优先级等等。当确定智能体检测到一个兴趣源时，一个兴趣记录会被添加到它的大脑中，从那时起智能体就使用这个信息。



在《忍者印记》中，虽然视觉和听觉是兴趣源可用的唯一感官类型，但设计师可以通过脚本调用直接将任何任意定义感官的兴趣添加到智能体的大脑中，因为不需要对它们进行额外的测试；设计师或脚本编写者已经确定这个智能体应该对这个事物感兴趣。



例如，当智能体被飞镖击中时，可以在其大脑中添加一个 “触摸” 兴趣，或者如果智能体的伙伴去调查一个声音但没有回来，可以添加一个 “失踪伙伴” 兴趣。

## 32.5 兴趣源驱动的更新和轻量级群体行为



早期出现的一个问题是，当一群智能体同时感知到一个兴趣时，它们应该如何反应。起初是各自为政；每个智能体进行自己的测试，一旦感知到兴趣就会做出反应，很可能是跑去调查它。这通常导致整群智能体朝着最轻微的噪音跑去或一起聚集在玩家周围。这不是我们想要的游戏玩法。我们希望玩家能够操纵智能体，分散它们的注意力，将它们分开，并按照玩家自己的意愿派遣它们。



我们寻找方法，在不明确管理群体行为或协调移动的情况下，让智能体之间有一定程度的明显合作。我们真正只需要守卫在同一时间对同一事物有多种反应。一些应该去调查，一个可能播放一段音频对话告诉附近的另一个守卫去检查，而其他的可能只是看一眼并等待前面提到的守卫处理情况。我们没有从智能体方面驱动这个场景并尝试协调更新，也没有创建一个单独的分组概念，而是选择依赖已经存在的隐含群体：检测到兴趣的智能体集合。



通过从兴趣源本身驱动对兴趣源的检测，而不是从每个智能体单独驱动，我们可以轻松收集我们需要的所有信息，以确定谁应该做出反应以及他们应该如何反应。



感官管理器更新循环针对所有可能的 “检测候选者” 测试每个兴趣源。根据这个列表，它主要根据群体规模做出一些决定，但也可能根据位置或与兴趣源的距离做出决定。如果只有一个智能体能够检测到兴趣，我们的工作就完成了，智能体会收到通知并去调查。如果多个智能体能够检测到兴趣，我们可以为每个智能体分配角色，这些角色与兴趣记录一起存储在智能体的大脑中。角色只在特定兴趣的背景下有意义，当那个兴趣被忘记或替换时，与之相关的角色也会消失。



如果多个智能体能够检测到兴趣，一个被选为 “哨兵” 或 “组长”，他播放音频对话告诉附近的其他智能体去检查兴趣，然后在后面等待。一个或多个智能体被赋予 “调查” 角色并会去调查，看起来是在 “组长” 的命令下。任何剩余的智能体将获得 “旁观者” 角色，可能会表明他们已经看到或听到了兴趣，但否则会保持位置并降低他们心中兴趣的优先级，以便他们更有可能注意到新的兴趣，从而可能被选为组长或调查员。



关键是，一旦角色被分配，感官更新完成，就没有 “群体” 需要管理。每个智能体都独立行动，但由于分配的角色，它们的行为彼此不同，暗示着群体协调。

## 32.6 兴趣优先级



如果你正在调查一盏损坏的灯，然后遇到一具尸体，你应该停下来调查尸体，还是继续查看灯？如果你听到你的伙伴被忍者刺伤，然后在去帮助他的路上发现一盏损坏的灯，你应该停下来调查吗？显然，某些类型的兴趣必须优先于其他兴趣。



兴趣源，以及智能体大脑中的兴趣条目，包含一个简单的整数优先级值，其中较高优先级的兴趣可以替换较低或相等优先级的兴趣，智能体将相应地改变其焦点。如果智能体当前持有高优先级兴趣，较低优先级的兴趣将被丢弃，并且永远不会进入智能体的意识。



在整个开发过程中，平衡各种兴趣的优先级被证明是一项具有挑战性且持续的任务。清单 32.2 显示了项目接近尾声时各种类型兴趣源的优先级，但在开发过程中，由于当前的兴趣优先级设置导致了意外或明显不现实的行为，它们已经多次改变。使它们易于更改和尝试新的组合是一个很大的帮助。



最初，我们认为发现尸体将是游戏中最高优先级的兴趣之一，仅次于看到目标（玩家），但事实证明并非如此。



如果听到一个声音，在调查声音时发现一具尸体，显然关注这个新发现是有意义的。但如果情况相反呢？如果你正在调查一具尸体，然后听到一个声音，你应该忽略它吗？这可能是非常不明智的，特别是如果噪音是从后面快速接近你的脚步声。



事实证明，尸体、噪音和其他各种特定类型的兴趣都应该按照最新优先的原则处理。你最后注意到的可能是最重要的事情。我们的解决方案是简单地将这组兴趣设置为相同的优先级。然而，同等优先级的新兴趣（与你当前的兴趣相同）被视为更重要。



其他兴趣确实比其他兴趣或多或少更重要，无论它们被遇到的顺序如何。看到一个破罐子总是比一个阴影人物或枪声更不有趣。看到你的伙伴被钉在尖刺陷阱上总是比远处玻璃破碎的声音更重要。

## 32.7 调查和可重新发现性



一旦智能体注意到一个兴趣源，它就有机会 “调查” 它，这可能只是看着一盏损坏的灯并评论说它应该被修理。或者它可能涉及看到一个倒下的同伴，跑过去检查脉搏，然后发出警报。



一旦智能体确定一个兴趣源已经被处理，特别是对于像损坏的灯这样平凡的事物，我们真的不希望每个经过的守卫都停下来注意。这会很重复，并且不会产生特别引人入胜的游戏玩法。更糟糕的是，同一个智能体会一次又一次地注意到同一个兴趣源。当智能体完成所需的调查后，与智能体兴趣记录相关的兴趣源被标记为已调查，这会将兴趣源（但不是与之相关的游戏对象）从世界中移除，再也不会被看到或听到。



但这仍然没有完全解决我们的问题；例如，在尸体的情况下，如果你在守卫有机会彻底调查并发出警报之前吸引了正在调查尸体的守卫的注意力，会发生什么？在失去目标后，他可能会转身再次看到尸体。他不应该像刚才那样对看到倒下的同伴感到惊讶。他自然会回去完成他最初的调查，但这最终感觉有点太深入了。我们决定每个智能体一次只能注意到一个兴趣，并且不会有兴趣的堆栈或队列。一旦在任何给定时间处理了最高优先级的兴趣，我们希望情况自然地重置为默认状态，并且守卫不会继续重新访问他们在遭遇过程中可能遇到的每个过去的兴趣源。



默认情况下，我们只希望每个智能体检测或注意到每个兴趣源一次。当这种情况发生时，我们记录这个发现已经发生，并且该智能体将被排除在再次注意到该兴趣源之外。由于我们从兴趣源的方向驱动更新以寻找智能体来发现它们，兴趣源会保留一个发现者列表，并且不会让同一个智能体再次注意到它。



在极少数情况下，我们确实希望同一个智能体多次注意到一个兴趣源，主要的例子是附着在玩家身上的 “可疑” 兴趣源。这个兴趣源可以从比智能体将玩家视为目标的可见距离更远的地方被检测到，因此会吸引他们去调查，而不会立即看到并射击玩家。我们希望每次智能体检测到玩家时都会发生这种情况，所以这个特定的兴趣源被标记为可重新发现，并且它不会费心保留过去谁看到过它的列表。

## 32.8 利用兴趣进行轻量级智能体脚本编写



除了允许智能体被动地注意到世界中的事件或物体外，在设计游戏关卡的过程中，在某些情况下需要一定程度的脚本化遭遇。在某些情况下，脚本编写非常严格；你希望智能体在特定时间和特定地点播放特定动画。对于这些情况，会创建更具体的关卡脚本。



然而，在其他时候，设置一个更自然的情况并让它发展是可以接受的或期望的，可能会受到玩家的干扰。与其编写脚本让智能体沿着特定路径到达特定点、播放特定对话等，不如直接在智能体的大脑中添加一个兴趣。然后智能体会正常寻路到他们的目标兴趣点，在途中开门等等。到达目的地后，他会执行他的正常搜索模式。当他到达那里时，他可能会注意到放在那里让他注意的物体，在这种情况下，他可以对其进行评论并像往常一样继续调查或执行其他上下文相关的动作。



这种简单方法的好处是，如果玩家改变了情况的参数，不需要进行特殊处理。也许玩家在智能体到达目标之前分散了他的注意力。或者也许玩家关掉了智能体前往的房间的灯，使他无法注意到他在第一种情况下会注意到的东西，导致他放弃并返回巡逻。对于这些情况不需要编写特殊脚本，因为智能体的行为一开始就不是脚本化的。



在这种情况发生时，智能体遇到的其他物体可以由行为脚本在本地处理，独立于（或结合）智能体的当前兴趣。智能体在遇到门和灯时知道如何打开它们，并且这些动作不需要干扰兴趣处理。



为智能体在世界中可能与之交互的每一个小事物创建一个兴趣是不必要且笨拙的，部分原因是一次只能有一个兴趣的规则。当智能体遇到一扇门时，他不需要对它感兴趣；他的导航和行为脚本简单地确定他需要穿过门并相应地行动，之后他继续调查他当前的兴趣。

## 32.9 局限性和改进



我们发现，对于那些快速重复或交替接收兴趣的智能体，很难实现合理的行为。当智能体的当前兴趣时刻变化时，它应该做什么并不总是很明显。虽然这主要是一个超出兴趣检测范围的问题，但还是进行了一些特殊处理来帮助解决这个问题。具体来说，当获取一个新兴趣时，智能体会将传入的兴趣与当前兴趣（如果有的话）进行比较。如果它是相同的感官、源类型、优先级，并且与之前的兴趣相对接近，那么它不会被视为一个新兴趣，而是更新当前兴趣的计时器和位置以反映新信息。这方面的一个主要例子是玩家在跑步时产生一系列脚步声兴趣。将每一步脚步声都视为一个新兴趣是不可取的。



同样，没有直接支持跟踪单个兴趣源的移动，因为游戏中绝大多数兴趣源都有固定的位置。这对它们的使用施加了一些限制；例如，《忍者印记》中玩家的一个库存物品是一个纸板箱，你可以藏在里面。一种实现方式是当玩家（藏在里面）移动时，给箱子附上一个兴趣源，以此来吸引附近特工的注意。然而，这并没有产生预期的行为，因为大多数兴趣源处理代码和脚本都依赖于兴趣点在被检测到后位置不发生改变。



在 32.4 节中提到了为可能检测到兴趣源的特工提供一个 “条件” 进行评估的想法。这个功能是在项目后期添加的，因此并没有被广泛使用。谨慎使用时，它可以为项目中不可避免出现的所有特殊情况提供额外的灵活性，但必须注意避免在条件中嵌入过多复杂的逻辑，这些逻辑放在其他地方可能更好。

## 32.10 结论



原本旨在处理注意尸体和损坏灯光问题的系统，很快就扩展到了本章所描述的越来越多的其他用途。虽然这个系统绝不是万能的，但它让设计师对游戏角色的行为有了更多的控制，同时减少了对特殊情况脚本编写或程序员干预的需求。总的来说，在兴趣源更新期间分配特工速率的感官检测架构，结合设计师以数据驱动兴趣源定义和优先级的能力，形成了一个简单但灵活的系统，创造了可信的守卫感知，甚至以最小的额外复杂性提供了轻量级的群体行为。