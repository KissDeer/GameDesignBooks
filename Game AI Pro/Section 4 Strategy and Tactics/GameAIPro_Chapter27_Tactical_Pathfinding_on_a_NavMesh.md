# 四杠二、在导航网格上进行战术寻路
**丹尼尔·布鲁尔**

## 27.1 引言
传统的寻路一直专注于找到从A到B的最短路径。然而，随着玩家对真实感的需求增加，这已经不再足够。智能体应该找到从A到B最合适的路径。在动作射击或策略游戏中，这通常意味着最具战术意义的路径 - 即提供最多躲避敌人的掩护并避免友军火力线的路径，而不是最短、最直接的路径。
许多战术寻路解决方案需要常规的路径点网格和大量的视线光线投射检查，以确定两点之间更安全、更隐蔽的路线。然而，常规的路径点网格以内存效率低下而闻名，并且需要检查的路径点数量众多，这增加了运行时寻路的负载，特别是对于战术寻路所需的众多可见性检查。
导航网格（NavMeshes）是网格的替代方法，已成为表示可导航空间的广泛使用的高效表示。本文将介绍一种掩护表示方法和对A*算法的修改，以直接在NavMesh上进行战术寻路。

## 27.2 其他方法
从本质上讲，战术A*寻路可以通过修改导航图中节点的成本来实现[van der Sterren 02]。对敌人可见或暴露的节点应该具有更高的成本，而对敌人隐藏的节点应该具有更低的成本。这样，A*算法将倾向于选择成本较低、更隐蔽的节点，而不是成本高、暴露的节点。遵循这样路径的智能体将显得更加谨慎，尽可能避免进入敌人的视线。
战术寻路的常见做法是使用网格或常规的路径点图。节点的高分辨率和规则间距允许A*算法更好地考虑在行进距离上暴露节点与隐蔽节点的不同成本。这些技术的准确性取决于网格的密度；网格间距越紧密，节点数量越多，生成的路径的准确性越好。高网格密度具有显著的成本，不仅在存储所有节点的内存方面，而且在运行时A*算法需要计算更多节点时的处理方面。
有许多可能的方法来确定特定节点对敌人威胁的暴露程度。关键问题是“站在位置A的敌人能看到我在位置B吗？”在寻路过程中在运行时执行可见性光线投射检查会严重影响性能。详尽的可见性计算可以离线进行，并通过查找表在游戏中存储以供使用[Lidén 02]。随着环境规模的增加和节点数量的增长，这种O（n²）方法需要指数级更大的内存量。
依赖于精确视线光线投射检查的替代方法是使用近似。一种可能的近似是为每个节点存储一个径向距离场[Straatman 05]。这种方法可以通过深度缓冲立方体地图扩展到3D[van der Leeuw 09]。这允许快速查找以近似智能体从世界中指定点在特定方向上可以看到的距离。通过比较两个点之间每个方向的距离，可以确定这些点是否彼此可见。另一种近似形式是将掩护对象光栅化为网格[Jurney 07]。然后可以将敌人的视锥光栅化到网格中，以对暴露在其视线中的路径点添加权重因子。这种光栅化方法也可以用于处理动态、可破坏的掩护。在物体被摧毁后，只需用剩余的物体再次执行光栅化，导航网格将反映当前的运行时变化。
这些近似实际上增强了解决方案对敌人威胁的小移动的鲁棒性。在充满复杂几何形状的环境中，光线投射可能会穿过物体中的小间隙，从而报告清晰的视线，而实际上该位置会被隐藏。相反的情况也可能发生，报告被遮挡的视线，而实际上该位置是可见的。即使对于简单的几何形状，光线投射原点的小调整也可能返回不同的结果。距离场或光栅化掩护网格的低分辨率使这些近似对位置的这些微小变化不太敏感。
导航网格是表示虚拟环境中可导航区域的流行、高效方法[Tozour 04]；然而，在这些导航表示上进行战术寻路并不那么直接。导航多边形的不规则间距和覆盖的大面积导致光线投射测试的整体可见性精度较差。为了克服这个缺点，可以通过从静态NavMesh采样位置在运行时动态计算常规的路径点图[Bamford 12]。这个战术图只需要在世界上发生战斗遭遇的区域本地生成。然而，这确实导致了导航信息的重复，在最坏的情况下，甚至可能需要为两种不同的表示使用单独的、独立的寻路代码。
下面的部分将介绍一种战术寻路方法，该方法可以直接在NavMesh上工作，而无需重复导航信息。

## 27.3 战术寻路方法
该技术分为三个部分。第一部分将处理划分和注释NavMesh的方法。第二部分将处理掩护表示，最后一部分将处理计算A*中导航多边形遍历的成本，以计算更合适的路线。

### 27.3.1 细分和注释NavMesh
在创建虚拟环境的最佳NavMesh表示方面已经进行了很多工作[Tozour 02, Farnstrom 06]，尽管这对于战术寻路的目的不一定是必需的。NavMesh可以更精细地细分，以在具有不同移动属性或战术意义的区域提供更多细节。
移动更困难或更具战术危险性的多边形可以用额外的成本标记，就像在常规网格表示中一样。水域可以标记为“缓慢移动”或“仅可由两栖单位通过”。高草地区可以标记为“提供掩护”。茂密的灌木丛可以标记为“缓慢移动”和“提供掩护”。带有俯瞰阳台的庭院中心可以标记为“脆弱”或“不安全”，以便智能体在穿过该区域时靠近边缘。这些标志和成本修改了寻路算法的遍历成本，以使智能体遵循更合适的路径，而不仅仅是最短的路线。
最佳的NavMesh将由大的凸多边形组成，以便用最少的多边形覆盖最多的可导航空间。前面提到的庭院可以用一个多边形表示，如图27.1所示。这将防止暴露的中心和阳台下覆盖的边缘之间的区别。需要额外的多边形来表示这些区域之间的战术差异。
实现这些好处的一种快速而简单的方法是提供工具，允许关卡设计师用这些额外的细节标记NavMesh的区域。设计师需要能够指定标记区域的轮廓边界，然后这些边界需要在地图的多边形细分中保持固定。在NavMesh生成期间，可以使用地形分析算法来自动执行一些手动标记的繁琐工作，但这超出了本文的范围。在大多数情况下，这种手动标记可能只在非常特定的游戏玩法实例中是必要的，并且下面的一般掩护方法将满足战斗中大多数战术路径需求。

### 27.3.2 掩护表示
游戏关卡中的掩护点通常表示为离散点。这在路径点图导航表示中经常是这样的情况。连接的掩护区域由这些掩护路径点之间的链接表示。相反，将掩护视为连接的线性段而不是离散点可能是有益的。这些线段遵循提供掩护的障碍物的轮廓，并且高度属性可以区分高站立掩护和齐腰高的蹲伏掩护。这个带注释的线段称为“掩护段”，并提供了视线阻挡障碍物的简单多边形近似。
能够快速查找在世界中给定位置的哪个掩护可以为角色提供掩护非常重要。NavMesh中的每个多边形都可以存储一个小表，其中包含影响该多边形的最重要掩护段的索引。每个多边形的掩护段表称为掩护图（CoverMap）。这允许快速查找可以为NavMesh中特定多边形上的角色提供掩护或阻挡视线的对象（图27.2）。
此数据仅是视线阻挡器的近似值，因为仅存储每个NavMesh多边形的最相关掩护。为导航多边形选择掩护段的启发式方法应考虑提供掩护的方向、掩护段与多边形的距离以及该掩护是否已被其他掩护段遮挡。对于允许智能体在战斗中做出更好的战术选择的目的，这种近似就足够了。可以通过增加每个多边形存储的掩护段数量并调整选择标准来提高准确性。

### 27.3.3 寻路
在寻找最短路径时，主要关注的是距离或移动时间。另一方面，战术寻路更关注找到安全的路径。这可以通过采用标准的寻路算法并根据节点对敌人的暴露或隐藏程度来偏向节点遍历成本来实现。通过增加暴露节点的成本，寻路算法将返回一条避免更多这些暴露节点的路线，因此是更隐蔽的路线。下面的方法不会涵盖如何在NavMesh上执行A*，这可以在其他地方找到[Snook 00]，但将重点介绍如何修改A*成本以考虑掩护，以找到更安全的路径。为了清楚地说明概念，算法的核心首先以更简单的2D形式呈现。下一节将解释对算法的一些扩展，以在更复杂的环境中运行。示例NavMesh展示了一些掩护段以及它们如何存储在CoverMap中。
为了开始找到远离敌人的安全路径，算法需要一个可能保护智能体免受敌人攻击的掩护段列表。包含敌人位置的导航多边形可以用于索引CoverMap并获取掩护段列表。当考虑潜在的路径段时，现在可以计算该路径段有多少被敌人隐藏。
下一步是从掩护段（图27.3中的A - B）和连接敌人位置与掩护段两端的线（C - A和C - B）构建一个2D视锥体。所有这些平面的法线应指向掩护后面的背风区域。然后，该路径段被此视锥体裁剪。在所有三个平面前面留下的段部分是路径段的隐藏部分。
对于敌人的CoverMap中的每个掩护段，重复这些步骤。通过将总裁剪长度与原始段长度进行比较，计算出暴露与隐藏的比例。然后，将此比例乘以掩护偏差因子并添加到段的基本成本中，如清单27.1所示。因此，A*搜索将偏向远离暴露段。掩护偏差因子越大，智能体沿着暴露段移动的成本就越高，这将导致它更远地寻找更安全、更隐蔽的路径。
清单27.1还展示了设计师标记和智能体偏差如何影响路径成本。在处理这些时，重要的是要记住，高于1.0的偏差将增加遍历多边形的成本，而低于1.0的偏差将降低它，并可能导致遍历节点的成本低于实际的直线距离。一般来说，应避免这种情况，因为最好保持启发式可接受，并始终修改成本以使节点更昂贵。还应注意不要过度增加成本，因为如果启发式与成本有很大不同，A*算法将探索比必要更多的节点。

## 27.4 将技术扩展到3D
前面介绍的算法适用于2D或略微起伏的地形。这是为了以简单、易于理解的方式呈现核心算法。然而，并非所有环境都如此简单。在高山上的角色将能够越过一些中间的掩护绘制视线。垂直结构可能会证明是有问题的，因为角色可能无法通过地板或天花板绘制清晰的视线，但如果可见性近似仅考虑掩护段，它将不会考虑地板或天花板。幸运的是，该技术可以扩展到处理这些更复杂的环境。
如果地形具有较大的高度变化，可以通过将掩护段视为表示掩护的长度和高度的矩形多边形来获得更准确的结果。可以从敌人的位置和掩护多边形的边缘构建一个视锥体，如图27.4所示。这个视锥体可用于裁剪路径段，以确定该段有多少被遮挡，就像上面介绍的平面示例一样。如果环境包括更多的垂直结构，可能需要在CoverMap中为地板和天花板添加额外的掩护平面。

## 27.5 结论
能够以战术上合理的方式导航环境的智能体可以极大地增强视频游戏体验。对掩护的良好近似对于运行时战术寻路至关重要。使用线性掩护段是推理掩护和阻挡视线障碍物的有效方法。这种表示使得计算每个掩护段遮挡的路径段的多少变得简单。通过将这种掩护表示与NavMesh结合，可以执行快速的战术寻路，而无需诉诸于高内存使用网格、常规路径点图或全面的可见性查找表。
