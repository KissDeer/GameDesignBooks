# 四杠三、超越功夫圈：管理NPC攻击的灵活系统

**迈克尔·达维**

## 28.1 引言
具有实时战斗的动作游戏在处理难度和玩家挑战时需要达到一种有趣的平衡。通常，此类游戏可能会有遭遇战，其中一群对手会攻击玩家，并且通常具有不同类型的攻击。从游戏设计的角度来看，这可能是可取的，原因包括总战斗持续时间到叙事要求等。然而，经验不足的玩家可能会被同时攻击的敌人数量压倒，因此这些游戏通常限制对手一次攻击一个。
对于《阿玛拉王国：惩罚》（Kingdoms of Amalur: Reckoning），游戏设计要求在传统RPG设置中实现真正的动作游戏，同时有大量敌人同时攻击玩家。在评估了几种限制战斗遭遇中攻击者的方法后，我们使用了一种技术，能够根据攻击者本身和玩家选择的难度级别动态地改变攻击者的数量，甚至允许对玩家进行攻击的类型。

## 28.2 功夫圈
要求对手一次攻击玩家一个的技术被称为功夫圈，以武术电影中的经典场景命名，其中主角面对数十个敌人，他们一次发动一次攻击。这是一种简单的算法，易于编写和使用，并且在游戏中希望专注于单个对手时是有意义的。然而，这种限制对于战斗节奏快的游戏可能过于严格。为了允许更快的战斗节奏，并给玩家使用更广泛影响的区域攻击的机会，放宽这些限制并允许一次有多个敌人攻击是有利的。一种天真的方法可能是简单地允许两个或三个敌人同时攻击，但这不会考虑不同的敌人类型或他们攻击的相对强度。对于《惩罚》，我们采用了一种内部称为“比利时AI”系统（之所以这样称呼，是因为用于描述该算法的标志性华夫饼草图）的方法，允许战斗团队设计使用各种生物的遭遇战，同时始终使用相同的基本规则来确定同时允许攻击的生物数量和类型。

## 28.3 比利时AI
在高层次上，比利时AI算法围绕着一个与游戏中每个生物一起携带的网格的想法构建。虽然每个NPC都有自己的网格，但实际上玩家是我们最关心的游戏实体，因此在本文中我们将以玩家为例。网格与世界空间对齐并以玩家为中心，有八个用于攻击生物的空插槽，就像一个以玩家为中心的井字棋棋盘。除了这些插槽的物理位置外，网格还存储两个变量：网格容量和攻击容量。网格容量将限制一次可以攻击玩家的生物数量，而攻击容量将限制他们可以使用的攻击数量和类型。
游戏中的每个生物都被分配了一个网格权重，这是该生物被分配到某人网格上的一个点的成本。攻击角色的生物的总网格权重必须小于该角色的网格容量。同样，每个攻击都有一个攻击权重，并且在任何时候针对角色使用的所有攻击的总权重必须小于该角色的攻击容量。
展示这些变量影响的最简单方法是描述它们在行动中的一个示例。让我们看一个情况，其中一个敌人士兵意识到玩家并决定发动攻击。在这样做之前，士兵需要请求一个他可以攻击玩家的位置。对于《惩罚》，我们将所有空间推理排除在单个生物之外，并由一个名为舞台管理器的中央AI负责处理战斗中生物的定位。因此，我们的士兵将向舞台管理器注册攻击玩家的请求，并等待被分配一个位置。在其下一次更新时，舞台管理器将处理请求并将士兵的网格权重与玩家当前的网格容量进行比较。对于我们的示例，我们假设士兵的网格权重为4，玩家的网格容量为12。由于士兵的网格权重小于可用网格容量，舞台管理器将为士兵分配最接近的可用网格位置，并将玩家的可用网格容量减少到8。现在士兵有许可接近玩家并发动攻击。图28.1展示了此时网格可能的样子。
接下来，假设一个巨魔注意到玩家。与士兵类似，巨魔必须向舞台管理器请求网格上的一个位置，但由于巨魔比普通人类更大更强，巨魔的网格权重为8，是我们普通士兵的两倍。由于这仍然在玩家的可用网格容量内，舞台管理器可以为巨魔分配一个插槽，并将玩家的可用网格容量减少到0。现在当另一个士兵过来时（图28.2），他可以请求一个攻击玩家的位置，但舞台管理器不会为他分配一个插槽，因为他的网格权重大于玩家的可用网格容量。这个第二个士兵不能接近玩家，必须在网格区域外等待。
攻击容量和权重的工作方式类似，但针对单个攻击。到目前为止，在我们的示例中，巨魔和士兵都被允许攻击玩家，但他们还没有选择使用的攻击。假设玩家的攻击容量为10。巨魔可能有两个攻击可供选择：一个强大的冲锋攻击，攻击权重为6，和一个较弱的棍棒攻击，权重为4。由于玩家的攻击容量为10，巨魔可以选择冲锋攻击并通知舞台管理器，这将玩家的攻击容量减少到4。现在士兵从他的攻击中选择：一个冲刺攻击，成本为5，或一个剑挥攻击，成本为3。由于玩家当前的攻击容量为4，他无法使用冲刺攻击，所以这次他必须满足于剑挥攻击。

### 28.3.1 网格扇区、内圈和外圈
尽管算法通常指的是网格位置，但更自然的是将网格插槽视为定义与玩家等距的位置，形成一个距离玩家任意距离的圆圈。对于《惩罚》，我们进一步将网格细分为内圈和外圈，我们称之为“攻击”和“接近”圆圈。攻击圆圈的半径由近战攻击的最小和最大距离定义。当一个生物首次通过网格容量检查并被允许接近玩家时，它将移动到接近圆圈内站立。当它被允许执行特定攻击（如巨魔的冲锋或士兵的剑挥）时，它将移动到攻击圆圈内进行攻击。同时，尚未通过网格容量检查的角色（如我们之前示例中的第二个士兵）将站在接近圆圈外，等待他们介入的机会。这有助于玩家确定哪些生物是直接的近战威胁。图28.3展示了它可能的样子。

## 28.4 行为集成
为了充分利用网格系统，《惩罚》中的生物具有一系列特定的共同行为来执行定位和攻击规则。这也增加了行为的重用，因为任何可以使用近战攻击的生物都将共享这些共同的行为集。
首先，任何在外圈距离内但没有攻击许可的生物必须尽快离开圆圈。这有助于玩家清楚地知道哪些生物在攻击。此外，它还可以防止怪物在实际攻击时相互妨碍。
在网格外等待但未分配网格插槽的生物不被允许接近，但会被给予网格上当前未被占用的插槽的位置。生物会尝试站在他们给定的插槽前面，即使他们没有攻击许可，这使得自然的侧翼行为无需任何生物明确知道战斗中的其他生物。
最后，生物在发动攻击后会立即将其网格插槽的控制权交还给舞台管理器。因此，舞台管理器可以排队攻击插槽的请求，并在整个战斗遭遇中轮换允许攻击的生物。这使得生物在玩家的直接近战范围内进出移动，并确保没有单个生物可以垄断攻击机会。在遭遇战中生物数量较少的情况下，任何在攻击后放弃其位置的生物都可以立即再次被分配一个插槽。内圈和外圈的方法。被分配网格插槽的生物移动到外圈上其分配的部分，但只有发动攻击的生物才被允许进入最内圈。任何未分配插槽的生物必须在外圈外等待。

## 28.5 难度缩放
网格容量和攻击容量共同作用，限制了在任何给定时间可以对玩家发动的生物和攻击的数量和类型。这个系统的一个优点是，通过改变玩家的网格容量和攻击容量，可以立即实现难度缩放，而无需改变为每个生物精心平衡的单个网格和攻击权重集。当玩家在《惩罚》中增加难度时，我们相应地扩大了网格和攻击容量。网格容量的变化允许更多的生物在战斗中包围玩家，而攻击容量的变化允许更多的生物同时攻击，并使用更强大的攻击。

## 28.6 其他考虑
虽然比利时AI足够直接，但需要注意确保它与快节奏的动作战斗游戏配合良好。此外，可能还有其他关于生物及其攻击的设计目标，该系统可以适应这些目标。

### 28.6.1 在世界中维持网格分配
如前所述，网格是面向世界的，因此网格上的插槽会随着玩家移动。有时，这会导致生物被分配的插槽不再是离他们最近的插槽的情况。当玩家躲避攻击滚向其他生物时，这种情况经常发生。
为了解决这个问题，我们赋予舞台管理器对网格上插槽分配的完全控制权。在任何给定的帧上，它可以决定将哪些生物分配到插槽中，以最好地利用玩家的网格容量。在空网格的情况下，生物可以被分配到离他们当前位置最近的插槽。如果生物已经在网格上，舞台管理器可以分配一个不是最近的插槽，或者可能会转移已经分配插槽的生物的分配，为新来者腾出空间。生物永远不会记住他们的网格插槽分配，并且负责每帧与舞台管理器检查以获取他们当前的插槽分配。
之前被确定为攻击玩家的最佳选择的生物也可能突然不再是最佳选择。例如，假设玩家之前遇到了巨魔和士兵，第二个士兵在网格外等待攻击。如果玩家突然向目前没有攻击许可的第二个士兵移动，那么最好是舞台管理器将攻击许可从第一个士兵转移到第二个士兵，以利用第二个士兵的新位置。
为了解决这个问题，舞台管理器可以“窃取”一个生物的插槽分配给另一个生物，或者以其他方式重新分配生物，只要它认为合适。在实践中，这被调整为除非分配的生物在攻击网格之外，而其他生物在网格空间内，否则它倾向于让有攻击许可的生物单独留下，在这种情况下，生物分配将发生转移。转移也可能发生，以便将攻击生物移动到网格上的不同位置。这种转移将尝试减少所有生物到其在战斗中分配位置的总旅行时间。此外，正在积极发动攻击的生物将与舞台管理器“锁定”其分配，因此他们在攻击期间不会失去插槽，并且不会意外地使玩家的攻击容量过载。这样的算法可能如下所示：
攻击列表 = 所有攻击生物
对于攻击列表中的每个生物
找到生物的最近插槽
如果最近插槽被锁定，继续
将最近插槽分配给生物
从攻击列表中删除生物
如果最近插槽已经被分配，
从该生物中删除分配
### 28.6.2 对敌人攻击的进一步限制
虽然攻击容量限制了同时发动的攻击总数，但它并不能防止许多生物同时发动相同类型的攻击，特别是在难度较高的级别，攻击容量增加，尤其是在遇到许多相同类型的生物时。为了帮助确保在给定的战斗遭遇中发生各种攻击，《惩罚》还在个体、生物范围和全局基础上施加了冷却时间，以防止生物在彼此的特定窗口内发动太多相同的攻击。这在最困难的设置中对保持游戏平衡非常有帮助，因为即使攻击容量增加，特定的敌人也可以被阻止同时使用太多的区域效果类型攻击。

## 28.7 结论
管理游戏难度是一个值得认真考虑和研究的领域。虽然重要的是不要让学习游戏的玩家不知所措，但灵活的系统对于为更有经验的玩家提供具有挑战性的游戏玩法至关重要。像这里介绍的基于网格的简单方法可以帮助游戏设计师创建不同且有趣的遭遇战，只需调整一小组初始值，就可以为多种难度级别进行缩放。
虽然该算法的实现足够简单，但其真正的优势在于定位逻辑集中到舞台管理器。仅仅让角色从他们未被分配的插槽中移出的行为就可以使角色进行侧翼攻击并避免彼此，但很容易看出这个算法如何容易地与影响力地图技术配对，以帮助角色更自然地避免彼此并在战场上移动。其他技术也可以类似地与战斗网格的想法结合，以根据单个游戏的需求定制该技术，同时保持自适应难度级别的灵活性。