# 四杠四、《杀戮地带3》中多人游戏机器人的分层AI
**雷姆科·斯特拉特曼**、**蒂姆·维韦伊**、**亚历克斯·尚潘达德**、**罗伯特·莫库斯**和**希尔克·克莱夫**

## 29.1 引言
第一人称射击（FPS）游戏通常包括单人战役和大型竞争性多人游戏组件。在多人游戏中，一些玩家的位置可以由机器人（bots）占据，这些由AI控制的玩家模仿人类玩家进行训练。本节描述了为《杀戮地带3》（Killzone®3）创建机器人所使用的AI技术，这是一款在Playstation®3上发布的战术FPS游戏。

《杀戮地带》的机器人既用于游戏中只有一两个人类玩家的离线训练模式，也用于有任意数量人类和机器人玩家的多人游戏。《杀戮地带》的主要多人游戏模式“战区”（Warzone）具有许多功能，例如在同一地图上连续进行多种基于团队的游戏模式以及基于类别的玩家能力，这导致了对AI的特定要求。所选择的方法受到策略游戏中AI技术的启发（分层指挥链AI、使用影响力地图），并且严重依赖于为我们的单人战役开发的规划和位置选择技术。

在本文中，我们描述了系统的范围、所选的架构以及架构的三个层次。我们提供了构成各个层次的技术的详细信息，并描述了我们如何建模行为。我们通过描述我们的经验、实验和未来方向来结束。

## 29.2 范围
“战区”让两支队伍（称为ISA和Helghast），每队最多12名玩家相互对抗。在一张地图上的一轮比赛中，七种不同的游戏模式以随机顺序进行，赢得最多游戏模式的队伍赢得该轮。游戏模式包括：
- 捕获并坚守（队伍通过控制地图上的物体获得积分）
- 杀敌数（队伍争夺最多的杀敌数）
- 搜索并取回（两支队伍都试图将一个物体归还到各自的返回点）
- 暗杀（攻击队伍试图消灭对方队伍中的一名特定玩家）
- 搜索并摧毁（攻击队伍试图摧毁防守队伍的一个物体）

最后两个游戏模式会进行两次，每个队伍扮演一次防守角色。

玩家和机器人可以选择五个类别中的一个，这使他们能够使用特定的武器和能力。例如，工程师类可以放置自动炮塔，而医疗兵类可以治疗队友。其他能力包括呼叫飞行无人机、伪装成敌人、隐身、放置地雷等。

每张地图包含许多战术重生点（TSPs），可以被战术家类捕获。团队成员可以在捕获的TSPs处重生。固定位置上放置了固定枪、弹药箱和车辆（称为Exos的外骨骼）；工程师可以摧毁或修复这些，以便团队可以使用。对于加入“战区”的新玩家来说，有很多东西需要学习。为了帮助玩家的学习过程，机器人应该模仿有经验的人类玩家，掌握地图，使用能力，并共同努力赢得每个特定的游戏模式。他们应该展示高水平的策略、战术和能力的适当使用。

## 29.3 架构
多人AI系统被设置为三层层次结构，其中每一层控制下面的一层，信息从下层流回上层。图29.1说明了该架构。每个团队都有一个负责其机器人玩家的层次结构。策略层负责玩当前的游戏模式，并包含指挥官AI。指挥官监控游戏模式的状态，将机器人分配到小队，并发布目标。小队层包含每个小队的AI。小队AI负责将目标转化为其成员的命令、团队移动和监控目标进展。在最低层，个体层由机器人的个体AI组成。机器人AI遵循小队命令，但在如何执行这些命令方面有自由。机器人AI主要处理战斗和使用其类能力。

层之间的通信包括向下的命令和向上的信息。指挥官可以命令小队攻击区域、防御区域、护送玩家或前进到重组点。小队将向指挥官报告命令的成功完成或即将失败的情况，例如，当小队在攻击中被歼灭时。小队将命令其成员移动到一个区域、攻击一个目标、使用一个特定的物体或限制机器人到特定的区域。机器人将报告命令的完成情况并发送关于观察到的威胁的信息。

前面的部分展示了范围和总体架构。以下部分更详细地描述了个体、小队和指挥官AI层。

## 29.4 个体机器人AI
在层次结构的最低层，我们找到了每个机器人的个体AI。尽管机器人从小队那里得到命令，但它们仍然是高度自主的智能体。小队不会微观管理每个机器人；机器人收集信息并决定如何履行其角色。例如，机器人可以选择自己的攻击目标、攻击的位置、使用的武器等。他们也可以决定暂时忽略命令以生存。机器人拥有与人类玩家相同的武器和能力。

### 29.4.1 个体更新循环
机器人AI采用典型的基于智能体的方法，如图29.2所示。首先，NPC通过感知或其他团队成员的消息收集关于当前世界状态的信息。智能体通过各种传感器感知游戏世界中的刺激。有不同的传感器用于看、听和感觉，以及不同类型的刺激（视觉、声音和接触）。传感器具有诸如视锥和最大距离等限制。有关感知系统的一般信息，请参阅[Puig08]。隐身和伪装等能力进一步影响感知，并使AI做出可信的反应。来自感知的威胁信息被放置在每个个体的世界数据库中。由于感知的限制，机器人对世界的看法可能是可信的错误。除了来自其他智能体的感知和消息外，一些守护进程会用其他数据填充智能体的数据库。守护进程是一个组件，它添加关于特定类型信息的事实，例如机器人的武器和健康状态。

在下一步中，规划器要么生成一个计划，要么继续执行当前的计划。一个计划由一系列任务组成。机器人可用的任务集对于射击游戏来说是典型的（例如移动到目的地、选择武器、重新装填武器等）。

每次更新时，计划的当前任务都会被执行。任务的完成将计划推进到下一个任务，而失败将使整个计划无效。执行任务会更新负责协调更低粒度动作（如看、瞄准、行走、蹲伏等）的低级技能规划器。技能最终会更新机器人的虚拟控制器，这是机器人和玩家共享的控制其人形游戏角色的接口。虚拟控制器强制在AI和游戏引擎之间进行严格分离，因此AI代码不会直接控制动画或枪支，从而确保机器人的能力与玩家的能力相同。

### 29.4.2 个体规划器
我们使用基于分层任务网络（HTN）规划器架构的自定义规划器[Nau 00]。选择这个规划器是因为它可以很好地控制可以生成的计划，并明确计划之间的优先级定义。

个体的行为在HTN中由一个域定义，该域由常量和方法组成。一个方法通过定义一个分支列表来定义实现一个任务的一种或多种方式。每个分支都有一个前提条件和一个由任务列表组成的分解。一个任务可以是原始的，意味着它可以由智能体执行，或者是复合的，意味着它需要使用一个方法进一步分解。

规划开始于为顶级任务实例化一个计划。该任务的方法的分支按列出的顺序尝试。当一个分支的前提条件匹配时，规划器递归地尝试为该分支的计划中的所有复合任务创建计划。规划器将回溯分支、前提条件的变量绑定和复合任务的计划实例化。结果计划是第一个完全由原始任务组成的计划。

原始任务修改其智能体的内存，使机器人在世界上做事，并添加用于调试的信息。表29.1显示了一些原始任务。

清单29.1展示了炮塔（使用与机器人相同的规划器）用于选择武器来射击某些威胁（由变量?threat表示）的方法。变量前缀为问号，常量前缀为@符号，关键字call在C++函数调用之前。炮塔的每个武器都有自己的分支，其前提条件与智能体的世界数据库中的事实匹配（例如，distance_to_threat），导致局部变量的实例化（例如，?dist）。两个分支的计划都包含一些原始任务和一个复合任务（select_weapon）。为了形成一个实例化的计划，这个复合方法需要通过另一个方法进一步分解。

清单29.1还展示了如何将信息请求（request_line_of_attack）作为前提条件的一部分；结果将被放置在数据库中，并在接下来的条件（line_of_attack）中进行测试。

对于机器人，计划生成总是从一个根任务（称为behave）开始。域中的方法决定了可以生成的计划以及尝试它们的顺序。清单29.2展示了导致医疗兵机器人计划使用复活工具复活队友的最终分解。

分解说明了HTN规划器解决计划的方式，也说明了域的结构方式。

最终计划由分解中的所有原始任务组成。从behave开始，第一个分支决定在车辆中或步行时的行为，然后在自我保护行为（如逃离手榴弹）和执行其类能力之一（复活）之间进行选择。

如上所述，规划从根节点开始，为behave生成一个计划。它通过按照指定的顺序遍历behave的分支来实现这一点，因此例如在考虑治疗友方的分支之前，会先考虑与自我保护相关的分支。如果它选择了一个包含复合任务的分支，规划器将递归地为该分支生成一个计划。

一旦规划器完成，智能体就可以执行该计划。每次更新时，计划中的当前任务都会被执行。当前任务可以在成功并推进到计划中的下一个任务之前继续运行多个更新，或者失败。如果计划已经到达终点或任务失败，智能体需要生成一个新计划。

实际上，确保智能体的计划在不断变化的情况下仍然是最佳的更加复杂。因此，智能体以固定的速率重新运行规划器，如果找到更好的计划（即，遍历的分支比当前计划中的分支更高），则替换当前计划。例如，如果AI在治疗伙伴的过程中重新规划，并且发现附近有手榴弹，它将中止治疗，转而选择自我保护分支（如逃离手榴弹）。

计划也会在不再相关时被中断。例如，如果AI正在朝着它想要治疗的伙伴跑去，但该伙伴已经死亡，那么是时候选择一个不同的计划了。这是通过向域添加包含“延续条件”的额外分支来实现的。当计划处于活动状态并且计划的延续条件满足时，这些分支将被选中。它们包含一个单独的continue任务，这让规划器知道不需要进一步的规划，并且当前计划仍然是最好的。

在这个一般的规划和推理框架内，域需要特定的信息来做出良好的战术决策。下一节将简要描述可用的信息类型以及它们的使用方式。

### 29.4.2 个体战术推理 - 路径点图和掩护数据
我们的单人及多人游戏机器人战斗推理的基础是路径点和掩护数据的结合。路径点图定义了路径点（具有战术数据的位置）以及它们之间的链接，允许AI规划路径和导航。这个路径点图是由我们的自动化工具生成的（在[Mononen 11]中描述）。对于每个路径点，存储了描述每个方向可用掩护的掩护数据。掩护数据是在离线过程中自动创建的。

这些数据与关于威胁的动态信息相结合，用于各种战术决策。例如，通过位置选择来选择攻击威胁的合适位置，其中路径点图用于生成附近的潜在路径点，并根据一些属性对这些候选点进行评分。属性可以包括来自已知威胁的掩护、与威胁或友方的距离、对威胁的视线、到达该位置的行进距离等。对于不同的行为，可以不同地指定使用的属性以及它们如何影响得分。此数据的另一个用途是威胁预测，其中计算隐藏威胁最可能的隐藏路径点。我们的智能体的战术推理在我们之前的工作中已有更详细的讨论[Straatman 06, Van der Leeuw 09]。

这些战术服务以多种方式提供给域。位置选择或路径规划查询可以用于分支的前提条件中，并将用最佳位置或路径实例化变量（如果有）。分支前提条件中可以查询威胁的预测位置，并且计划可以以各种方式使用由此产生的隐藏路径点列表，例如，搜索或扫描威胁。通过这种方式，我们将更具体、优化的战术问题求解器与一般的HTN规划器相结合，以生成战术行为。

## 29.5 小队AI
上一节描述了我们的自主机器人如何在战斗和能力使用方面做出决策。现在我们转向小队，它将使这些机器人作为一个团队一起工作以实现一个目标。小队是一个控制一组机器人的智能体。小队AI结构类似于个体的结构：它将信息收集到世界状态中，使用HTN规划器生成和监控计划，并执行该计划中的任务。区别在于收集的数据、域和原始动作。

### 29.5.1 小队更新循环和规划域
在数据收集期间，小队AI收集关于其成员状态的信息。然而，小队不是使用感知来收集这些信息，而是基于从其成员接收的消息来构建其世界状态。基于这个状态和指挥官AI给予它的命令，小队规划器生成一个计划。小队不是直接行动，而是通过其成员行动。因此，它的大多数原始任务只是向成员的命令队列发送一个命令。表29.2显示了一些这些原始任务。

每个小队和个体都有一个命令队列（类似于RTS单位）。新到达的命令会覆盖现有的命令，除非它们是序列的一部分，在这种情况下它们会被排队。个体的域将尝试处理当前命令，并在命令完成时将其从队列中删除。

清单29.3展示了小队方法的一部分，用于让一个成员防御一个区域。分支advance负责小队需要移动到必须防御的区域的情况。该计划首先重置小队关于成员正在做什么的簿记，然后命令成员留在小队路径查找器定义的区域内（在下面讨论），命令成员移动到防御位置，命令成员向小队发送消息（以便小队知道它到达），并在到达时命令成员留在防御区域内。

如前所述，当个体机器人AI的当前命令为DefendMarker时，它的规划器可以制定不同的计划来实现这一点。处理此命令的方法的分支指定了角色类特定的计划和普遍适用的计划。工程师特定的分支指定：“移动到那里，在附近放置一个炮塔”，战术家特定的分支指定“移动到那里，呼叫哨兵无人机”，而通用分支只是指定“移动到那里，环顾四周”。通用分支始终可用，因此在工程师放置他的炮塔后，他可以生成一个环顾四周的计划。

与个体机器人类似，小队规划器需要关于世界静态和动态方面的信息来制定战术计划。下一节将描述小队可用的战术推理。

### 29.5.2 小队战术推理 - 战略图和影响力地图
小队AI使用战略图来推理地形。这是路径点图的分层总结，由区域（路径点组）和区域之间的连接组成。当路径点图中两个区域的路径点之间存在链接时，两个区域之间就存在连接。这确保了当战略图中区域之间存在路径时，路径点图中也存在路径，反之亦然。战略图提供的细节抽象使小队推理更有效率。这是必要的，因为小队的计划通常覆盖更大的区域，有时甚至是整个地图，如果在路径点图上进行，这将非常昂贵。由于我们不想微观管理个体机器人，在区域级别进行推理也为个体机器人在路径点级别进行战术推理时留下了选择。

战略图是在导出时自动从路径点图生成的。聚类算法从每个路径点一个区域开始，逐步将区域组合在一起。聚类是基于连接属性、区域中的路径点数和区域表面进行的。这个过程导致了具有良好路径查找属性的逻辑区域。类似的聚类算法在其他地方也有描述[van der Sterren 08]。

影响力地图提供动态信息来补充战略图。每个派系更新自己的影响力地图。该地图为每个区域分配一个影响力浮点值，表示该区域是在敌人还是友方控制之下。影响力地图是策略游戏中的标准技术，并已详细记录[Tozour 01]。影响力地图是通过计算区域内友方和敌方机器人和玩家的数量以及自动炮塔和无人机来计算的。最近的敌方和友方死亡也会改变影响力值。接下来，根据距离对这些值进行平滑处理，并与影响力地图中的先前值结合进行时间平滑。

每个小队都有一个战略路径查找器。在战略路径查找中使用影响力值可以使小队避免敌人控制的区域。另一个用途是选择重组标记，这是目标附近的安全位置，小队将在这里聚集进行攻击。在选择重组标记时，会考虑包含每个标记的区域的影响力地图值。此外，对于任何友方小队选择的区域会给予惩罚，这为重复攻击提供了变化，并分散了同时进行的攻击。

路径查找器被实现为一个单源路径查找器，它使用小队的位置作为源计算到关卡中所有区域的成本。图29.3说明了这个路径查找器的结果。

这种方法允许小队HTN规划器在规划时进行许多位置和路径查询。小队路径查找器返回一个战略路径（区域序列），然后通过将小队成员限制在这些区域内，将其用作小队成员的走廊。这些限制约束了个体路径规划和位置选择可用的路径点图的部分，这允许个体机器人在考虑小队更全局的战术决策的同时做出自己的决策。此外，走廊限制了个体路径规划的搜索空间，从而提高了性能。

战略路径规划器使用随时算法进行增量更新，以最小化性能影响[Champandard 02]。在小队级别，增量性质不太重要，因为更新不太频繁需要。

## 29.6 指挥官AI
我们的AI系统的最高层是两个派系（Helghast和ISA）各自的指挥官AI。指挥官理解如何玩游戏模式，并将根据正在玩的特定模式为小队分配目标和机器人。由于派系中机器人的数量不同，游戏模式中的多个目标以及战术重生点（TSPs）和车辆等方面，指挥官必须能够创建策略的新变体；固定的游戏模式策略是不行的。

### 29.6.1 指挥官目标和分配
指挥官由三个部分组成：
1. 一个特定于游戏模式的部分，用于生成目标。
2. 一个用于将目标和机器人分配给小队的系统。
3. 一个用于监控分配给小队的目标的系统。

指挥官可以创建小队、删除小队、重用以前的小队、将机器人分配给小队、重新分配机器人以及将目标分配给小队和个体机器人。有四种类型的目标：AdvanceToWaypoint、DefendMarker、AttackEntity和EscortEntity。每个目标都有一个权重，表示其相对于其他目标的重要性，以及一个最佳机器人数量。

任务特定的AI由C++类组成，每个任务类型一个。这些类使用来自游戏状态的当前信息添加和删除目标。例如，捕获和坚守模式的类需要攻击或防御三个可征服区域的目标。最初的目标将是捕获所有三个区域，但如果一个派系在得分上领先并拥有三个区域中的两个，它可以决定只为已经捕获的区域生成防御目标。

对于搜索和摧毁，为两个可摧毁目标中的每一个添加目标。目标的类型取决于指挥官的派系是防守方还是攻击方。

在搜索和取回中，有一个物体，两个派系都希望将其归还到自己的基地。当物体未被认领时，将生成一个目标，以推进到物体的位置。如果它被认领，持有派系将为携带者创建一个护送目标，而另一个派系将创建一个攻击携带者以夺回物体的目标。两个派系都可能决定添加目标来防御敌人的基地，以防止归还物体，或攻击自己的基地，以使（未来的）携带者更容易归还。

一些目标与所有游戏模式相关。战术重生点很重要，因为重新生成的团队成员到目标的旅行距离更短，因此捕获或防御它们也是一个较低优先级的目标。此外，一个关卡包含车辆（称为Exo），因此有一个使用车辆骚扰的目标，这将使乘坐车辆的机器人攻击最重要目标附近的敌人。

指挥官是根据多人游戏设计师和QA测试人员的输入进行自定义编码的。通过指定当前目标的列表，可以使游戏模式的指挥官根据需要变得简单或微妙，而指挥官的代码保持较小。

将机器人和小队分配给目标的算法如下：
1. 计算机器人的理想分布，然后是小队的理想分布。
2. 如果必要，创建新的小队。
3. 如果以前的分配给任何一个目标分配了太多的小队，则删除多余的小队。
4. 为每个小队分配最佳目标。
5. 如果太多的机器人被分配到特定的小队或目标，则取消分配它们。
6. 将每个自由机器人分配给最佳小队。

在步骤1中，所有活动目标的权重和所需的机器人数量用于计算所需的小队数量及其大小。步骤2和3确保实际的小队数量尽可能接近所需的数量。步骤4优先将小队分配给先前分配的目标，否则根据小队与目标之间的距离进行分配。重新分配到新目标的小队可能有太多的机器人，因此步骤5使这些额外的机器人离开他们的小队。步骤6负责将所有没有小队的机器人分配给最接近的需要更多机器人的小队。当机器人即将重生时，可以将其分配给小队，然后它将选择到其小队的旅行成本（包括影响力地图成本）最佳的重生点。机器人在重生时的类选择是通过固定的启发式算法完成的。这确保了由于战术家和工程师对于实现目标的重要性，会有一些战术家和工程师，并且随机为其余的机器人分配一个类。

### 29.6.2 指挥官战略数据
指挥官AI使用一些关卡注释来做出更好的特定于地图的战略决策。我们选择手动放置这些注释，因为它们需要复杂的地形推理来自动生成，但通过观察游戏测试可以很容易地为每个地图识别它们。一些注释也被下层的小队和个体AI在制定他们的计划时使用。

通用关卡注释包括：
- 重组位置，这是控制良好的战略位置。小队被派到这里在攻击前组成。
- 狙击位置，指定对关键位置有良好可见性的区域。小队被派到这里帮助防御或攻击目标。

任务特定注释包括：
- 暗杀隐藏位置。这些标记指定了目标机器人在暗杀任务中隐藏的好位置。好的位置通常在可防御的建筑物内。防守队伍的指挥官最初选择其中一个位置，并可能根据距离和影响力地图后来决定将目标移动到另一个位置。
- 防御位置。具有静态目标的任务，如捕获和坚守，使用这些位置来定义防御者应该站立或巡逻的位置。

我们之前的工作包括关于注释使用的更多细节[Straatman 09]，以及关于架构本身的更多细节[Verweij 06]。

## 29.7 AI在行动
例如，在捕获和坚守任务中，ISA指挥官可能会派遣一个小队去防御一个捕获点，另一个小队去占领附近的战术重生点（TSP），第三个小队（由一名操作Exo车辆的机器人组成）去骚扰捕获点附近的任何敌人。攻击TSP的小队计划从基地出发的路径，避开Helghast拥有的另一个捕获点。到达后，战术家占领TSP，工程师在TSP附近的防御标记上放置一个炮塔。占领TSP后，战术家和工程师将巡逻并扫描该区域以进行防御。同时，防御捕获位置的小队受到了攻击。作为回应，战术家呼叫无人机来帮助防御。个体机器人使用掩护数据来寻找掩护和攻击位置。ISA医疗兵使用他们的复活工具来复活受伤的同志。工程师在需要时修复支持的Exo。没有幸存的ISA防御者将在附近的TSP重生，以回到防御捕获点的位置。总体结果是，通过使用上面部分中描述的架构，机器人掌握了“战区”模式的所有游戏玩法方面。

## 29.8 未来工作
发布游戏的过程总是带来新的教训和想法。基于我们在创建《杀戮地带3》中学到的东西，我们正在考虑以下改进：
- 指挥官AI的小队分配组件比《杀戮地带2》更难实现。这可能是因为在《杀戮地带3》中，需要考虑的目标更多，但完成这些目标的机器人更少。因此，我们创建了一个基于智能体的指挥官AI，它使用相同的HTN规划器。我们在基于HTN的指挥官中表达了我们当前的捕获和坚守指挥官和小队分配，并考虑在未来的游戏中使用这种方法。
- 使用上述目标系统或HTN指挥官相对容易表达游戏模式的不同策略。与我们的内部测试人员、游戏设计师的访谈以及观看公开测试中的游戏将导致许多可能的策略。然而，在策略之间做出决定更难。我们使用强化学习来根据机器人与机器人游戏的结果调整指挥官HTN域中的分支顺序和前提条件。

这两个变化在Folkert Huizinga的论文中有更详细的描述[Huizinga 11]。

## 29.9 结论
本文描述了我们用于多人游戏机器人的AI系统。我们展示了架构、算法、规划域的构建方式以及决策中涉及的额外数据（静态和动态）。这种方法以分层的方式划分决策的责任，降低了复杂性，并最大限度地增加了添加有趣的动态行为的机会。

使用分层是我们降低复杂性和最大化重用的一种方式。在一个智能体中，我们经常结合静态地形数据、通用问题求解器和动态游戏状态数据，以实现可预测性和反应性的良好结合。在分层之间，从命令到行为的转换引入了选择和实现目标的角色特定方式。

我们以互补的方式使用各种现有技术。在某些地方，我们自动生成战术数据，而在其他地方，我们依赖于设计师提供的输入。我们使用通用的与域无关的HTN规划器来定义我们的大部分行为，但使用特定的问题求解器进行位置选择、小队路径规划和低级人形技能规划。

我们相信本节展示了一种可以使用各种既定技术来实现综合效果的方式，并且这里描述的架构可以应用于许多AI引擎。
